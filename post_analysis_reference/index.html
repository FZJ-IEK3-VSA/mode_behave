<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Post-Analysis Module - MO|DE.behave Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Post-Analysis Module";
        var mkdocs_page_input_path = "post_analysis_reference.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> MO|DE.behave Documentation
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../core_reference/">Core Module</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../estimation_reference/">Estimation Module</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Post-Analysis Module</a>
    <ul class="current">
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../simulation_reference/">Simulation Module</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">MO|DE.behave Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li>Post-Analysis Module</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <div class="doc doc-object doc-module">


<a id="mode_behave_public.post_analysis"></a>
  <div class="doc doc-contents first">
  
      <p>This module holds the class "PostAnalysis", which incorporates functionality
to analyze the estimated mixed logit model.</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="mode_behave_public.post_analysis.PostAnalysis" class="doc doc-heading">
        <code>PostAnalysis</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>This class incorporates methods to analyze the estimated mixed logit
model as well as methods to visualize the estimation &amp; simulation results.</p>


        <details class="quote">
          <summary>Source code in <code>mode_behave_public\post_analysis.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  19</span>
<span class="normal">  20</span>
<span class="normal">  21</span>
<span class="normal">  22</span>
<span class="normal">  23</span>
<span class="normal">  24</span>
<span class="normal">  25</span>
<span class="normal">  26</span>
<span class="normal">  27</span>
<span class="normal">  28</span>
<span class="normal">  29</span>
<span class="normal">  30</span>
<span class="normal">  31</span>
<span class="normal">  32</span>
<span class="normal">  33</span>
<span class="normal">  34</span>
<span class="normal">  35</span>
<span class="normal">  36</span>
<span class="normal">  37</span>
<span class="normal">  38</span>
<span class="normal">  39</span>
<span class="normal">  40</span>
<span class="normal">  41</span>
<span class="normal">  42</span>
<span class="normal">  43</span>
<span class="normal">  44</span>
<span class="normal">  45</span>
<span class="normal">  46</span>
<span class="normal">  47</span>
<span class="normal">  48</span>
<span class="normal">  49</span>
<span class="normal">  50</span>
<span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">PostAnalysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class incorporates methods to analyze the estimated mixed logit</span>
<span class="sd">    model as well as methods to visualize the estimation &amp; simulation results.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_init_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_AIC_MNL</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method calculates the AIC of an estimated MNL-model.</span>
<span class="sd">        The AIC is a measure to evaluate the quality of the estimated model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AIC : float</span>
<span class="sd">            Akaike information criterion.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglike_MNL</span><span class="p">()</span>

        <span class="n">AIC</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">LL</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">AIC</span>

    <span class="k">def</span> <span class="nf">get_BIC_MNL</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method calculates the BIC of an estimated MNL-model.</span>
<span class="sd">        The BIC is a measure to evaluate the quality of the estimated model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        BIC : float</span>
<span class="sd">            Bayesian information criterion.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglike_MNL</span><span class="p">()</span>

        <span class="n">BIC</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">LL</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">BIC</span>

    <span class="k">def</span> <span class="nf">loglike_MNL</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method calculates the multinomial logit probability for a given</span>
<span class="sd">        set of coefficients and all choices in the sample of the dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        res : float</span>
<span class="sd">            Log-likelihood: Log-Probability of MNL model at a specified point.</span>
<span class="sd">        number_nan : int</span>
<span class="sd">            Number of occured nan-values: Should be zero, otherwise,</span>
<span class="sd">            some numerical issue occures during calculation (e.g., log(0))</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">):</span>
                <span class="n">top</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">choice</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_utility</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="n">bottom</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_utility</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="n">log_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_vector</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">top</span> <span class="o">/</span> <span class="n">bottom</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">log_res</span><span class="p">)</span>
        <span class="n">number_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">log_res</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">number_nan</span>

    <span class="k">def</span> <span class="nf">get_utility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculation of the utility-function for all observations within</span>
<span class="sd">        a given data-sample with respect to the persons choice c.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c : int</span>
<span class="sd">            c is the choice.</span>
<span class="sd">        point : list</span>
<span class="sd">            point specifies the random parameters within the parameter space.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            Returns the utility for each observation.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ASC</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ASC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">[</span><span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">utility</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ASC</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>
                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_constant_random</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">[</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_random</span>
                        <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                        <span class="o">+</span> <span class="n">a</span>
                    <span class="p">]</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">[</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_random</span>
                        <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span>
                        <span class="o">+</span> <span class="n">a</span>
                    <span class="p">]</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>
                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_variable_random</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">utility</span>

    <span class="k">def</span> <span class="nf">loglike_MXL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method calculates the log-likelihood for MXL-models.</span>

<span class="sd">        For reference on log-likelihood calculation see:</span>
<span class="sd">            Ch. 5.5 (pp. 118) in &quot;Discrete Choice Analysis&quot;, by Ben-Akiva (1985)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        points_in : array, optional</span>
<span class="sd">            An array of preference points, if divergent to previously estimated points.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        log-likelihood : float64</span>
<span class="sd">            Returns the log-likelihood (LL) of the estimated mixed logit model.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">points_in</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;points_in&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>

        <span class="c1"># calculates the logit probabilities</span>
        <span class="c1"># for each data point and each choice option</span>
        <span class="n">logit_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_mixed_logit</span><span class="p">(</span>
            <span class="n">points_in</span><span class="o">=</span><span class="n">points_in</span><span class="p">,</span> <span class="n">vector_output_no_weights</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logit_vector_check</span> <span class="o">=</span> <span class="n">logit_vector</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">logit_vector_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">logit_vector</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># calculates the logit probability for the chosen choice option</span>
        <span class="n">logit_vector_choice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">logit_vector_s</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">choice</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="c1"># get the log of each logit probability</span>
        <span class="n">logit_vector_choice_weighted_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_vector</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="n">logit_vector_choice</span>
        <span class="p">)</span>

        <span class="c1"># return the sum of the log-probabilities. Ignore nan-values</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">logit_vector_choice_weighted_log</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_index_of_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method returns the index of a given attribute name for the</span>
<span class="sd">        array &quot;self.initial_point&quot;.</span>
<span class="sd">        This method is a supportive method for visualize_attribute()</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attribute : str</span>
<span class="sd">            Name of the attribute to be visualized.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        index_attribute : int</span>
<span class="sd">            index value of the specified attribute in the array</span>
<span class="sd">            self.initial_point</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">index_attribute</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cf</span><span class="p">,</span> <span class="n">contant_fixed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="n">contant_fixed</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                        <span class="n">index_c</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">cf</span>
                        <span class="n">index_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_c</span><span class="p">)</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">for</span> <span class="n">cr</span><span class="p">,</span> <span class="n">contant_random</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="n">contant_random</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                        <span class="n">index_c</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span> <span class="o">+</span> <span class="n">cr</span>
                        <span class="n">index_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_c</span><span class="p">)</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">for</span> <span class="n">vf</span><span class="p">,</span> <span class="n">variable_fixed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="n">variable_fixed</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                        <span class="n">index_c</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_random</span>
                            <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                            <span class="o">+</span> <span class="n">vf</span>
                        <span class="p">)</span>
                        <span class="n">index_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_c</span><span class="p">)</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">for</span> <span class="n">vr</span><span class="p">,</span> <span class="n">variable_random</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="n">variable_random</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                        <span class="n">index_c</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_random</span>
                            <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span>
                            <span class="o">+</span> <span class="n">vr</span>
                        <span class="p">)</span>
                        <span class="n">index_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_c</span><span class="p">)</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_attribute</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No such attribute&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">index_attribute</span>

    <span class="k">def</span> <span class="nf">visualize_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method visualizes the attribute weights for an exogenously specified</span>
<span class="sd">        attribute and additionally indicates the t-statistics, based on the</span>
<span class="sd">        estimation results of the standard logit model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attribute : str</span>
<span class="sd">            Name of the attribute to be visualized.</span>

<span class="sd">        save_fig_path : string, optional</span>
<span class="sd">            Path, which indicated the place where to store the visualization</span>
<span class="sd">            as a .png-file.</span>

<span class="sd">        names_choice_options : dict, optional</span>
<span class="sd">            If given, this shall be a dictionary, which holds the</span>
<span class="sd">            names of the choice options as values and the numerical</span>
<span class="sd">            indication of the choice option (0,1,2,...) as keys.</span>

<span class="sd">        shift_t_stats : float, optional</span>
<span class="sd">            Shifts the text-fields which indicate the value of the t-statistic</span>
<span class="sd">            in positive or negative direction..</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get keyword arguments</span>
        <span class="n">save_fig_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_fig_path&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">shift_t_stats</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shift_t_stats&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># get index of attribute</span>
        <span class="n">index_attribute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_index_of_attribute</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
        <span class="n">names_choice_options</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;names_choice_options&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">list_param</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">list_t_stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tick_label_temp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">index_attribute</span><span class="p">):</span>
            <span class="n">list_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
            <span class="n">list_t_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_stats</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">names_choice_options</span><span class="p">):</span>
                <span class="n">tick_label_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">names_choice_options</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tick_label_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;choice_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">title_temp</span> <span class="o">=</span> <span class="s2">&quot;Attribute: &quot;</span> <span class="o">+</span> <span class="n">attribute</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_temp</span><span class="p">)</span>
        <span class="n">custom_lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">),</span>
            <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">custom_lines</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;t-statistic &gt;=1.96&quot;</span><span class="p">,</span> <span class="s2">&quot;t-statistic &lt;1.96&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Attribute weight&quot;</span><span class="p">)</span>
        <span class="n">bar_temp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
            <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">),</span>
            <span class="n">list_param</span><span class="p">,</span>
            <span class="n">tick_label</span><span class="o">=</span><span class="n">tick_label_temp</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ylim_temp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">list_t_stats</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1.96</span><span class="p">:</span>
                <span class="n">bar_temp</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">set_linestyle</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
            <span class="n">t_stat_temp</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">list_t_stats</span><span class="p">[</span><span class="n">b</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">textstr</span> <span class="o">=</span> <span class="s2">&quot;t-statistic:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t_stat_temp</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">ylim_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="o">+</span> <span class="n">shift_t_stats</span><span class="p">,</span> <span class="n">textstr</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;t-stats:&quot;</span><span class="p">,</span> <span class="n">list_t_stats</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;param:&quot;</span><span class="p">,</span> <span class="n">list_param</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_fig_path</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="n">save_fig_path</span> <span class="o">+</span> <span class="s2">&quot;attribute_&quot;</span> <span class="o">+</span> <span class="n">attribute</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span>
                <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">visualize_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method visualizes the distribution of preferences across the</span>
<span class="sd">        base population for the randomized model attributes, which have been</span>
<span class="sd">        analyzed within the estimation of the mixed logit model.</span>
<span class="sd">        Furthermore, the estimated (mean) preferences from the multinomial</span>
<span class="sd">        logit model are displayed as reference points.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        return_res : Boolean, optional</span>
<span class="sd">            If True, the clustering results are returned. Defaults to False.</span>
<span class="sd">        return_figure : Boolean, optional</span>
<span class="sd">            If True, the rendered figure is returned. Defaults to False.</span>
<span class="sd">        cluster_method : string, optional</span>
<span class="sd">            Specification of the clustering method, which shall be used to cluster</span>
<span class="sd">            the preferences estimated by the mixed logit model.</span>
<span class="sd">            Defaults to &quot;kmeans&quot;. Other options: &quot;agglo&quot;, &quot;meanshift&quot;, &quot;dbscan&quot;.</span>
<span class="sd">        scale_individual : Boolean, optional</span>
<span class="sd">            If True, the x- and y-axis of the visualizations are scaled to one.</span>
<span class="sd">            This eases the comparison of the different attributes. The scale</span>
<span class="sd">            is indicates on the respective axes and is very important for</span>
<span class="sd">            quantitative and qualitative interpretations. Defaults to False.</span>
<span class="sd">        external_points : array, optional</span>
<span class="sd">            This array holds further parameter points in the parameter space,</span>
<span class="sd">            which should be visualized as reference points. E.g.: The initial</span>
<span class="sd">            point, as being calculated by the multinomial logit model.</span>
<span class="sd">        k : int, optional</span>
<span class="sd">            Number of cluster centers to be calculated. Defaults to 3.</span>
<span class="sd">        save_fig_path : string, optional</span>
<span class="sd">            Path, which indicated the place where to store the visualization</span>
<span class="sd">            as a .png-file.</span>
<span class="sd">        name_scenario : string, optional</span>
<span class="sd">            The scenario name can be added additionally, to distinguish</span>
<span class="sd">            several scenarios.</span>
<span class="sd">        bw_adjust : float, optional</span>
<span class="sd">            This value adjusts the smoothing of the visualized preference</span>
<span class="sd">            distribution. A higher value increases the smoothing of the</span>
<span class="sd">            displayed curve, but may conceal certain findings in the distribution.</span>
<span class="sd">            Defaults to 0.03.</span>
<span class="sd">        names_choice_options : dict, optional</span>
<span class="sd">            If given, this shall be a dictionary, which holds the</span>
<span class="sd">            names of the choice options as values and the numerical</span>
<span class="sd">            indication of the choice option (0,1,2,...) as keys.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        res_clustering : List</span>
<span class="sd">            Clustering results are returned, if keyword return_res == True.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;axes.facecolor&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)})</span>

        <span class="n">return_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return_res&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">return_figure</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return_figure&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">method_temp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cluster_method&quot;</span><span class="p">,</span> <span class="s2">&quot;kmeans&quot;</span><span class="p">)</span>
        <span class="n">names_choice_options</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;names_choice_options&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># PREPARE DATA</span>
        <span class="c1">#   step 0: Get row names (random variables)</span>
        <span class="n">names_constant_fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]</span>
        <span class="n">names_constant_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]</span>
        <span class="n">names_variable_fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]</span>
        <span class="n">names_variable_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]</span>
        <span class="n">number_random</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>
            <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
        <span class="p">)</span>
        <span class="n">number_variable_random</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>

        <span class="c1">#   step 1: Scale parameters</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_points</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shares</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="c1">#   get only points, above share-treshold.</span>
        <span class="n">shares</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">points_t</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">T</span>

        <span class="n">bw_adjust_temp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bw_adjust&quot;</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">)</span>

        <span class="n">scale_individual</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scale_individual&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scale_individual</span><span class="p">:</span>
            <span class="n">scale_log</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_random</span><span class="p">):</span>
                <span class="n">min_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points_t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">max_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points_t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">scale_temp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">min_temp</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_temp</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">scale_temp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">scale_log</span> <span class="o">+=</span> <span class="p">[</span><span class="n">scale_temp</span><span class="p">]</span>
                    <span class="n">points_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">points_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale_temp</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scale_log</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">points_scaled</span> <span class="o">=</span> <span class="n">points_t</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_random</span><span class="p">):</span>
                <span class="n">min_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points_t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">max_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points_t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">scale_temp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">min_temp</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_temp</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">scale_temp</span> <span class="o">&gt;</span> <span class="n">scale</span><span class="p">:</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="n">scale_temp</span>
            <span class="n">points_t</span> <span class="o">=</span> <span class="n">points_t</span> <span class="o">/</span> <span class="n">scale</span>
            <span class="n">points_scaled</span> <span class="o">=</span> <span class="n">points_t</span><span class="o">.</span><span class="n">T</span>

        <span class="c1">#   Import points of socio-economic groups</span>
        <span class="n">external_points</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;external_points&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]))</span>
        <span class="n">k_cluster</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">external_points</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="c1"># get random points.</span>
            <span class="n">external_points_random</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">external_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">number_random</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">external_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names_constant_random</span><span class="p">)):</span>
                    <span class="n">index_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_constant_fixed</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span>
                    <span class="n">external_points_random</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">external_points</span><span class="p">[</span><span class="n">group</span><span class="p">][</span>
                        <span class="n">index_temp</span>
                    <span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names_variable_random</span><span class="p">)):</span>
                        <span class="n">index_temp</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
                            <span class="o">-</span> <span class="mi">1</span>
                            <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_constant_fixed</span><span class="p">)</span>
                            <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_constant_random</span><span class="p">)</span>
                            <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names_variable_fixed</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_variable_random</span><span class="p">))</span>
                            <span class="o">*</span> <span class="n">i</span>
                            <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_variable_fixed</span><span class="p">)</span>
                            <span class="o">+</span> <span class="n">v</span>
                        <span class="p">)</span>
                        <span class="n">external_points_random</span><span class="p">[</span><span class="n">group</span><span class="p">][</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">names_constant_random</span><span class="p">)</span>
                            <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span>
                            <span class="o">+</span> <span class="n">v</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">external_points</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">index_temp</span><span class="p">]</span>

            <span class="c1"># Get cluster centers</span>
            <span class="n">k_group</span> <span class="o">=</span> <span class="n">external_points_random</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">res_clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_space</span><span class="p">(</span><span class="n">method_temp</span><span class="p">,</span> <span class="n">k_cluster</span><span class="p">)</span>

            <span class="c1"># scale these random points.</span>
            <span class="k">if</span> <span class="n">scale_individual</span><span class="p">:</span>
                <span class="n">external_points_random_t</span> <span class="o">=</span> <span class="n">external_points_random</span><span class="o">.</span><span class="n">T</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_random</span><span class="p">):</span>
                    <span class="n">external_points_random_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">external_points_random_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale_log</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="n">external_points_random</span> <span class="o">=</span> <span class="n">external_points_random_t</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">external_points_random</span> <span class="o">=</span> <span class="n">external_points_random</span> <span class="o">/</span> <span class="n">scale</span>

            <span class="c1"># convert points to dict-format</span>
            <span class="n">count_random_variable</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">vlines_loc_group</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">external_points_random_t</span> <span class="o">=</span> <span class="n">external_points_random</span><span class="o">.</span><span class="n">T</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])):</span>
                <span class="n">vlines_loc_group</span><span class="p">[</span><span class="n">names_constant_random</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">external_points_random_t</span><span class="p">[</span>
                    <span class="n">count_random_variable</span>
                <span class="p">]</span>
                <span class="n">count_random_variable</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">names_choice_options</span><span class="p">):</span>
                        <span class="n">name_co</span> <span class="o">=</span> <span class="n">names_choice_options</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">name_co</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

                    <span class="n">vlines_loc_group</span><span class="p">[</span>
                        <span class="n">names_variable_random</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_co</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">external_points_random_t</span><span class="p">[</span><span class="n">count_random_variable</span><span class="p">]</span>
                    <span class="n">count_random_variable</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No external reference points given.&quot;</span><span class="p">)</span>
            <span class="n">vlines_loc_group</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">k_group</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">res_clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_space</span><span class="p">(</span><span class="n">method_temp</span><span class="p">,</span> <span class="n">k_cluster</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method_temp</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;meanshift&quot;</span><span class="p">,</span> <span class="s2">&quot;dbscan&quot;</span><span class="p">):</span>
            <span class="n">k_cluster</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># step 2: Built dataframe</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">points_scaled</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
        <span class="n">attributes_temp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vlines_loc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">vlines_len</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">scale_individual</span><span class="p">:</span>
            <span class="n">text_scale</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">cluster_center</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># scaling of cluster centers</span>
        <span class="k">if</span> <span class="n">scale_individual</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_random</span><span class="p">):</span>
                <span class="n">cluster_center</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_center</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale_log</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cluster_center</span> <span class="o">=</span> <span class="n">cluster_center</span> <span class="o">/</span> <span class="n">scale</span>
        <span class="c1"># weighted calculation of cluster sizes</span>
        <span class="n">cluster_labels_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="s2">&quot;weights&quot;</span><span class="p">])</span>
        <span class="n">cluster_labels_pd</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># assign weights</span>
        <span class="k">if</span> <span class="n">method_temp</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;agglo&quot;</span><span class="p">,</span> <span class="s2">&quot;meanshift&quot;</span><span class="p">):</span>
            <span class="n">index_clustered</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">cluster_labels_pd</span> <span class="o">=</span> <span class="n">cluster_labels_pd</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cluster_labels_pd</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">index_clustered</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cluster_labels_pd</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span>
        <span class="n">cluster_sizes_rel</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">cluster_labels_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cluster_labels_pd</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;weights&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_cluster</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># sort cluster_center and cluster_sizes_rel</span>
        <span class="n">cluster_sizes_rel_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">cluster_sizes_rel</span><span class="p">)</span>
        <span class="n">cluster_sizes_rel_pd</span> <span class="o">=</span> <span class="n">cluster_sizes_rel_pd</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cluster_sizes_rel</span> <span class="o">=</span> <span class="n">cluster_sizes_rel_pd</span><span class="o">.</span><span class="n">values</span>
        <span class="n">cluster_sizes_rel_pd</span> <span class="o">=</span> <span class="n">cluster_sizes_rel_pd</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="c1"># reshuffle cluster_center</span>
        <span class="n">cluster_center</span> <span class="o">=</span> <span class="n">cluster_center</span><span class="o">.</span><span class="n">T</span><span class="p">[</span>
            <span class="n">cluster_sizes_rel_pd</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="p">]</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># create inputs for map of vlines and text_scale</span>
        <span class="n">count_random_variable</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])):</span>
            <span class="k">if</span> <span class="n">scale_individual</span><span class="p">:</span>
                <span class="n">text_scale</span><span class="p">[</span><span class="n">names_constant_random</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">scale_log</span><span class="p">[</span><span class="n">count_random_variable</span><span class="p">]</span>
            <span class="n">vlines_loc</span><span class="p">[</span><span class="n">names_constant_random</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cluster_center</span><span class="p">[</span><span class="n">count_random_variable</span><span class="p">]</span>
            <span class="n">vlines_len</span><span class="p">[</span><span class="n">names_constant_random</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cluster_sizes_rel</span>
            <span class="n">count_random_variable</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">attributes_temp</span> <span class="o">+=</span> <span class="p">[</span><span class="n">names_constant_random</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">shares</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">names_choice_options</span><span class="p">):</span>
                    <span class="n">name_co</span> <span class="o">=</span> <span class="n">names_choice_options</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name_co</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">scale_individual</span><span class="p">:</span>
                    <span class="n">text_scale</span><span class="p">[</span><span class="n">names_variable_random</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_co</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_log</span><span class="p">[</span>
                        <span class="n">count_random_variable</span>
                    <span class="p">]</span>

                <span class="n">vlines_loc</span><span class="p">[</span><span class="n">names_variable_random</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_co</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_center</span><span class="p">[</span>
                    <span class="n">count_random_variable</span>
                <span class="p">]</span>
                <span class="n">vlines_len</span><span class="p">[</span><span class="n">names_variable_random</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_co</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_sizes_rel</span>
                <span class="n">count_random_variable</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">attributes_temp</span> <span class="o">+=</span> <span class="p">[</span><span class="n">names_variable_random</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_co</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">shares</span>
                <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attributes_temp</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
        <span class="n">weights_</span> <span class="o">=</span> <span class="n">shares</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_random</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># for w in range(self.count_c-1):</span>
            <span class="n">weights_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights_</span><span class="p">,</span> <span class="n">shares</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights_</span>

        <span class="c1"># Initialize color palettes</span>
        <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">cubehelix_palette</span><span class="p">(</span>
            <span class="n">n_colors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">2.35</span><span class="p">,</span> <span class="n">rot</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">light</span><span class="o">=</span><span class="mf">0.75</span>
        <span class="p">)</span>
        <span class="n">pal_group</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">cubehelix_palette</span><span class="p">(</span>
            <span class="n">n_colors</span><span class="o">=</span><span class="n">k_group</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rot</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">light</span><span class="o">=</span><span class="mf">0.65</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">pal_cluster_long</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;YlOrBr&quot;</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="n">k_cluster</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">pal_cluster</span> <span class="o">=</span> <span class="n">pal_cluster_long</span><span class="p">[(</span><span class="n">k_cluster</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># create kde-plots.</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">number_random</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">number_random</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">a_count</span><span class="p">,</span> <span class="n">attr_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">names_choice_options</span><span class="p">):</span>
                    <span class="n">name_co</span> <span class="o">=</span> <span class="n">names_choice_options</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name_co</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">x_temp</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">attr_</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_co</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
                    <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
                <span class="p">)</span>
                <span class="n">weights_temp</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">attr_</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_co</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
                    <span class="o">.</span><span class="n">sum</span><span class="p">()[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">vis_col</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">number_variable_random</span> <span class="o">+</span> <span class="n">a_count</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">vis_col</span><span class="p">)</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">x_temp</span><span class="p">,</span>
                    <span class="n">bw_adjust</span><span class="o">=</span><span class="n">bw_adjust_temp</span><span class="p">,</span>
                    <span class="n">cut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">weights</span><span class="o">=</span><span class="n">weights_temp</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">pal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">vis_col</span><span class="p">],</span>
                <span class="p">)</span>

        <span class="c1"># Set the subplots to overlap</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

        <span class="c1"># Remove axes details that don&#39;t play well with overlap</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Distribution of Preferences&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span>
            <span class="n">ax</span><span class="p">,</span>
            <span class="n">xticks</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span>
            <span class="n">xticklabels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Max. Negative Impact&quot;</span><span class="p">,</span> <span class="s2">&quot;No Impact&quot;</span><span class="p">,</span> <span class="s2">&quot;Max. Positive Impact&quot;</span><span class="p">],</span>
            <span class="n">yticks</span><span class="o">=</span><span class="p">[],</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">axis_no</span><span class="p">,</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
            <span class="c1"># set y-labels</span>
            <span class="n">label_modulus</span> <span class="o">=</span> <span class="n">axis_no</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>
            <span class="n">label_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">][</span><span class="n">label_modulus</span><span class="p">]</span>
            <span class="n">count_temp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">axis_no</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">count_temp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">names_choice_options</span><span class="p">):</span>
                <span class="n">col_name</span> <span class="o">=</span> <span class="n">label_temp</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">names_choice_options</span><span class="p">[</span><span class="n">count_temp</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col_name</span> <span class="o">=</span> <span class="n">label_temp</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">count_temp</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">bbox_temp</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">dataLim</span><span class="o">.</span><span class="n">get_points</span><span class="p">()</span>
            <span class="n">y_max_temp</span> <span class="o">=</span> <span class="n">bbox_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_y_max</span> <span class="o">=</span> <span class="n">y_max_temp</span>

            <span class="n">scale_y</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">y_max_temp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=-</span><span class="mf">0.95</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span> <span class="o">*</span> <span class="n">y_max_temp</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="n">col_name</span><span class="p">,</span>
                <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># set vertical lines</span>
            <span class="n">vlines_loc_cluster</span> <span class="o">=</span> <span class="n">vlines_loc</span>
            <span class="n">vlines_loc_group</span> <span class="o">=</span> <span class="n">vlines_loc_group</span>
            <span class="n">k_cluster</span> <span class="o">=</span> <span class="n">k_cluster</span>
            <span class="n">k_group</span> <span class="o">=</span> <span class="n">k_group</span>
            <span class="k">if</span> <span class="n">scale_individual</span><span class="p">:</span>
                <span class="n">scale_temp</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">text_scale</span><span class="p">[</span><span class="n">col_name</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">label_text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;scale x: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">scale_temp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;scale y: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">scale_y</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
                    <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="n">label_text</span><span class="p">,</span>
                    <span class="n">fontstyle</span><span class="o">=</span><span class="s2">&quot;italic&quot;</span><span class="p">,</span>
                    <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_cluster</span><span class="p">):</span>
                <span class="n">x_cluster</span> <span class="o">=</span> <span class="n">vlines_loc_cluster</span><span class="p">[</span><span class="n">col_name</span><span class="p">][</span><span class="n">cluster</span><span class="p">]</span>
                <span class="c1"># len_cluster = vlines_len_cluster[col_name][cluster]</span>
                <span class="n">len_cluster</span> <span class="o">=</span> <span class="mf">0.9</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">x_cluster</span><span class="p">,</span>
                    <span class="n">ymax</span><span class="o">=</span><span class="n">len_cluster</span><span class="p">,</span>
                    <span class="n">c</span><span class="o">=</span><span class="n">pal_cluster</span><span class="p">[</span><span class="n">cluster</span><span class="p">],</span>
                    <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_group</span><span class="p">):</span>
                <span class="n">x_group</span> <span class="o">=</span> <span class="n">vlines_loc_group</span><span class="p">[</span><span class="n">col_name</span><span class="p">][</span><span class="n">group</span><span class="p">]</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">x_group</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">pal_group</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>

            <span class="n">axis</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=-</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=-</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=-</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Create the legend patches for cluster</span>
        <span class="n">patch_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">names_choice_options</span><span class="p">):</span>
            <span class="n">name_co_0</span> <span class="o">=</span> <span class="n">names_choice_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name_co_0</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">col_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_co_0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_cluster</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vlines_len_temp</span> <span class="o">=</span> <span class="n">vlines_len</span>
            <span class="n">cluster_size_temp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">vlines_len</span><span class="p">[</span><span class="n">col_name</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">patch_dict</span><span class="p">[</span>
                <span class="s2">&quot;C&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster_size_temp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;%&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">pal_cluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">patches_c</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">patch_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

        <span class="c1"># create legends</span>
        <span class="n">legend1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="n">handles</span><span class="o">=</span><span class="n">patches_c</span><span class="p">,</span>
            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower center&quot;</span><span class="p">,</span>
            <span class="n">ncol</span><span class="o">=</span><span class="n">k_cluster</span><span class="p">,</span>
            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">),</span>
            <span class="n">columnspacing</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Cluster: Size(%)&quot;</span><span class="p">,</span>
            <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># add legends</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">legend1</span><span class="p">)</span>

        <span class="n">save_fig_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_fig_path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATH_Visualize</span><span class="p">)</span>
        <span class="n">name_scenario</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name_scenario&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name_scenario</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="n">save_fig_path</span> <span class="o">+</span> <span class="s2">&quot;preference_distribution_&quot;</span> <span class="o">+</span> <span class="n">name_scenario</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span>
                <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="n">save_fig_path</span> <span class="o">+</span> <span class="s2">&quot;preference_distribution.png&quot;</span><span class="p">,</span>
                <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">return_res</span> <span class="ow">and</span> <span class="n">return_figure</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res_clustering</span><span class="p">,</span> <span class="n">fig</span>
        <span class="k">elif</span> <span class="n">return_res</span><span class="p">:</span>
            <span class="n">return_res</span>
        <span class="k">elif</span> <span class="n">return_figure</span><span class="p">:</span>
            <span class="n">fig</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">cluster_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method analyses the estimated points and shares within the</span>
<span class="sd">        parameter space and clustes them into latent classes,</span>
<span class="sd">        i.e. consumer groups.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : string</span>
<span class="sd">            Clustering method.</span>
<span class="sd">        k : int</span>
<span class="sd">            Number of clusters.</span>
<span class="sd">        tol : float, optional</span>
<span class="sd">            Tolerance. Defaults to 10e-7.</span>
<span class="sd">        points_affinity : boolean, optional</span>
<span class="sd">            If True, an affinity index is calculated and returned.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        points : array, optional</span>
<span class="sd">            Exogenously defined set of points to be analyzed.</span>
<span class="sd">        shares : array, optional</span>
<span class="sd">            Exogenously defined set of shares to be analyzed.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            Returns a set of cluster results:</span>
<span class="sd">            cluster_centers, labels, inertia, affinity_points</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tol_temp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tol&quot;</span><span class="p">,</span> <span class="mf">10e-7</span><span class="p">)</span>

        <span class="n">points_affinity</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;points_affinity&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">shares</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shares&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;points&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">points</span><span class="o">.</span><span class="n">size</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No such attribute -points- defined.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;kmeans&quot;</span><span class="p">:</span>
            <span class="c1"># create instance of KMeans-algorithm</span>
            <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol_temp</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
            <span class="c1"># Compute cluster centers</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">shares</span><span class="p">)</span>
            <span class="c1"># get inertia and silhouhette score for elbow method</span>
            <span class="n">inertia</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">inertia_</span>
            <span class="c1"># get cluster centers</span>
            <span class="n">cluster_centers</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">cluster_centers_</span>
            <span class="c1"># calculate cluster-distance for each point and attribute</span>
            <span class="n">affinity_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">center_point</span> <span class="o">=</span> <span class="n">cluster_centers</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>
                    <span class="n">points_label</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span>
                    <span class="n">points_label_attribute</span> <span class="o">=</span> <span class="n">points_label</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                    <span class="n">distance_mean</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">points_label_attribute</span> <span class="o">-</span> <span class="n">center_point</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                    <span class="n">affinity_points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance_mean</span>
                    <span class="n">affinity_points</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_point</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">affinity_ind</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">points_affinity</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">cluster_centers</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">inertia</span><span class="p">,</span> <span class="n">affinity_points</span><span class="p">,</span> <span class="n">affinity_ind</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No individual points for aff.-calc. given.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">cluster_centers</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">inertia</span><span class="p">,</span> <span class="n">affinity_points</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;agglo&quot;</span><span class="p">:</span>
            <span class="c1"># delete points below mean.</span>
            <span class="n">shares_temp</span> <span class="o">=</span> <span class="n">shares</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">shares_temp</span> <span class="o">=</span> <span class="n">shares_temp</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span>
                <span class="n">n</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shares_temp</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">),</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;all&quot;</span>
            <span class="p">)</span>
            <span class="n">index_above</span> <span class="o">=</span> <span class="n">shares_temp</span><span class="o">.</span><span class="n">index</span>
            <span class="n">points_temp</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">shares_temp</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
            <span class="c1"># create instance of DBSCAN</span>
            <span class="n">agglo</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="s2">&quot;ward&quot;</span><span class="p">)</span>
            <span class="c1"># Compute cluster centers</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">agglo</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">points_temp</span><span class="p">)</span>
            <span class="c1"># calculate cluster centers</span>
            <span class="n">first_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
            <span class="n">second_dim</span> <span class="o">=</span> <span class="n">points_temp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">cluster_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">first_dim</span><span class="p">,</span> <span class="n">second_dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                <span class="n">points_sub</span> <span class="o">=</span> <span class="n">points_temp</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">l</span><span class="p">]</span>
                <span class="n">cluster_centers</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">points_sub</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># calculate cluster-distance for specific points</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_centers</span> <span class="o">=</span> <span class="n">cluster_centers</span>
            <span class="c1"># calculate cluster-distance for each point and attribute</span>
            <span class="n">affinity_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">center_point</span> <span class="o">=</span> <span class="n">cluster_centers</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>
                    <span class="n">points_label</span> <span class="o">=</span> <span class="n">points_temp</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span>
                    <span class="n">points_label_attribute</span> <span class="o">=</span> <span class="n">points_label</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                    <span class="n">distance_mean</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">points_label_attribute</span> <span class="o">-</span> <span class="n">center_point</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                    <span class="n">affinity_points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance_mean</span>
                    <span class="n">affinity_points</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_point</span>
            <span class="c1"># calculate affinity_ind manually</span>
            <span class="n">affinity_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">points_affinity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">points_affinity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                    <span class="n">affinity_ind</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                        <span class="n">cluster_centers</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">points_affinity</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="n">cluster_centers</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">index_above</span><span class="p">,</span> <span class="n">affinity_points</span><span class="p">,</span> <span class="n">affinity_ind</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;meanshift&quot;</span><span class="p">:</span>
            <span class="c1"># delete points below mean.</span>
            <span class="n">shares_temp</span> <span class="o">=</span> <span class="n">shares</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">shares_temp</span> <span class="o">=</span> <span class="n">shares_temp</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span>
                <span class="n">n</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shares_temp</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;all&quot;</span>
            <span class="p">)</span>
            <span class="n">index_above</span> <span class="o">=</span> <span class="n">shares_temp</span><span class="o">.</span><span class="n">index</span>
            <span class="n">points_temp</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">shares_temp</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
            <span class="c1"># create instance of DBSCAN</span>
            <span class="n">meanshift</span> <span class="o">=</span> <span class="n">MeanShift</span><span class="p">()</span>
            <span class="c1"># Compute cluster centers</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">meanshift</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">points_temp</span><span class="p">)</span>
            <span class="c1"># calculate cluster centers</span>
            <span class="n">cluster_centers</span> <span class="o">=</span> <span class="n">meanshift</span><span class="o">.</span><span class="n">cluster_centers_</span>
            <span class="c1"># calculate cluster-distance for specific points</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_centers</span> <span class="o">=</span> <span class="n">cluster_centers</span>
            <span class="c1"># calculate cluster-distance for each point and attribute</span>
            <span class="n">affinity_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">center_point</span> <span class="o">=</span> <span class="n">cluster_centers</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>
                    <span class="n">points_label</span> <span class="o">=</span> <span class="n">points_temp</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span>
                    <span class="n">points_label_attribute</span> <span class="o">=</span> <span class="n">points_label</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                    <span class="n">distance_mean</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">points_label_attribute</span> <span class="o">-</span> <span class="n">center_point</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                    <span class="n">affinity_points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance_mean</span>
                    <span class="n">affinity_points</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_point</span>
            <span class="c1"># calculate affinity_ind manually</span>
            <span class="n">affinity_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">points_affinity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_centers</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">points_affinity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cluster_centers</span><span class="p">)):</span>
                    <span class="n">affinity_ind</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                        <span class="n">cluster_centers</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">points_affinity</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="n">cluster_centers</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">index_above</span><span class="p">,</span> <span class="n">affinity_points</span><span class="p">,</span> <span class="n">affinity_ind</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;dbscan&quot;</span><span class="p">:</span>
            <span class="c1"># create instance of KMeans-algorithm</span>
            <span class="n">dbscan</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="c1"># Compute cluster centers</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">dbscan</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">shares</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="c1"># calculate cluster centers</span>
            <span class="n">first_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
            <span class="n">second_dim</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">cluster_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">first_dim</span><span class="p">,</span> <span class="n">second_dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                <span class="n">points_sub</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">l</span><span class="p">]</span>
                <span class="n">cluster_centers</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">points_sub</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># calculate cluster-distance for specific points</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_centers</span> <span class="o">=</span> <span class="n">cluster_centers</span>
            <span class="c1"># calculate cluster-distance for each point and attribute</span>
            <span class="n">affinity_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">center_point</span> <span class="o">=</span> <span class="n">cluster_centers</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>
                    <span class="n">points_label</span> <span class="o">=</span> <span class="n">points_temp</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span>
                    <span class="n">points_label_attribute</span> <span class="o">=</span> <span class="n">points_label</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                    <span class="n">distance_mean</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">points_label_attribute</span> <span class="o">-</span> <span class="n">center_point</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                    <span class="n">affinity_points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance_mean</span>
                    <span class="n">affinity_points</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_point</span>
            <span class="c1"># calculate affinity_ind manually</span>
            <span class="n">affinity_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">points_affinity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_centers</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">points_affinity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cluster_centers</span><span class="p">)):</span>
                    <span class="n">affinity_ind</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                        <span class="n">cluster_centers</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">points_affinity</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="n">cluster_centers</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">affinity_points</span><span class="p">,</span> <span class="n">affinity_ind</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No such method defined.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visualize_all_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method visualizes all attribute weights and additionally</span>
<span class="sd">        indicates the t-statistics, based on the</span>
<span class="sd">        estimation results of the standard logit model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        kwargs save_fig_path : string, optional</span>
<span class="sd">            Path, which indicated the place where to store the visualization</span>
<span class="sd">            as a .png-file.</span>
<span class="sd">        kwargs names_choice_options : dict, optional</span>
<span class="sd">            If given, this shall be a dictionary, which holds the</span>
<span class="sd">            names of the choice options as values and the numerical</span>
<span class="sd">            indication of the choice option (0,1,2,...) as keys.</span>
<span class="sd">        kwargs shift_t_stats : float, optional</span>
<span class="sd">            Shifts the text-fields which indicate the value of the t-statistic</span>
<span class="sd">            in positive or negative direction..</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get keyword arguments</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">save_fig_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_fig_path&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">names_choice_options</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;names_choice_options&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">control_left_annotation</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;control_left_annotation&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">control_right_annotation</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;control_right_annotation&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">control_legend</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;control_legend&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">ext_x_limits</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ext_x_limits&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">control_colorbar_label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;control_colorbar_label&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="n">relative</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relative&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">stepwise</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stepwise&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">set_title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;set_title&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">set_xlabel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;set_xlabel&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">map_y_values</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;map_y_values&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">names_choice_options</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">names_choice_options</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Choice option &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="c1"># get data</span>
        <span class="n">y_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]:</span>
            <span class="n">y_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]:</span>
            <span class="n">y_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]:</span>
            <span class="n">y_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]:</span>
            <span class="n">y_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

        <span class="n">x_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)}</span>
        <span class="n">x_values_mean</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)}</span>
        <span class="n">t_stats</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">y_values</span><span class="p">:</span>
            <span class="n">index_attribute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_index_of_attribute</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">list_value_temp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                <span class="n">list_value_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">[</span><span class="n">index_attribute</span><span class="p">[</span><span class="n">c</span><span class="p">]])</span>
            <span class="n">max_list_value_temp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">list_value_temp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">relative</span><span class="p">:</span>
                    <span class="n">data_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                    <span class="n">utility_temp</span> <span class="o">=</span> <span class="n">list_value_temp</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">data_mean</span>
                    <span class="n">x_values</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utility_temp</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">stepwise</span><span class="p">:</span>
                    <span class="c1"># calculate mean value</span>
                    <span class="n">data_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                    <span class="n">utility_temp</span> <span class="o">=</span> <span class="n">list_value_temp</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">data_mean</span>
                    <span class="n">x_values_mean</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utility_temp</span><span class="p">)</span>

                    <span class="c1"># calculate list of utilities</span>
                    <span class="n">unique_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_values</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="n">unique_values</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">val_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">unique_values</span><span class="p">)</span>
                        <span class="n">val_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">unique_values</span><span class="p">)</span>
                        <span class="n">step_temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">val_max</span> <span class="o">-</span> <span class="n">val_min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span>
                        <span class="n">unique_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                            <span class="n">val_min</span><span class="p">,</span> <span class="n">val_max</span> <span class="o">+</span> <span class="n">step_temp</span><span class="p">,</span> <span class="n">step_temp</span>
                        <span class="p">)</span>
                    <span class="n">utilities_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">unique_values</span><span class="p">:</span>
                        <span class="n">utility_temp</span> <span class="o">=</span> <span class="n">list_value_temp</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span>
                        <span class="n">utility_delta</span> <span class="o">=</span> <span class="n">utility_temp</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">utilities_list</span><span class="p">)</span>
                        <span class="n">utilities_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utility_delta</span><span class="p">)</span>
                    <span class="n">left_over</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_values</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">left_over</span><span class="p">):</span>
                        <span class="n">utilities_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">x_values</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utilities_list</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value_temp_scaled</span> <span class="o">=</span> <span class="n">list_value_temp</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="n">max_list_value_temp</span>
                    <span class="n">x_values</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value_temp_scaled</span><span class="p">)</span>
                <span class="n">t_stats_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_stats</span><span class="p">[</span><span class="n">index_attribute</span><span class="p">[</span><span class="n">c</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">t_stats</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_stats_temp</span><span class="p">)</span>

        <span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">cubehelix_palette</span><span class="p">(</span>
            <span class="n">n_colors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rot</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">light</span><span class="o">=</span><span class="mf">0.65</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">stepwise</span><span class="p">:</span>
            <span class="n">palette_stepwise</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span>
                <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;YlGnBu&quot;</span><span class="p">,</span>
                <span class="n">n_colors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># continue with plots</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">set_title</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">set_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">set_xlabel</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">set_xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stepwise</span><span class="p">:</span>
            <span class="n">palette_stepwise_cmap</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span>
                <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;YlGnBu&quot;</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">as_cmap</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="c1"># norm_temp = Normalize(vmin=1, vmax=10)</span>
            <span class="n">norm_temp</span> <span class="o">=</span> <span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">palette_stepwise_cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
            <span class="n">_cbar</span> <span class="o">=</span> <span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm_temp</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">palette_stepwise_cmap</span><span class="p">)</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="s2">&quot;vertical&quot;</span>
            <span class="c1"># ax_cbar = fig.colorbar(_cbar, ax=ax.ravel().tolist(), orientation=cbar, shrink=0.8)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">_cbar</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="n">cbar</span><span class="p">)</span>

            <span class="n">custom_patches</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Line2D</span><span class="p">(</span>
                    <span class="p">[],</span>
                    <span class="p">[],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;Black&quot;</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Average </span><span class="se">\n</span><span class="s2">household&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
                <span class="n">handles</span><span class="o">=</span><span class="n">custom_patches</span><span class="p">,</span>
                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span>
                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">control_legend</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                <span class="n">borderpad</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="n">handlelength</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">control_colorbar_label</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">control_colorbar_label</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;Attribute level&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                <span class="n">rotation</span><span class="o">=-</span><span class="mi">90</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">custom_patches</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">names_choice_options</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
                <span class="n">handles</span><span class="o">=</span><span class="n">custom_patches</span><span class="p">,</span>
                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span>
                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">control_legend</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">width</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>

        <span class="c1"># change order of attributes according to keyword map_y_values_temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_y_values</span> <span class="o">=</span> <span class="n">y_values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_x_values</span> <span class="o">=</span> <span class="n">x_values</span>

        <span class="c1"># create mapping of y-values</span>
        <span class="k">if</span> <span class="n">map_y_values</span><span class="p">:</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="p">[</span><span class="n">y_values</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">map_y_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
            <span class="n">mapping</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_values</span><span class="p">))]</span>

        <span class="c1"># iterate over choice alternatives</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">stepwise</span><span class="p">:</span>
                <span class="n">values_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_values</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                    <span class="c1"># assign values from iteration v-1 to &quot;left_temp&quot;</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">left_temp</span> <span class="o">=</span> <span class="n">values_to_plot</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">left_temp</span> <span class="o">+=</span> <span class="n">values_to_plot</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_values</span><span class="p">)):</span>
                        <span class="n">a_mapped</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                        <span class="n">value_temp</span> <span class="o">=</span> <span class="n">x_values</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a_mapped</span><span class="p">][</span><span class="n">v</span><span class="p">]</span>
                        <span class="n">values_to_plot</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_temp</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_values</span><span class="p">))</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">c</span><span class="p">,</span>
                        <span class="n">values_to_plot</span><span class="p">,</span>
                        <span class="n">width</span><span class="p">,</span>
                        <span class="n">left</span><span class="o">=</span><span class="n">left_temp</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">palette_stepwise</span><span class="p">[</span><span class="n">v</span><span class="p">],</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_values</span><span class="p">))</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">c</span><span class="p">,</span>
                    <span class="n">x_values</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
                    <span class="n">width</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">map_y_values</span> <span class="ow">and</span> <span class="n">stepwise</span><span class="p">:</span>
            <span class="n">y_values_mapped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">map_y_values</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">y_values_mapped</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">yticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_values</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.4</span><span class="p">,</span>
                <span class="n">yticklabels</span><span class="o">=</span><span class="n">y_values_mapped</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">yticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_values</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.4</span><span class="p">,</span>
                <span class="n">yticklabels</span><span class="o">=</span><span class="n">y_values</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">y_values</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;xtick&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;ytick&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ext_x_limits</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">ext_x_limits</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_x_values</span> <span class="o">=</span> <span class="n">x_values</span>

        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y_values</span><span class="p">):</span>
            <span class="n">a_mapped</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>

            <span class="n">width_temp</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
            <span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                <span class="o">-</span><span class="mf">0.4</span> <span class="o">+</span> <span class="n">width_temp</span> <span class="o">*</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mf">0.4</span> <span class="o">+</span> <span class="n">width_temp</span> <span class="o">*</span> <span class="mf">1.8</span><span class="p">,</span> <span class="n">width_temp</span>
            <span class="p">)</span>
            <span class="n">y_range</span> <span class="o">=</span> <span class="n">y_range</span> <span class="o">+</span> <span class="n">a</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">stepwise</span><span class="p">:</span>
                    <span class="n">x_value_temp</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">x_values_mean</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a_mapped</span><span class="p">],</span>
                        <span class="n">ymin</span><span class="o">=</span><span class="n">y_range</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">width_temp</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">ymax</span><span class="o">=</span><span class="n">y_range</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">width_temp</span><span class="p">,</span>
                        <span class="n">linestyles</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                        <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">x_value_temp</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">x_values_mean</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a_mapped</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x_value_temp</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">x_values</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a_mapped</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

                <span class="n">t_stats_precise_temp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t_stats</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a_mapped</span><span class="p">])</span>
                <span class="n">t_stats_temp</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">t_stats_precise_temp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">t_stats_precise_temp</span> <span class="o">&gt;=</span> <span class="mf">2.325</span><span class="p">:</span>
                    <span class="n">value_str</span> <span class="o">=</span> <span class="s2">&quot;***&quot;</span>
                <span class="k">elif</span> <span class="n">t_stats_precise_temp</span> <span class="o">&gt;=</span> <span class="mf">1.96</span><span class="p">:</span>
                    <span class="n">value_str</span> <span class="o">=</span> <span class="s2">&quot;**&quot;</span>
                <span class="k">elif</span> <span class="n">t_stats_precise_temp</span> <span class="o">&gt;=</span> <span class="mf">1.645</span><span class="p">:</span>
                    <span class="n">value_str</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">c_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c_str</span> <span class="o">=</span> <span class="s2">&quot;3+&quot;</span>
                <span class="n">text_temp</span> <span class="o">=</span> <span class="n">c_str</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t_stats_temp</span><span class="p">)</span> <span class="o">+</span> <span class="n">value_str</span>
                <span class="k">if</span> <span class="n">x_value_temp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">control_right_annotation</span><span class="p">,</span> <span class="n">y_range</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">text_temp</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">control_left_annotation</span><span class="p">,</span> <span class="n">y_range</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">text_temp</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># arrow and text for no routine model</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">4.8</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s2">&quot;-11.9&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="o">-</span><span class="mf">4.4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_fig_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">relative</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="n">save_fig_path</span>
                    <span class="o">+</span> <span class="s2">&quot;overview_attributes_relative_&quot;</span>
                    <span class="o">+</span> <span class="n">model_name</span>
                    <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">,</span>
                    <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">stepwise</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="n">save_fig_path</span>
                    <span class="o">+</span> <span class="s2">&quot;overview_attributes_stepwise_&quot;</span>
                    <span class="o">+</span> <span class="n">model_name</span>
                    <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">,</span>
                    <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="n">save_fig_path</span> <span class="o">+</span> <span class="s2">&quot;overview_attributes_&quot;</span> <span class="o">+</span> <span class="n">model_name</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">,</span>
                    <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
                    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;eps&quot;</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">assign_to_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method calculates the probabilities, that a data point in the</span>
<span class="sd">        base data belongs to a cluster. The probabilities are the logit-</span>
<span class="sd">        probabilities of the chosen choice alternatives, calculates with</span>
<span class="sd">        the cluster centers.</span>
<span class="sd">        The probabilities indicate the likelihood that an observation in the</span>
<span class="sd">        base data belongs to a cluster, which is different to the probability</span>
<span class="sd">        that a point in the parameter space belongs to a cluster!</span>
<span class="sd">        Thus, &quot;assign_to_cluster()&quot; yields different cluster-sizes than</span>
<span class="sd">        the analysis of the output of &quot;cluster_space()&quot;, which is also used</span>
<span class="sd">        in here.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : string, optional</span>
<span class="sd">            Indicates the clustering method.</span>
<span class="sd">        k : int, optional</span>
<span class="sd">            Indicates the number of clusters to be calculated with.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cluster_probs : Pandas DataFrame</span>
<span class="sd">            Dataframe, indicating the probabilities, that an observation in the</span>
<span class="sd">            base data is chosen with the points of cluster center k.</span>
<span class="sd">        cluster_centers : Numpy array</span>
<span class="sd">            The points of the cluster centers.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">method</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;kmeans&quot;</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">asc_offset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;asc_offset&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Input: shares, points, cluster-method, #of clusters</span>
        <span class="n">res_clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_space</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

        <span class="c1"># method: calculate the probability, that an observation has points of cluster x.</span>
        <span class="c1"># This probability is the &quot;logit-vector&quot;</span>
        <span class="n">initial_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span>
        <span class="n">no_constant_fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span>
        <span class="n">no_constant_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_random</span>
        <span class="n">no_variable_fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span>
        <span class="n">no_variable_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_random</span>
        <span class="n">count_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
        <span class="n">count_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_e</span>

        <span class="n">dim_aggr_alt_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
        <span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dim_aggr_alt_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="nd">@njit</span>
        <span class="k">def</span> <span class="nf">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculates the utility of a choice option.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            c : int</span>
<span class="sd">                Choice option.</span>
<span class="sd">            point : array</span>
<span class="sd">                Multi-dimensional point in the parameter space.</span>
<span class="sd">            l : array</span>
<span class="sd">                DESCRIPTION.</span>
<span class="sd">            data : array</span>
<span class="sd">                Base data.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            res_temp : float</span>
<span class="sd">                Utility of a choice option.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">res_temp</span> <span class="o">=</span> <span class="n">asc_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_temp</span> <span class="o">=</span> <span class="n">asc_offset</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">initial_point</span><span class="p">[</span><span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_constant_fixed</span><span class="p">):</span>
                <span class="n">res_temp</span> <span class="o">+=</span> <span class="n">initial_point</span><span class="p">[(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_constant_random</span><span class="p">):</span>
                <span class="n">res_temp</span> <span class="o">+=</span> <span class="n">point</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variable_fixed</span><span class="p">):</span>
                <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">initial_point</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">no_constant_fixed</span>
                        <span class="o">+</span> <span class="n">no_constant_random</span>
                        <span class="o">+</span> <span class="p">(</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                        <span class="o">+</span> <span class="n">a</span>
                    <span class="p">]</span>
                    <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variable_random</span><span class="p">):</span>
                <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">point</span><span class="p">[</span><span class="n">no_constant_random</span> <span class="o">+</span> <span class="n">no_variable_random</span> <span class="o">*</span> <span class="n">c</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span>
                    <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">res_temp</span>

        <span class="nd">@guvectorize</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;float64[:, :], float64[:, :, :], float64[:, :, :], float64[:, :, :, :, :], float64[:], float64[:, :, :, :]&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;(m,p),(n,e,l),(n,e,l),(i,j,n,e,l),(n)-&gt;(m,l,n,e)&quot;</span><span class="p">,</span>
            <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="s2">&quot;parallel&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">def</span> <span class="nf">calculate_logit_vector</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">av</span><span class="p">,</span> <span class="n">choice</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">,</span> <span class="n">logit_probs_</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">point</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

                <span class="c1"># iterate over length of data array (len(av))</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">av</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="c1"># calculate bottom</span>
                    <span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_c</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_e</span><span class="p">):</span>
                            <span class="n">bottom</span> <span class="o">+=</span> <span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span>
                                <span class="n">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">)</span>
                            <span class="p">)</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_c</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_e</span><span class="p">):</span>
                            <span class="n">top</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">choice</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">exp</span><span class="p">(</span>
                                    <span class="n">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                            <span class="n">logit_probs_</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">top</span> <span class="o">/</span> <span class="n">bottom</span>

        <span class="n">logit_vector</span> <span class="o">=</span> <span class="n">calculate_logit_vector</span><span class="p">(</span>
            <span class="n">res_clustering</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">choice</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span>
        <span class="p">)</span>

        <span class="n">df_input</span> <span class="o">=</span> <span class="n">logit_vector</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

        <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cluster_prob_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
        <span class="n">cluster_probs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_input</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">column_names</span><span class="p">)</span>
        <span class="n">cluster_centers</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">cluster_probs</span><span class="p">,</span> <span class="n">cluster_centers</span>

    <span class="k">def</span> <span class="nf">simulate_logit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method simulates a multinomial logit model, based on the naming-</span>
<span class="sd">        conventions of the mixed logit model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs sense : dictionary, optional</span>
<span class="sd">            The dictionary &quot;sense&quot; holds the attribute names for which sensitivities</span>
<span class="sd">            shall be simulated as keys. The values are the arrays or lists</span>
<span class="sd">            which indicate the relative change of the attribute value</span>
<span class="sd">            for each choice option.</span>
<span class="sd">        kwargs asc_offset : list, optional</span>
<span class="sd">            offset values for alternative specific constants</span>
<span class="sd">        kwargs av_external : array, optional</span>
<span class="sd">            This array is used to exogenously define the availabilities</span>
<span class="sd">            for each choice option during a simulation.</span>
<span class="sd">            The array must have as much entries as choice options are</span>
<span class="sd">            being observed: len(av_external) = self.count_c</span>
<span class="sd">            Define the availability to 1 (always available), 0 (never available)</span>
<span class="sd">            or np.nan (availability according to base data).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Return the mean value for the simulated latent class model.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">count_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
        <span class="n">count_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_e</span>
        <span class="n">sense</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sense&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">external_point</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;external_point&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">asc_offset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;asc_offset&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">av_external</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;av_external&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># exogeneous definiton of choice availabilities</span>
        <span class="k">if</span> <span class="n">av_external</span><span class="p">:</span>
            <span class="c1"># check for the correct number of exogenously defined availabilities.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">av_external</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">:</span>
                <span class="c1"># interate over availabilities</span>
                <span class="k">for</span> <span class="n">av_ext_count</span><span class="p">,</span> <span class="n">av_ext</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">av_external</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">av_ext</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">av_ext</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">[</span><span class="n">av_ext_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">av_ext</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;External availability must be 0 or 1.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                    <span class="s2">&quot;Number of defined availabilities does not match number of choice options.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_backup</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">no_constant_fixed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">])</span>
        <span class="n">no_constant_random</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>
        <span class="n">no_variable_fixed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">])</span>
        <span class="n">no_variable_random</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">external_point</span><span class="p">):</span>
            <span class="n">initial_point</span> <span class="o">=</span> <span class="n">external_point</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">initial_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span>

        <span class="n">dim_aggr_alt_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
        <span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dim_aggr_alt_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                            <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                            <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                            <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                            <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                            <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                            <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                            <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                            <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">def</span> <span class="nf">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">res_temp</span> <span class="o">=</span> <span class="n">asc_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_temp</span> <span class="o">=</span> <span class="n">asc_offset</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">initial_point</span><span class="p">[</span><span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_constant_fixed</span><span class="p">):</span>
                <span class="n">res_temp</span> <span class="o">+=</span> <span class="n">initial_point</span><span class="p">[(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_constant_random</span><span class="p">):</span>
                <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">initial_point</span><span class="p">[(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">no_constant_fixed</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span>
                    <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variable_fixed</span><span class="p">):</span>
                <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">initial_point</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">no_constant_fixed</span>
                        <span class="o">+</span> <span class="n">no_constant_random</span>
                        <span class="o">+</span> <span class="p">(</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                        <span class="o">+</span> <span class="n">a</span>
                    <span class="p">]</span>
                    <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variable_random</span><span class="p">):</span>
                <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">initial_point</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">no_constant_fixed</span>
                        <span class="o">+</span> <span class="n">no_constant_random</span>
                        <span class="o">+</span> <span class="p">(</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                        <span class="o">+</span> <span class="n">no_variable_fixed</span>
                        <span class="o">+</span> <span class="n">a</span>
                    <span class="p">]</span>
                    <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">res_temp</span>

        <span class="k">def</span> <span class="nf">calculate_logit_shares</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">):</span>

            <span class="n">logit_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">count_c</span><span class="p">,</span> <span class="n">count_e</span><span class="p">))</span>

            <span class="c1"># calculate bottom</span>
            <span class="n">bottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">av</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count_c</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count_e</span><span class="p">):</span>
                    <span class="n">bottom</span> <span class="o">+=</span> <span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                        <span class="n">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count_c</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count_e</span><span class="p">):</span>
                    <span class="n">top</span> <span class="o">=</span> <span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">))</span>
                    <span class="n">logit_probs</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">top</span> <span class="o">/</span> <span class="n">bottom</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_vector</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">logit_probs</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">calculate_logit_shares</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">simulate_mixed_logit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculation of probabilities of mixed logit model for all</span>
<span class="sd">        observations within a given base-sample.</span>
<span class="sd">        Requires prior call of estimate_mixed_logit().</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        latent_points : 2D numpy array, optional</span>
<span class="sd">            The random points within each class.</span>
<span class="sd">        latent_shares : 1D numpy array.</span>
<span class="sd">            The share of each class, optional</span>
<span class="sd">        sense : dictionary, optional</span>
<span class="sd">            The dictionary &quot;sense&quot; holds the attribute names for which sensitivities</span>
<span class="sd">            shall be simulated as keys. The values are the arrays or lists</span>
<span class="sd">            which indicate the relative change of the attribute value</span>
<span class="sd">            for each choice option.</span>
<span class="sd">        av_external : numpy array, optional</span>
<span class="sd">            This array is used to exogenously define the availabilities</span>
<span class="sd">            for each choice option during a simulation.</span>
<span class="sd">            The array must have as much entries as choice options are</span>
<span class="sd">            being observed: len(av_external) = self.count_c</span>
<span class="sd">            Define the availability to 1 (always available), 0 (never available)</span>
<span class="sd">            or np.nan (availability according to base data).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PandasSeries</span>
<span class="sd">            Returns a pandas series with model probabilities for each</span>
<span class="sd">            observation.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mixing_distribution</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mixing_distribution&quot;</span><span class="p">,</span> <span class="s2">&quot;discrete&quot;</span><span class="p">)</span>
        <span class="n">sense</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sense&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">vector_output_no_weights</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vector_output_no_weights&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">asc_offset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;asc_offset&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">av_external</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;av_external&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># exogeneous definiton of choice availabilities</span>
        <span class="k">if</span> <span class="n">av_external</span><span class="p">:</span>
            <span class="c1"># check for the correct number of exogenously defined availabilities.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">av_external</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">:</span>
                <span class="c1"># interate over availabilities</span>
                <span class="k">for</span> <span class="n">av_ext_count</span><span class="p">,</span> <span class="n">av_ext</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">av_external</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">av_ext</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">av_ext</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">[</span><span class="n">av_ext_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">av_ext</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;External availability must be 0 or 1.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                    <span class="s2">&quot;Number of defined availabilities does not match number of choice options.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_backup</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">mixing_distribution</span> <span class="o">==</span> <span class="s2">&quot;discrete&quot;</span><span class="p">:</span>
            <span class="n">initial_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span>
            <span class="n">no_constant_fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span>
            <span class="n">no_constant_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_random</span>
            <span class="n">no_variable_fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span>
            <span class="n">no_variable_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_random</span>
            <span class="n">count_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
            <span class="n">count_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_e</span>

            <span class="n">dim_aggr_alt_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]),</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]),</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
            <span class="p">)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dim_aggr_alt_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                                <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                                <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">values</span>

                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                                <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                                <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">values</span>

                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                                <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                                <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">values</span>

                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                                <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                                <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="nd">@njit</span>
            <span class="k">def</span> <span class="nf">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Calculates the utility of a choice option.</span>

<span class="sd">                Parameters</span>
<span class="sd">                ----------</span>
<span class="sd">                c : int</span>
<span class="sd">                    Choice option.</span>
<span class="sd">                point : array</span>
<span class="sd">                    Multi-dimensional point in the parameter space.</span>
<span class="sd">                l : array</span>
<span class="sd">                    DESCRIPTION.</span>
<span class="sd">                data : array</span>
<span class="sd">                    Base data.</span>

<span class="sd">                Returns</span>
<span class="sd">                -------</span>
<span class="sd">                res_temp : float</span>
<span class="sd">                    Utility of a choice option.</span>

<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">res_temp</span> <span class="o">=</span> <span class="n">asc_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res_temp</span> <span class="o">=</span> <span class="n">asc_offset</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">initial_point</span><span class="p">[</span><span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_constant_fixed</span><span class="p">):</span>
                    <span class="n">res_temp</span> <span class="o">+=</span> <span class="n">initial_point</span><span class="p">[(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_constant_random</span><span class="p">):</span>
                    <span class="n">res_temp</span> <span class="o">+=</span> <span class="n">point</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variable_fixed</span><span class="p">):</span>
                    <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="n">initial_point</span><span class="p">[</span>
                            <span class="p">(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">+</span> <span class="n">no_constant_fixed</span>
                            <span class="o">+</span> <span class="n">no_constant_random</span>
                            <span class="o">+</span> <span class="p">(</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                            <span class="o">+</span> <span class="n">a</span>
                        <span class="p">]</span>
                        <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variable_random</span><span class="p">):</span>
                    <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="n">point</span><span class="p">[</span><span class="n">no_constant_random</span> <span class="o">+</span> <span class="n">no_variable_random</span> <span class="o">*</span> <span class="n">c</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span>
                        <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
                    <span class="p">)</span>

                <span class="k">return</span> <span class="n">res_temp</span>

            <span class="nd">@guvectorize</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;float64[:, :], float64[:, :, :], float64[:, :, :, :, :], float64[:], float64[:, :, :, :]&quot;</span>
                <span class="p">],</span>
                <span class="s2">&quot;(m,p),(n,e,l),(i,j,n,e,l),(n)-&gt;(m,l,n,e)&quot;</span><span class="p">,</span>
                <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="s2">&quot;parallel&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">def</span> <span class="nf">calculate_logit_vector</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">av</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">,</span> <span class="n">logit_probs_</span><span class="p">):</span>

                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">point</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

                    <span class="c1"># iterate over length of data array (len(av))</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">av</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="c1"># calculate bottom</span>
                        <span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_c</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_e</span><span class="p">):</span>
                                <span class="n">bottom</span> <span class="o">+=</span> <span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span>
                                    <span class="n">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">)</span>
                                <span class="p">)</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_c</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_e</span><span class="p">):</span>
                                <span class="n">top</span> <span class="o">=</span> <span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span>
                                    <span class="n">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">)</span>
                                <span class="p">)</span>
                                <span class="n">logit_probs_</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">top</span> <span class="o">/</span> <span class="n">bottom</span>

            <span class="n">logit_probs_matrix</span> <span class="o">=</span> <span class="n">calculate_logit_vector</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span>
            <span class="p">)</span>
            <span class="c1"># multiply logit probs per point with share of the point</span>
            <span class="n">logit_probs_matrix_shares</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span> <span class="o">*</span> <span class="n">logit_probs_matrix</span><span class="o">.</span><span class="n">T</span>
            <span class="c1"># sum along all considered points of the parameter space</span>
            <span class="n">logit_probs_summed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">logit_probs_matrix_shares</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c_logit_probs_summed</span> <span class="o">=</span> <span class="n">logit_probs_summed</span>

            <span class="k">if</span> <span class="n">vector_output_no_weights</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">logit_probs_summed</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># get mean of all probabilities</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logit_probs_summed</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_vector</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not yet implemented.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">simulate_latent_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latent_points</span><span class="p">,</span> <span class="n">latent_shares</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method simulates a latent class model, based on the naming-</span>
<span class="sd">        conventions of the mixed logit model. The different latent classes</span>
<span class="sd">        refer to the different random points, being stored in the input</span>
<span class="sd">        parameter -latent_points-. The parameter -latent_shares- refers</span>
<span class="sd">        to the share of each latent class. The number of latent classes</span>
<span class="sd">        is usually a low integer value (3-10), while the number of classes</span>
<span class="sd">        within the mixed logit model usually amounts to &gt;1000.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        latent_points : 2D numpy array, optional</span>
<span class="sd">            The random points within each class.</span>
<span class="sd">        latent_shares : 1D numpy array, optional</span>
<span class="sd">            The share of each class.</span>
<span class="sd">        sense : dict, optional</span>
<span class="sd">            The dictionary &quot;sense&quot; holds the attribute names for which sensitivities</span>
<span class="sd">            shall be simulated as keys. The values are the arrays or lists</span>
<span class="sd">            which indicate the relative change of the attribute value</span>
<span class="sd">            for each choice option.</span>
<span class="sd">        av_external : numpy array, optional</span>
<span class="sd">            This array is used to exogenously define the availabilities</span>
<span class="sd">            for each choice option during a simulation.</span>
<span class="sd">            The array must have as much entries as choice options are</span>
<span class="sd">            being observed: len(av_external) = self.count_c</span>
<span class="sd">            Define the availability to 1 (always available), 0 (never available)</span>
<span class="sd">            or np.nan (availability according to base data).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Return the mean value for the simulated latent class model.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">count_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
        <span class="n">count_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_e</span>
        <span class="n">sense</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sense&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">asc_offset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;asc_offset&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">av_external</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;av_external&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># exogeneous definiton of choice availabilities</span>
        <span class="k">if</span> <span class="n">av_external</span><span class="p">:</span>
            <span class="c1"># check for the correct number of exogenously defined availabilities.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">av_external</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">:</span>
                <span class="c1"># interate over availabilities</span>
                <span class="k">for</span> <span class="n">av_ext_count</span><span class="p">,</span> <span class="n">av_ext</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">av_external</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">av_ext</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">av_ext</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">[</span><span class="n">av_ext_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">av_ext</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;External availability must be 0 or 1.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                    <span class="s2">&quot;Number of defined availabilities does not match number of choice options.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_backup</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">no_constant_fixed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">])</span>
        <span class="n">no_constant_random</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>
        <span class="n">no_variable_fixed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">])</span>
        <span class="n">no_variable_random</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>

        <span class="c1"># check compatabiilty of latent_points and no_variable</span>
        <span class="n">no_random</span> <span class="o">=</span> <span class="n">no_constant_random</span> <span class="o">+</span> <span class="n">no_variable_random</span> <span class="o">*</span> <span class="n">count_c</span>
        <span class="k">if</span> <span class="n">no_random</span> <span class="o">!=</span> <span class="n">latent_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Defined parameter set -param- does not match number of random variables.&quot;</span>
            <span class="p">)</span>

        <span class="n">initial_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span>

        <span class="n">dim_aggr_alt_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
        <span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dim_aggr_alt_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                            <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                            <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                            <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                            <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                            <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                            <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                            <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                            <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="nd">@njit</span>
        <span class="k">def</span> <span class="nf">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">res_temp</span> <span class="o">=</span> <span class="n">asc_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_temp</span> <span class="o">=</span> <span class="n">asc_offset</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">initial_point</span><span class="p">[</span><span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_constant_fixed</span><span class="p">):</span>
                <span class="n">res_temp</span> <span class="o">+=</span> <span class="n">initial_point</span><span class="p">[(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_constant_random</span><span class="p">):</span>
                <span class="n">res_temp</span> <span class="o">+=</span> <span class="n">point</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variable_fixed</span><span class="p">):</span>
                <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">initial_point</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">no_constant_fixed</span>
                        <span class="o">+</span> <span class="n">no_constant_random</span>
                        <span class="o">+</span> <span class="p">(</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                        <span class="o">+</span> <span class="n">a</span>
                    <span class="p">]</span>
                    <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variable_random</span><span class="p">):</span>
                <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">point</span><span class="p">[</span><span class="n">no_constant_random</span> <span class="o">+</span> <span class="n">no_variable_random</span> <span class="o">*</span> <span class="n">c</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span>
                    <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">res_temp</span>

        <span class="nd">@guvectorize</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;float64[:, :], float64[:, :, :], float64[:], float64[:, :, :, :, :], float64[:], float64[:, :, :, :]&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;(m,p),(n,e,l),(l),(i,j,n,e,l),(n)-&gt;(m,l,n,e)&quot;</span><span class="p">,</span>
            <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="s2">&quot;parallel&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">def</span> <span class="nf">calculate_logit_vector</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">av</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">,</span> <span class="n">logit_probs_</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">point</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

                <span class="c1"># iterate over length of data array (len(av))</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">av</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="c1"># calculate bottom</span>
                    <span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_c</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_e</span><span class="p">):</span>
                            <span class="n">bottom</span> <span class="o">+=</span> <span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span>
                                <span class="n">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">)</span>
                            <span class="p">)</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_c</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_e</span><span class="p">):</span>
                            <span class="n">top</span> <span class="o">=</span> <span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span>
                                <span class="n">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">)</span>
                            <span class="p">)</span>
                            <span class="n">logit_probs_</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">top</span> <span class="o">/</span> <span class="n">bottom</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>

        <span class="n">logit_probs</span> <span class="o">=</span> <span class="n">calculate_logit_vector</span><span class="p">(</span>
            <span class="n">latent_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_vector</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_logit_probs</span> <span class="o">=</span> <span class="n">logit_probs</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">logit_probs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">latent_class</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">logit_probs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="n">logit_probs</span><span class="p">[</span><span class="n">latent_class</span><span class="p">]</span> <span class="o">*</span> <span class="n">latent_shares</span><span class="p">[</span><span class="n">latent_class</span><span class="p">]</span>

        <span class="c1"># sum over equal alternatives</span>
        <span class="n">res_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">res_sum</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method creates a barplot of the mean values of different latent</span>
<span class="sd">        class and MNL models. The MNL models are based upon clustering results</span>
<span class="sd">        of random parameters from a previous simulation. Consequently, two</span>
<span class="sd">        latent class models are simulated. One is based upon the</span>
<span class="sd">        estimated clusters with their corresponding, weighted cluster-sizes.</span>
<span class="sd">        The other latent class model utilizes the same clustered values,</span>
<span class="sd">        but assigns cluster-sizes, which are externally defined by</span>
<span class="sd">        an user input during the method-call.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : str</span>
<span class="sd">            Method indicates the model type, which to use for forecasting.</span>
<span class="sd">            Options are: &quot;MNL&quot; (Multinomial Logit), &quot;MXL&quot; (Mixed Logit),</span>
<span class="sd">            &quot;LC&quot; (Latent Class). Defaults to &quot;MNL&quot;.</span>
<span class="sd">        sense_scenarios : dict, optional</span>
<span class="sd">            The dictionary &quot;sense_scenarios&quot; is two dimensional.</span>
<span class="sd">            The first dimension indicated the scenario name, while the</span>
<span class="sd">            second dimension holds the scenario parameters according</span>
<span class="sd">            to the definition of &quot;sense&quot;. &quot;sense&quot; itself is a dictionary.</span>
<span class="sd">            The dictionary &quot;sense&quot; holds the attribute names for which sensitivities</span>
<span class="sd">            shall be simulated as keys. The values are the arrays or lists</span>
<span class="sd">            which indicate the relative change of the attribute value</span>
<span class="sd">            for each choice option.</span>
<span class="sd">        av_external : numpy array, optional</span>
<span class="sd">            This array is used to exogenously define the availabilities</span>
<span class="sd">            for each choice option during a simulation.</span>
<span class="sd">            The array must have as much entries as choice options are</span>
<span class="sd">            being observed: len(av_external) = self.count_c</span>
<span class="sd">            Define the availability to 1 (always available), 0 (never available)</span>
<span class="sd">            or np.nan (availability according to base data).</span>
<span class="sd">        external_points : numpy array, optional</span>
<span class="sd">            This array is two-dimensional and holds one or more alternative</span>
<span class="sd">            specifications of &quot;initial_point&quot; for the simulation of</span>
<span class="sd">            multinomial logit.</span>
<span class="sd">        k : int, optional</span>
<span class="sd">            Number is cluster centers to be considered, when method = &quot;LC&quot;</span>
<span class="sd">        cluster_method : str, optional</span>
<span class="sd">            The clustering method. Defaults to &quot;kmeans.&quot;</span>
<span class="sd">        save_fig_path : str, optional</span>
<span class="sd">            If given, the visualizations are stored in this directory.</span>
<span class="sd">        names_choice_options : dict, optional</span>
<span class="sd">            If given, this shall be a dictionary, which holds the</span>
<span class="sd">            names of the choice options as values and the numerical</span>
<span class="sd">            indication of the choice option (0,1,2,...) as keys.</span>
<span class="sd">        y_lim : tuple, optional</span>
<span class="sd">            If given, this tuple indicates the limits for the y-axis</span>
<span class="sd">            within the visualization.</span>
<span class="sd">        y_lim : tuple, optional</span>
<span class="sd">            If given, forecasted probabilities are returned. Defaults to False.</span>
<span class="sd">        return_data : Boolean, optional</span>
<span class="sd">            If True, the simulated data is returned. Defaults to False.</span>
<span class="sd">        return_figure : Boolean, optional</span>
<span class="sd">            If True, the visualized figure is returned. Defaults to False</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Is being raised, if an unknown method is indicated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># PREPARE DATA</span>
        <span class="c1">#   Get row names (random variables)</span>
        <span class="n">names_constant_fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]</span>
        <span class="n">names_constant_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]</span>
        <span class="n">names_variable_fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]</span>
        <span class="n">names_variable_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]</span>
        <span class="n">number_random</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>
            <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
        <span class="p">)</span>

        <span class="n">save_fig_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_fig_path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATH_Visualize</span><span class="p">)</span>
        <span class="n">name_scenario</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name_scenario&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">external_points</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;external_points&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]))</span>
        <span class="n">sense_scenarios</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sense_scenarios&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">names_choice_options</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;names_choice_options&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">asc_offset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;asc_offset&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)])</span>
        <span class="p">)</span>
        <span class="n">av_external</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;av_external&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">y_lim</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_lim&quot;</span><span class="p">,</span> <span class="p">())</span>
        <span class="n">return_data</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return_data&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">return_figure</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return_figure&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Dictionary to store simulation results</span>
        <span class="n">res_simu</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;MNL&quot;</span><span class="p">:</span>
            <span class="n">res_simu</span><span class="p">[</span><span class="s2">&quot;MNL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_logit</span><span class="p">(</span>
                <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span> <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">sense_scenarios</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sense_name</span> <span class="ow">in</span> <span class="n">sense_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">res_simu</span><span class="p">[</span><span class="n">sense_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_logit</span><span class="p">(</span>
                        <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                        <span class="n">sense</span><span class="o">=</span><span class="n">sense_scenarios</span><span class="p">[</span><span class="n">sense_name</span><span class="p">],</span>
                        <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">external_points</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="c1"># iterate over external points.</span>
                <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">external_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">res_simu</span><span class="p">[</span><span class="s2">&quot;External &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ep</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_logit</span><span class="p">(</span>
                        <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                        <span class="n">external_point</span><span class="o">=</span><span class="n">external_points</span><span class="p">[</span><span class="n">ep</span><span class="p">],</span>
                        <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">sense_scenarios</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">sense_name</span> <span class="ow">in</span> <span class="n">sense_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">res_simu</span><span class="p">[</span>
                                <span class="s2">&quot;External &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">sense_name</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_logit</span><span class="p">(</span>
                                <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                                <span class="n">external_point</span><span class="o">=</span><span class="n">external_points</span><span class="p">[</span><span class="n">ep</span><span class="p">],</span>
                                <span class="n">sense</span><span class="o">=</span><span class="n">sense_scenarios</span><span class="p">[</span><span class="n">sense_name</span><span class="p">],</span>
                                <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;LC&quot;</span><span class="p">:</span>
            <span class="c1">#   keyword arguments</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">method_temp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cluster_method&quot;</span><span class="p">,</span> <span class="s2">&quot;kmeans&quot;</span><span class="p">)</span>

            <span class="c1">#   step 1: Check parameters</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>

            <span class="c1">#   get only points, above share-treshold.</span>
            <span class="n">shares</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span>
            <span class="n">points_scaled</span> <span class="o">=</span> <span class="n">points</span>

            <span class="c1">#   Import points of socio-economic groups</span>
            <span class="k">if</span> <span class="n">external_points</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>

                <span class="c1"># get random points.</span>
                <span class="n">external_points_random</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">external_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">number_random</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">external_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names_constant_random</span><span class="p">)):</span>
                        <span class="n">index_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_constant_fixed</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span>
                        <span class="n">external_points_random</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">external_points</span><span class="p">[</span><span class="n">group</span><span class="p">][</span>
                            <span class="n">index_temp</span>
                        <span class="p">]</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names_variable_random</span><span class="p">)):</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                            <span class="n">index_temp</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
                                <span class="o">-</span> <span class="mi">1</span>
                                <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_constant_fixed</span><span class="p">)</span>
                                <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_constant_random</span><span class="p">)</span>
                                <span class="o">+</span> <span class="p">(</span>
                                    <span class="nb">len</span><span class="p">(</span><span class="n">names_variable_fixed</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_variable_random</span><span class="p">)</span>
                                <span class="p">)</span>
                                <span class="o">*</span> <span class="n">i</span>
                                <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_variable_fixed</span><span class="p">)</span>
                                <span class="o">+</span> <span class="n">v</span>
                            <span class="p">)</span>
                            <span class="n">external_points_random</span><span class="p">[</span><span class="n">group</span><span class="p">][</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">names_constant_random</span><span class="p">)</span>
                                <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span>
                                <span class="o">+</span> <span class="n">v</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="n">external_points</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">index_temp</span><span class="p">]</span>

                <span class="n">ext_points</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No external reference points given.&quot;</span><span class="p">)</span>
                <span class="n">ext_points</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Get cluster centers</span>
            <span class="k">if</span> <span class="n">ext_points</span><span class="p">:</span>
                <span class="n">res_clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_space</span><span class="p">(</span>
                    <span class="n">method_temp</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">points_affinity</span><span class="o">=</span><span class="n">external_points_random</span>
                <span class="p">)</span>
                <span class="n">affinity_all</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">affinity_percent_all</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">affinity_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">affinity</span> <span class="o">=</span> <span class="n">affinity_all</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                    <span class="n">a_solve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">affinity</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">affinity</span><span class="p">)))</span>
                    <span class="n">a_solve</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">affinity</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">affinity</span><span class="p">)):</span>
                        <span class="n">ratio_temp</span> <span class="o">=</span> <span class="n">affinity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">affinity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">a_solve</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">a_solve</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">ratio_temp</span>
                    <span class="n">b_solve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">affinity</span><span class="p">))</span>
                    <span class="n">b_solve</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">affinity_solve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">a_solve</span><span class="p">,</span> <span class="n">b_solve</span><span class="p">)</span>
                    <span class="n">affinity_percent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">affinity_solve</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a_solve</span><span class="p">,</span> <span class="n">affinity_solve</span><span class="p">),</span> <span class="n">b_solve</span><span class="p">):</span>
                        <span class="n">affinity_percent_all</span> <span class="o">=</span> <span class="n">affinity_percent_all</span> <span class="o">+</span> <span class="p">[</span><span class="n">affinity_percent</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Affinity-calculation failed.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_space</span><span class="p">(</span>
                    <span class="n">method_temp</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="n">points_scaled</span><span class="p">,</span> <span class="n">shares</span><span class="o">=</span><span class="n">shares</span>
                <span class="p">)</span>
            <span class="n">cluster_center</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">cluster_labels_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="s2">&quot;weights&quot;</span><span class="p">])</span>
            <span class="n">cluster_labels_pd</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># assign weights</span>
            <span class="k">if</span> <span class="n">method_temp</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;agglo&quot;</span><span class="p">,</span> <span class="s2">&quot;meanshift&quot;</span><span class="p">):</span>
                <span class="n">index_clustered</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">cluster_labels_pd</span> <span class="o">=</span> <span class="n">cluster_labels_pd</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">cluster_labels_pd</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span><span class="p">[</span><span class="n">index_clustered</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cluster_labels_pd</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span>

            <span class="k">if</span> <span class="n">method_temp</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;meanshift&quot;</span><span class="p">,</span> <span class="s2">&quot;dbscan&quot;</span><span class="p">):</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">cluster_sizes_rel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">cluster_labels_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">cluster_labels_pd</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;weights&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># sort cluster_center and cluster_sizes_rel</span>
            <span class="n">cluster_sizes_rel_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">cluster_sizes_rel</span><span class="p">)</span>
            <span class="n">cluster_sizes_rel_pd</span> <span class="o">=</span> <span class="n">cluster_sizes_rel_pd</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">cluster_sizes_rel</span> <span class="o">=</span> <span class="n">cluster_sizes_rel_pd</span><span class="o">.</span><span class="n">values</span>
            <span class="n">cluster_sizes_rel_pd</span> <span class="o">=</span> <span class="n">cluster_sizes_rel_pd</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="c1"># reshuffle cluster_center</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_cluster_reorder</span> <span class="o">=</span> <span class="n">cluster_sizes_rel_pd</span>
            <span class="n">cluster_center</span> <span class="o">=</span> <span class="n">cluster_center</span><span class="p">[</span>
                <span class="n">cluster_sizes_rel_pd</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="p">]</span>

            <span class="n">cluster_sizes_rel_percent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">cluster_sizes_rel</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>

            <span class="c1"># SIMULATION OF LATENT CLASSES AND EXTERNAL POINTS</span>

            <span class="c1"># MNL simulation for individual clusters.</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="n">res_simu</span><span class="p">[</span>
                    <span class="s2">&quot;C&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster_sizes_rel_percent</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;%)&quot;</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_latent_class</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cluster_center</span><span class="p">[</span><span class="n">k</span><span class="p">]]),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                    <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">sense_scenarios</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sense_name</span> <span class="ow">in</span> <span class="n">sense_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">res_simu</span><span class="p">[</span>
                            <span class="s2">&quot;C&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">sense_name</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_latent_class</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cluster_center</span><span class="p">[</span><span class="n">k</span><span class="p">]]),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span>
                            <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                            <span class="n">sense</span><span class="o">=</span><span class="n">sense_scenarios</span><span class="p">[</span><span class="n">sense_name</span><span class="p">],</span>
                            <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                        <span class="p">)</span>

            <span class="c1"># Simulation of externally given points.</span>
            <span class="k">if</span> <span class="n">ext_points</span><span class="p">:</span>
                <span class="n">k_group</span> <span class="o">=</span> <span class="n">external_points_random</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_group</span><span class="p">):</span>
                    <span class="n">res_simu</span><span class="p">[</span><span class="s2">&quot;External &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">g</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_latent_class</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">external_points_random</span><span class="p">[</span><span class="n">g</span><span class="p">]]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                        <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">sense_scenarios</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">sense_name</span> <span class="ow">in</span> <span class="n">sense_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">res_simu</span><span class="p">[</span>
                                <span class="s2">&quot;External &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">sense_name</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_latent_class</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">external_points_random</span><span class="p">[</span><span class="n">g</span><span class="p">]]),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span>
                                <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                                <span class="n">sense</span><span class="o">=</span><span class="n">sense_scenarios</span><span class="p">[</span><span class="n">sense_name</span><span class="p">],</span>
                                <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                            <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">k_group</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Simulation of latent class model, based on cluster analysis.</span>
            <span class="n">res_simu</span><span class="p">[</span><span class="s2">&quot;Latent Class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_latent_class</span><span class="p">(</span>
                <span class="n">cluster_center</span><span class="p">,</span>
                <span class="n">cluster_sizes_rel</span><span class="p">,</span>
                <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">sense_scenarios</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sense_name</span> <span class="ow">in</span> <span class="n">sense_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">res_simu</span><span class="p">[</span>
                        <span class="s2">&quot;Latent Class&quot;</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">sense_name</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_latent_class</span><span class="p">(</span>
                        <span class="n">cluster_center</span><span class="p">,</span>
                        <span class="n">cluster_sizes_rel</span><span class="p">,</span>
                        <span class="n">sense</span><span class="o">=</span><span class="n">sense_scenarios</span><span class="p">[</span><span class="n">sense_name</span><span class="p">],</span>
                        <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                        <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="n">cluster_sizes_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="n">cluster_sizes_str</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="s2">&quot;C&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster_sizes_rel_percent</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;%</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;MXL&quot;</span><span class="p">:</span>
            <span class="n">res_simu</span><span class="p">[</span><span class="s2">&quot;MXL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_mixed_logit</span><span class="p">(</span>
                <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span> <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">sense_scenarios</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sense_name</span> <span class="ow">in</span> <span class="n">sense_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">res_simu</span><span class="p">[</span><span class="n">sense_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_mixed_logit</span><span class="p">(</span>
                        <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                        <span class="n">sense</span><span class="o">=</span><span class="n">sense_scenarios</span><span class="p">[</span><span class="n">sense_name</span><span class="p">],</span>
                        <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">external_points</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="c1"># iterate over external points.</span>
                <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">external_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">res_simu</span><span class="p">[</span><span class="s2">&quot;External &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ep</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_logit</span><span class="p">(</span>
                        <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                        <span class="n">external_point</span><span class="o">=</span><span class="n">external_points</span><span class="p">[</span><span class="n">ep</span><span class="p">],</span>
                        <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">sense_scenarios</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">sense_name</span> <span class="ow">in</span> <span class="n">sense_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">res_simu</span><span class="p">[</span>
                                <span class="s2">&quot;External &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">sense_name</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_logit</span><span class="p">(</span>
                                <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                                <span class="n">external_point</span><span class="o">=</span><span class="n">external_points</span><span class="p">[</span><span class="n">ep</span><span class="p">],</span>
                                <span class="n">sense</span><span class="o">=</span><span class="n">sense_scenarios</span><span class="p">[</span><span class="n">sense_name</span><span class="p">],</span>
                                <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Chosen method is not available.&quot;</span><span class="p">)</span>

        <span class="c1">### GENERAL CODE FOR VISUALIZATION STARTS BELOW ###</span>

        <span class="c1"># Observations in base data</span>
        <span class="n">res_simu</span><span class="p">[</span><span class="s2">&quot;Base Data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;choice_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span>
                        <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_vector</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Barplot</span>
        <span class="n">res_simu_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_simu</span><span class="p">)</span>
        <span class="n">simu_names</span> <span class="o">=</span> <span class="n">res_simu_pd</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
        <span class="n">res_simu_pd</span><span class="p">[</span><span class="s2">&quot;Choice Option&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_simu_pd</span><span class="o">.</span><span class="n">index</span>

        <span class="n">res_simu_pd_long</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
            <span class="n">res_simu_pd</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="s2">&quot;Choice Option&quot;</span><span class="p">,</span> <span class="n">value_vars</span><span class="o">=</span><span class="n">simu_names</span>
        <span class="p">)</span>
        <span class="n">res_simu_pd_long</span> <span class="o">=</span> <span class="n">res_simu_pd_long</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;Choice probability&quot;</span><span class="p">,</span> <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="s2">&quot;Scenario&quot;</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">n_colors_temp</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res_simu</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">custom_palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">cubehelix_palette</span><span class="p">(</span>
            <span class="n">n_colors</span><span class="o">=</span><span class="n">n_colors_temp</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">rot</span><span class="o">=-</span><span class="mf">0.5</span>
        <span class="p">)</span>
        <span class="n">custom_palette</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">res_simu</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>  <span class="c1"># add grey for the last bar</span>

        <span class="c1"># Specify name of choice options</span>
        <span class="k">for</span> <span class="n">choice_option</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">names_choice_options</span><span class="p">):</span>
            <span class="n">name_temp</span> <span class="o">=</span> <span class="n">names_choice_options</span><span class="p">[</span><span class="n">choice_option</span><span class="p">]</span>
            <span class="n">res_simu_pd_long</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">res_simu_pd_long</span><span class="p">[</span><span class="s2">&quot;Choice Option&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">choice_option</span><span class="p">,</span> <span class="s2">&quot;Choice Option&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">name_temp</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">1.7</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Choice Option&quot;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Choice probability&quot;</span><span class="p">,</span>
            <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;Scenario&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">res_simu_pd_long</span><span class="p">,</span>
            <span class="n">palette</span><span class="o">=</span><span class="n">custom_palette</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">y_lim</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="n">y_lim</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.45</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">name_scenario</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="n">save_fig_path</span> <span class="o">+</span> <span class="s2">&quot;forecast_&quot;</span> <span class="o">+</span> <span class="n">name_scenario</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span>
                <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_fig_path</span> <span class="o">+</span> <span class="s2">&quot;forecast.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_data</span> <span class="ow">and</span> <span class="n">return_figure</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res_simu_pd_long</span><span class="p">,</span> <span class="n">fig</span>
        <span class="k">elif</span> <span class="n">return_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res_simu_pd_long</span>
        <span class="k">elif</span> <span class="n">return_figure</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fig</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">export_estimates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method returns the estimates of the logit or the mixed logit model</span>
<span class="sd">        in .csv-format.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_type : str, optional</span>
<span class="sd">            Type of discrete choice model, &quot;MNL&quot;, &quot;LC&quot;, or &quot;MXL&quot;</span>
<span class="sd">        path_save : str, optional</span>
<span class="sd">            Path, where to store the exported estimates.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">model_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_type&quot;</span><span class="p">,</span> <span class="s2">&quot;MNL&quot;</span><span class="p">)</span>
        <span class="n">PATH_SAVE</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path_save&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">t_stats_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">t_stats</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_stats</span><span class="p">))]</span>
        <span class="n">t_stats_list_abs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_stats</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_stats</span><span class="p">))]</span>

        <span class="n">param_name_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">param_name_short_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">choice_alternative_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">param_index_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">param_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ASC_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                <span class="n">param_name_short_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ASC&quot;</span><span class="p">)</span>
                <span class="n">choice_alternative_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">param_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">len_con_fix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">])</span>
        <span class="n">len_con_ran</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>
        <span class="n">len_var_fix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">])</span>
        <span class="n">len_var_ran</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                <span class="n">param_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                <span class="n">param_name_short_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="n">choice_alternative_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">param_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">a</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                <span class="n">param_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                <span class="n">param_name_short_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="n">choice_alternative_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">param_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">len_con_fix</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                <span class="n">param_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                <span class="n">param_name_short_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="n">choice_alternative_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">param_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">len_con_fix</span> <span class="o">+</span> <span class="n">len_con_ran</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                <span class="n">param_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                <span class="n">param_name_short_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="n">choice_alternative_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">param_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">len_con_fix</span> <span class="o">+</span> <span class="n">len_con_ran</span> <span class="o">+</span> <span class="n">len_var_fix</span><span class="p">)</span>

        <span class="n">t_stats_pandas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">)),</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;Param_Name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Param_Value&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Param_Index&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Choice_Alternative&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t_stats&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t_stats_abs&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">t_stats_pandas</span><span class="p">[</span><span class="s2">&quot;Param_Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_name_list</span>
        <span class="n">t_stats_pandas</span><span class="p">[</span><span class="s2">&quot;Param_Name_Short&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_name_short_list</span>
        <span class="n">t_stats_pandas</span><span class="p">[</span><span class="s2">&quot;Param_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span>
        <span class="n">t_stats_pandas</span><span class="p">[</span><span class="s2">&quot;t_stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_stats_list</span>
        <span class="n">t_stats_pandas</span><span class="p">[</span><span class="s2">&quot;t_stats_abs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_stats_list_abs</span>
        <span class="n">t_stats_pandas</span><span class="p">[</span><span class="s2">&quot;Param_Index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_index_list</span>
        <span class="n">t_stats_pandas</span><span class="p">[</span><span class="s2">&quot;Choice_Alternative&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">choice_alternative_list</span>

        <span class="k">if</span> <span class="n">PATH_SAVE</span><span class="p">:</span>
            <span class="n">t_stats_pandas</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">PATH_SAVE</span> <span class="o">+</span> <span class="s2">&quot;MNL_estimates.csv&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;MNL&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">t_stats_pandas</span><span class="o">.</span><span class="n">to_csv</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;MXL&quot;</span><span class="p">:</span>
            <span class="n">param_name_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;share&quot;</span><span class="p">)</span>

            <span class="n">shares_pandas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shares</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="n">param_name_list</span>
            <span class="p">)</span>

            <span class="c1"># add shares to dataframe</span>
            <span class="n">shares_pandas</span><span class="p">[</span><span class="s2">&quot;share&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># add initial point to each row</span>
            <span class="n">shares_pandas</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">points_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>

            <span class="c1"># subtitute initial point values by values from points.</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                    <span class="c1"># same random value for each choice alternative (-constant- parameter)</span>
                    <span class="n">shares_pandas</span><span class="p">[</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">points_array</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                    <span class="n">shares_pandas</span><span class="p">[</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">points_array</span><span class="o">.</span><span class="n">T</span><span class="p">[</span>
                        <span class="n">len_con_ran</span> <span class="o">+</span> <span class="n">len_var_ran</span> <span class="o">*</span> <span class="n">c</span> <span class="o">+</span> <span class="n">a</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">PATH_SAVE</span><span class="p">:</span>
                <span class="n">t_stats_pandas</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">PATH_SAVE</span> <span class="o">+</span> <span class="s2">&quot;MNL_estimates.csv&quot;</span><span class="p">)</span>
                <span class="n">shares_pandas</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">PATH_SAVE</span> <span class="o">+</span> <span class="s2">&quot;MXL_estimates.csv&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">t_stats_pandas</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(),</span> <span class="n">shares_pandas</span><span class="o">.</span><span class="n">to_csv</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="mode_behave_public.post_analysis.PostAnalysis.assign_to_cluster" class="doc doc-heading">
<code class="highlight language-python"><span class="n">assign_to_cluster</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This method calculates the probabilities, that a data point in the
base data belongs to a cluster. The probabilities are the logit-
probabilities of the chosen choice alternatives, calculates with
the cluster centers.
The probabilities indicate the likelihood that an observation in the
base data belongs to a cluster, which is different to the probability
that a point in the parameter space belongs to a cluster!
Thus, "assign_to_cluster()" yields different cluster-sizes than
the analysis of the output of "cluster_space()", which is also used
in here.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b>method</b>
                  (<code>string</code>)
              –
              <div class="doc-md-description">
                <p>Indicates the clustering method.</p>
              </div>
            </li>
            <li>
              <b>k</b>
                  (<code>int</code>)
              –
              <div class="doc-md-description">
                <p>Indicates the number of clusters to be calculated with.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
<b>cluster_probs</b>(                <code>Pandas DataFrame</code>
)            –
            <div class="doc-md-description">
              <p>Dataframe, indicating the probabilities, that an observation in the
base data is chosen with the points of cluster center k.</p>
            </div>
          </li>
          <li>
<b>cluster_centers</b>(                <code>Numpy array</code>
)            –
            <div class="doc-md-description">
              <p>The points of the cluster centers.</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
      <details class="quote">
        <summary>Source code in <code>mode_behave_public\post_analysis.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">assign_to_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method calculates the probabilities, that a data point in the</span>
<span class="sd">    base data belongs to a cluster. The probabilities are the logit-</span>
<span class="sd">    probabilities of the chosen choice alternatives, calculates with</span>
<span class="sd">    the cluster centers.</span>
<span class="sd">    The probabilities indicate the likelihood that an observation in the</span>
<span class="sd">    base data belongs to a cluster, which is different to the probability</span>
<span class="sd">    that a point in the parameter space belongs to a cluster!</span>
<span class="sd">    Thus, &quot;assign_to_cluster()&quot; yields different cluster-sizes than</span>
<span class="sd">    the analysis of the output of &quot;cluster_space()&quot;, which is also used</span>
<span class="sd">    in here.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    method : string, optional</span>
<span class="sd">        Indicates the clustering method.</span>
<span class="sd">    k : int, optional</span>
<span class="sd">        Indicates the number of clusters to be calculated with.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cluster_probs : Pandas DataFrame</span>
<span class="sd">        Dataframe, indicating the probabilities, that an observation in the</span>
<span class="sd">        base data is chosen with the points of cluster center k.</span>
<span class="sd">    cluster_centers : Numpy array</span>
<span class="sd">        The points of the cluster centers.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">method</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;kmeans&quot;</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">asc_offset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;asc_offset&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Input: shares, points, cluster-method, #of clusters</span>
    <span class="n">res_clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_space</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

    <span class="c1"># method: calculate the probability, that an observation has points of cluster x.</span>
    <span class="c1"># This probability is the &quot;logit-vector&quot;</span>
    <span class="n">initial_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span>
    <span class="n">no_constant_fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span>
    <span class="n">no_constant_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_random</span>
    <span class="n">no_variable_fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span>
    <span class="n">no_variable_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_random</span>
    <span class="n">count_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
    <span class="n">count_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_e</span>

    <span class="n">dim_aggr_alt_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]),</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]),</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
    <span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
        <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dim_aggr_alt_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                    <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                    <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                    <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                    <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="nd">@njit</span>
    <span class="k">def</span> <span class="nf">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the utility of a choice option.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c : int</span>
<span class="sd">            Choice option.</span>
<span class="sd">        point : array</span>
<span class="sd">            Multi-dimensional point in the parameter space.</span>
<span class="sd">        l : array</span>
<span class="sd">            DESCRIPTION.</span>
<span class="sd">        data : array</span>
<span class="sd">            Base data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        res_temp : float</span>
<span class="sd">            Utility of a choice option.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">res_temp</span> <span class="o">=</span> <span class="n">asc_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res_temp</span> <span class="o">=</span> <span class="n">asc_offset</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">initial_point</span><span class="p">[</span><span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_constant_fixed</span><span class="p">):</span>
            <span class="n">res_temp</span> <span class="o">+=</span> <span class="n">initial_point</span><span class="p">[(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_constant_random</span><span class="p">):</span>
            <span class="n">res_temp</span> <span class="o">+=</span> <span class="n">point</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variable_fixed</span><span class="p">):</span>
            <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">initial_point</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">no_constant_fixed</span>
                    <span class="o">+</span> <span class="n">no_constant_random</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                    <span class="o">+</span> <span class="n">a</span>
                <span class="p">]</span>
                <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variable_random</span><span class="p">):</span>
            <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">point</span><span class="p">[</span><span class="n">no_constant_random</span> <span class="o">+</span> <span class="n">no_variable_random</span> <span class="o">*</span> <span class="n">c</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">res_temp</span>

    <span class="nd">@guvectorize</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s2">&quot;float64[:, :], float64[:, :, :], float64[:, :, :], float64[:, :, :, :, :], float64[:], float64[:, :, :, :]&quot;</span>
        <span class="p">],</span>
        <span class="s2">&quot;(m,p),(n,e,l),(n,e,l),(i,j,n,e,l),(n)-&gt;(m,l,n,e)&quot;</span><span class="p">,</span>
        <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="s2">&quot;parallel&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">calculate_logit_vector</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">av</span><span class="p">,</span> <span class="n">choice</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">,</span> <span class="n">logit_probs_</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

            <span class="c1"># iterate over length of data array (len(av))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">av</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="c1"># calculate bottom</span>
                <span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_c</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_e</span><span class="p">):</span>
                        <span class="n">bottom</span> <span class="o">+=</span> <span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span>
                            <span class="n">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_c</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_e</span><span class="p">):</span>
                        <span class="n">top</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
                            <span class="o">*</span> <span class="n">choice</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
                            <span class="o">*</span> <span class="n">exp</span><span class="p">(</span>
                                <span class="n">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">logit_probs_</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">top</span> <span class="o">/</span> <span class="n">bottom</span>

    <span class="n">logit_vector</span> <span class="o">=</span> <span class="n">calculate_logit_vector</span><span class="p">(</span>
        <span class="n">res_clustering</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">choice</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span>
    <span class="p">)</span>

    <span class="n">df_input</span> <span class="o">=</span> <span class="n">logit_vector</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

    <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cluster_prob_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="n">cluster_probs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_input</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">column_names</span><span class="p">)</span>
    <span class="n">cluster_centers</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">cluster_probs</span><span class="p">,</span> <span class="n">cluster_centers</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="mode_behave_public.post_analysis.PostAnalysis.cluster_space" class="doc doc-heading">
<code class="highlight language-python"><span class="n">cluster_space</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This method analyses the estimated points and shares within the
parameter space and clustes them into latent classes,
i.e. consumer groups.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b>method</b>
                  (<code>string</code>)
              –
              <div class="doc-md-description">
                <p>Clustering method.</p>
              </div>
            </li>
            <li>
              <b>k</b>
                  (<code>int</code>)
              –
              <div class="doc-md-description">
                <p>Number of clusters.</p>
              </div>
            </li>
            <li>
              <b>tol</b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Tolerance. Defaults to 10e-7.</p>
              </div>
            </li>
            <li>
              <b>points_affinity</b>
                  (<code>boolean</code>)
              –
              <div class="doc-md-description">
                <p>If True, an affinity index is calculated and returned.
Defaults to False.</p>
              </div>
            </li>
            <li>
              <b>points</b>
                  (<code>array</code>)
              –
              <div class="doc-md-description">
                <p>Exogenously defined set of points to be analyzed.</p>
              </div>
            </li>
            <li>
              <b>shares</b>
                  (<code>array</code>)
              –
              <div class="doc-md-description">
                <p>Exogenously defined set of shares to be analyzed.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
                <code>list</code>
            –
            <div class="doc-md-description">
              <p>Returns a set of cluster results:
cluster_centers, labels, inertia, affinity_points</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
      <details class="quote">
        <summary>Source code in <code>mode_behave_public\post_analysis.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">cluster_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method analyses the estimated points and shares within the</span>
<span class="sd">    parameter space and clustes them into latent classes,</span>
<span class="sd">    i.e. consumer groups.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    method : string</span>
<span class="sd">        Clustering method.</span>
<span class="sd">    k : int</span>
<span class="sd">        Number of clusters.</span>
<span class="sd">    tol : float, optional</span>
<span class="sd">        Tolerance. Defaults to 10e-7.</span>
<span class="sd">    points_affinity : boolean, optional</span>
<span class="sd">        If True, an affinity index is calculated and returned.</span>
<span class="sd">        Defaults to False.</span>
<span class="sd">    points : array, optional</span>
<span class="sd">        Exogenously defined set of points to be analyzed.</span>
<span class="sd">    shares : array, optional</span>
<span class="sd">        Exogenously defined set of shares to be analyzed.</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Returns a set of cluster results:</span>
<span class="sd">        cluster_centers, labels, inertia, affinity_points</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tol_temp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tol&quot;</span><span class="p">,</span> <span class="mf">10e-7</span><span class="p">)</span>

    <span class="n">points_affinity</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;points_affinity&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">shares</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shares&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;points&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">points</span><span class="o">.</span><span class="n">size</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No such attribute -points- defined.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;kmeans&quot;</span><span class="p">:</span>
        <span class="c1"># create instance of KMeans-algorithm</span>
        <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol_temp</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="c1"># Compute cluster centers</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">shares</span><span class="p">)</span>
        <span class="c1"># get inertia and silhouhette score for elbow method</span>
        <span class="n">inertia</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">inertia_</span>
        <span class="c1"># get cluster centers</span>
        <span class="n">cluster_centers</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">cluster_centers_</span>
        <span class="c1"># calculate cluster-distance for each point and attribute</span>
        <span class="n">affinity_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">center_point</span> <span class="o">=</span> <span class="n">cluster_centers</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>
                <span class="n">points_label</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span>
                <span class="n">points_label_attribute</span> <span class="o">=</span> <span class="n">points_label</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                <span class="n">distance_mean</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">points_label_attribute</span> <span class="o">-</span> <span class="n">center_point</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">affinity_points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance_mean</span>
                <span class="n">affinity_points</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_point</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">affinity_ind</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">points_affinity</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cluster_centers</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">inertia</span><span class="p">,</span> <span class="n">affinity_points</span><span class="p">,</span> <span class="n">affinity_ind</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No individual points for aff.-calc. given.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cluster_centers</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">inertia</span><span class="p">,</span> <span class="n">affinity_points</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;agglo&quot;</span><span class="p">:</span>
        <span class="c1"># delete points below mean.</span>
        <span class="n">shares_temp</span> <span class="o">=</span> <span class="n">shares</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">shares_temp</span> <span class="o">=</span> <span class="n">shares_temp</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span>
            <span class="n">n</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shares_temp</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">),</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;all&quot;</span>
        <span class="p">)</span>
        <span class="n">index_above</span> <span class="o">=</span> <span class="n">shares_temp</span><span class="o">.</span><span class="n">index</span>
        <span class="n">points_temp</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">shares_temp</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="c1"># create instance of DBSCAN</span>
        <span class="n">agglo</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="s2">&quot;ward&quot;</span><span class="p">)</span>
        <span class="c1"># Compute cluster centers</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">agglo</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">points_temp</span><span class="p">)</span>
        <span class="c1"># calculate cluster centers</span>
        <span class="n">first_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
        <span class="n">second_dim</span> <span class="o">=</span> <span class="n">points_temp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cluster_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">first_dim</span><span class="p">,</span> <span class="n">second_dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="n">points_sub</span> <span class="o">=</span> <span class="n">points_temp</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">l</span><span class="p">]</span>
            <span class="n">cluster_centers</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">points_sub</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># calculate cluster-distance for specific points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_centers</span> <span class="o">=</span> <span class="n">cluster_centers</span>
        <span class="c1"># calculate cluster-distance for each point and attribute</span>
        <span class="n">affinity_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">center_point</span> <span class="o">=</span> <span class="n">cluster_centers</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>
                <span class="n">points_label</span> <span class="o">=</span> <span class="n">points_temp</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span>
                <span class="n">points_label_attribute</span> <span class="o">=</span> <span class="n">points_label</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                <span class="n">distance_mean</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">points_label_attribute</span> <span class="o">-</span> <span class="n">center_point</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">affinity_points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance_mean</span>
                <span class="n">affinity_points</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_point</span>
        <span class="c1"># calculate affinity_ind manually</span>
        <span class="n">affinity_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">points_affinity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">points_affinity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="n">affinity_ind</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                    <span class="n">cluster_centers</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">points_affinity</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">cluster_centers</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">index_above</span><span class="p">,</span> <span class="n">affinity_points</span><span class="p">,</span> <span class="n">affinity_ind</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;meanshift&quot;</span><span class="p">:</span>
        <span class="c1"># delete points below mean.</span>
        <span class="n">shares_temp</span> <span class="o">=</span> <span class="n">shares</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">shares_temp</span> <span class="o">=</span> <span class="n">shares_temp</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span>
            <span class="n">n</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shares_temp</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;all&quot;</span>
        <span class="p">)</span>
        <span class="n">index_above</span> <span class="o">=</span> <span class="n">shares_temp</span><span class="o">.</span><span class="n">index</span>
        <span class="n">points_temp</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">shares_temp</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="c1"># create instance of DBSCAN</span>
        <span class="n">meanshift</span> <span class="o">=</span> <span class="n">MeanShift</span><span class="p">()</span>
        <span class="c1"># Compute cluster centers</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">meanshift</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">points_temp</span><span class="p">)</span>
        <span class="c1"># calculate cluster centers</span>
        <span class="n">cluster_centers</span> <span class="o">=</span> <span class="n">meanshift</span><span class="o">.</span><span class="n">cluster_centers_</span>
        <span class="c1"># calculate cluster-distance for specific points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_centers</span> <span class="o">=</span> <span class="n">cluster_centers</span>
        <span class="c1"># calculate cluster-distance for each point and attribute</span>
        <span class="n">affinity_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">center_point</span> <span class="o">=</span> <span class="n">cluster_centers</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>
                <span class="n">points_label</span> <span class="o">=</span> <span class="n">points_temp</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span>
                <span class="n">points_label_attribute</span> <span class="o">=</span> <span class="n">points_label</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                <span class="n">distance_mean</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">points_label_attribute</span> <span class="o">-</span> <span class="n">center_point</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">affinity_points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance_mean</span>
                <span class="n">affinity_points</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_point</span>
        <span class="c1"># calculate affinity_ind manually</span>
        <span class="n">affinity_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">points_affinity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_centers</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">points_affinity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cluster_centers</span><span class="p">)):</span>
                <span class="n">affinity_ind</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                    <span class="n">cluster_centers</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">points_affinity</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">cluster_centers</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">index_above</span><span class="p">,</span> <span class="n">affinity_points</span><span class="p">,</span> <span class="n">affinity_ind</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;dbscan&quot;</span><span class="p">:</span>
        <span class="c1"># create instance of KMeans-algorithm</span>
        <span class="n">dbscan</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="c1"># Compute cluster centers</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">dbscan</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">shares</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="c1"># calculate cluster centers</span>
        <span class="n">first_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
        <span class="n">second_dim</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cluster_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">first_dim</span><span class="p">,</span> <span class="n">second_dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="n">points_sub</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">l</span><span class="p">]</span>
            <span class="n">cluster_centers</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">points_sub</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># calculate cluster-distance for specific points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_centers</span> <span class="o">=</span> <span class="n">cluster_centers</span>
        <span class="c1"># calculate cluster-distance for each point and attribute</span>
        <span class="n">affinity_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">center_point</span> <span class="o">=</span> <span class="n">cluster_centers</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>
                <span class="n">points_label</span> <span class="o">=</span> <span class="n">points_temp</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span>
                <span class="n">points_label_attribute</span> <span class="o">=</span> <span class="n">points_label</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                <span class="n">distance_mean</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">points_label_attribute</span> <span class="o">-</span> <span class="n">center_point</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">affinity_points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance_mean</span>
                <span class="n">affinity_points</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_point</span>
        <span class="c1"># calculate affinity_ind manually</span>
        <span class="n">affinity_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">points_affinity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_centers</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">points_affinity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cluster_centers</span><span class="p">)):</span>
                <span class="n">affinity_ind</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                    <span class="n">cluster_centers</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">points_affinity</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">cluster_centers</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">affinity_points</span><span class="p">,</span> <span class="n">affinity_ind</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No such method defined.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="mode_behave_public.post_analysis.PostAnalysis.export_estimates" class="doc doc-heading">
<code class="highlight language-python"><span class="n">export_estimates</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This method returns the estimates of the logit or the mixed logit model
in .csv-format.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b>model_type</b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>Type of discrete choice model, "MNL", "LC", or "MXL"</p>
              </div>
            </li>
            <li>
              <b>path_save</b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>Path, where to store the exported estimates.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
      <details class="quote">
        <summary>Source code in <code>mode_behave_public\post_analysis.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">export_estimates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method returns the estimates of the logit or the mixed logit model</span>
<span class="sd">    in .csv-format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_type : str, optional</span>
<span class="sd">        Type of discrete choice model, &quot;MNL&quot;, &quot;LC&quot;, or &quot;MXL&quot;</span>
<span class="sd">    path_save : str, optional</span>
<span class="sd">        Path, where to store the exported estimates.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_type&quot;</span><span class="p">,</span> <span class="s2">&quot;MNL&quot;</span><span class="p">)</span>
    <span class="n">PATH_SAVE</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path_save&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">t_stats_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">t_stats</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_stats</span><span class="p">))]</span>
    <span class="n">t_stats_list_abs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_stats</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_stats</span><span class="p">))]</span>

    <span class="n">param_name_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">param_name_short_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">choice_alternative_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">param_index_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">param_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ASC_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="n">param_name_short_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ASC&quot;</span><span class="p">)</span>
            <span class="n">choice_alternative_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">param_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">len_con_fix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">])</span>
    <span class="n">len_con_ran</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>
    <span class="n">len_var_fix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">])</span>
    <span class="n">len_var_ran</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
            <span class="n">param_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="n">param_name_short_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">choice_alternative_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">param_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">a</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
            <span class="n">param_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="n">param_name_short_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">choice_alternative_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">param_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">len_con_fix</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
            <span class="n">param_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="n">param_name_short_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">choice_alternative_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">param_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">len_con_fix</span> <span class="o">+</span> <span class="n">len_con_ran</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
            <span class="n">param_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="n">param_name_short_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">choice_alternative_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">param_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">len_con_fix</span> <span class="o">+</span> <span class="n">len_con_ran</span> <span class="o">+</span> <span class="n">len_var_fix</span><span class="p">)</span>

    <span class="n">t_stats_pandas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">)),</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;Param_Name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Param_Value&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Param_Index&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Choice_Alternative&quot;</span><span class="p">,</span>
            <span class="s2">&quot;t_stats&quot;</span><span class="p">,</span>
            <span class="s2">&quot;t_stats_abs&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">)</span>

    <span class="n">t_stats_pandas</span><span class="p">[</span><span class="s2">&quot;Param_Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_name_list</span>
    <span class="n">t_stats_pandas</span><span class="p">[</span><span class="s2">&quot;Param_Name_Short&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_name_short_list</span>
    <span class="n">t_stats_pandas</span><span class="p">[</span><span class="s2">&quot;Param_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span>
    <span class="n">t_stats_pandas</span><span class="p">[</span><span class="s2">&quot;t_stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_stats_list</span>
    <span class="n">t_stats_pandas</span><span class="p">[</span><span class="s2">&quot;t_stats_abs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_stats_list_abs</span>
    <span class="n">t_stats_pandas</span><span class="p">[</span><span class="s2">&quot;Param_Index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_index_list</span>
    <span class="n">t_stats_pandas</span><span class="p">[</span><span class="s2">&quot;Choice_Alternative&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">choice_alternative_list</span>

    <span class="k">if</span> <span class="n">PATH_SAVE</span><span class="p">:</span>
        <span class="n">t_stats_pandas</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">PATH_SAVE</span> <span class="o">+</span> <span class="s2">&quot;MNL_estimates.csv&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;MNL&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">t_stats_pandas</span><span class="o">.</span><span class="n">to_csv</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;MXL&quot;</span><span class="p">:</span>
        <span class="n">param_name_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;share&quot;</span><span class="p">)</span>

        <span class="n">shares_pandas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shares</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="n">param_name_list</span>
        <span class="p">)</span>

        <span class="c1"># add shares to dataframe</span>
        <span class="n">shares_pandas</span><span class="p">[</span><span class="s2">&quot;share&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># add initial point to each row</span>
        <span class="n">shares_pandas</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">points_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>

        <span class="c1"># subtitute initial point values by values from points.</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                <span class="c1"># same random value for each choice alternative (-constant- parameter)</span>
                <span class="n">shares_pandas</span><span class="p">[</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">points_array</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                <span class="n">shares_pandas</span><span class="p">[</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">points_array</span><span class="o">.</span><span class="n">T</span><span class="p">[</span>
                    <span class="n">len_con_ran</span> <span class="o">+</span> <span class="n">len_var_ran</span> <span class="o">*</span> <span class="n">c</span> <span class="o">+</span> <span class="n">a</span>
                <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">PATH_SAVE</span><span class="p">:</span>
            <span class="n">t_stats_pandas</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">PATH_SAVE</span> <span class="o">+</span> <span class="s2">&quot;MNL_estimates.csv&quot;</span><span class="p">)</span>
            <span class="n">shares_pandas</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">PATH_SAVE</span> <span class="o">+</span> <span class="s2">&quot;MXL_estimates.csv&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">t_stats_pandas</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(),</span> <span class="n">shares_pandas</span><span class="o">.</span><span class="n">to_csv</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="mode_behave_public.post_analysis.PostAnalysis.forecast" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forecast</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This method creates a barplot of the mean values of different latent
class and MNL models. The MNL models are based upon clustering results
of random parameters from a previous simulation. Consequently, two
latent class models are simulated. One is based upon the
estimated clusters with their corresponding, weighted cluster-sizes.
The other latent class model utilizes the same clustered values,
but assigns cluster-sizes, which are externally defined by
an user input during the method-call.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b>method</b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>Method indicates the model type, which to use for forecasting.
Options are: "MNL" (Multinomial Logit), "MXL" (Mixed Logit),
"LC" (Latent Class). Defaults to "MNL".</p>
              </div>
            </li>
            <li>
              <b>sense_scenarios</b>
                  (<code>dict</code>)
              –
              <div class="doc-md-description">
                <p>The dictionary "sense_scenarios" is two dimensional.
The first dimension indicated the scenario name, while the
second dimension holds the scenario parameters according
to the definition of "sense". "sense" itself is a dictionary.
The dictionary "sense" holds the attribute names for which sensitivities
shall be simulated as keys. The values are the arrays or lists
which indicate the relative change of the attribute value
for each choice option.</p>
              </div>
            </li>
            <li>
              <b>av_external</b>
                  (<code>numpy array</code>)
              –
              <div class="doc-md-description">
                <p>This array is used to exogenously define the availabilities
for each choice option during a simulation.
The array must have as much entries as choice options are
being observed: len(av_external) = self.count_c
Define the availability to 1 (always available), 0 (never available)
or np.nan (availability according to base data).</p>
              </div>
            </li>
            <li>
              <b>external_points</b>
                  (<code>numpy array</code>)
              –
              <div class="doc-md-description">
                <p>This array is two-dimensional and holds one or more alternative
specifications of "initial_point" for the simulation of
multinomial logit.</p>
              </div>
            </li>
            <li>
              <b>k</b>
                  (<code>int</code>)
              –
              <div class="doc-md-description">
                <p>Number is cluster centers to be considered, when method = "LC"</p>
              </div>
            </li>
            <li>
              <b>cluster_method</b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>The clustering method. Defaults to "kmeans."</p>
              </div>
            </li>
            <li>
              <b>save_fig_path</b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>If given, the visualizations are stored in this directory.</p>
              </div>
            </li>
            <li>
              <b>names_choice_options</b>
                  (<code>dict</code>)
              –
              <div class="doc-md-description">
                <p>If given, this shall be a dictionary, which holds the
names of the choice options as values and the numerical
indication of the choice option (0,1,2,...) as keys.</p>
              </div>
            </li>
            <li>
              <b>y_lim</b>
                  (<code>tuple</code>)
              –
              <div class="doc-md-description">
                <p>If given, this tuple indicates the limits for the y-axis
within the visualization.</p>
              </div>
            </li>
            <li>
              <b>y_lim</b>
                  (<code>tuple</code>)
              –
              <div class="doc-md-description">
                <p>If given, forecasted probabilities are returned. Defaults to False.</p>
              </div>
            </li>
            <li>
              <b>return_data</b>
                  (<code>Boolean</code>)
              –
              <div class="doc-md-description">
                <p>If True, the simulated data is returned. Defaults to False.</p>
              </div>
            </li>
            <li>
              <b>return_figure</b>
                  (<code>Boolean</code>)
              –
              <div class="doc-md-description">
                <p>If True, the visualized figure is returned. Defaults to False</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code>ValueError</code>
              –
              <div class="doc-md-description">
                <p>Is being raised, if an unknown method is indicated.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
                <code>None</code>
            –
            <div class="doc-md-description">
              
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
      <details class="quote">
        <summary>Source code in <code>mode_behave_public\post_analysis.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method creates a barplot of the mean values of different latent</span>
<span class="sd">    class and MNL models. The MNL models are based upon clustering results</span>
<span class="sd">    of random parameters from a previous simulation. Consequently, two</span>
<span class="sd">    latent class models are simulated. One is based upon the</span>
<span class="sd">    estimated clusters with their corresponding, weighted cluster-sizes.</span>
<span class="sd">    The other latent class model utilizes the same clustered values,</span>
<span class="sd">    but assigns cluster-sizes, which are externally defined by</span>
<span class="sd">    an user input during the method-call.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    method : str</span>
<span class="sd">        Method indicates the model type, which to use for forecasting.</span>
<span class="sd">        Options are: &quot;MNL&quot; (Multinomial Logit), &quot;MXL&quot; (Mixed Logit),</span>
<span class="sd">        &quot;LC&quot; (Latent Class). Defaults to &quot;MNL&quot;.</span>
<span class="sd">    sense_scenarios : dict, optional</span>
<span class="sd">        The dictionary &quot;sense_scenarios&quot; is two dimensional.</span>
<span class="sd">        The first dimension indicated the scenario name, while the</span>
<span class="sd">        second dimension holds the scenario parameters according</span>
<span class="sd">        to the definition of &quot;sense&quot;. &quot;sense&quot; itself is a dictionary.</span>
<span class="sd">        The dictionary &quot;sense&quot; holds the attribute names for which sensitivities</span>
<span class="sd">        shall be simulated as keys. The values are the arrays or lists</span>
<span class="sd">        which indicate the relative change of the attribute value</span>
<span class="sd">        for each choice option.</span>
<span class="sd">    av_external : numpy array, optional</span>
<span class="sd">        This array is used to exogenously define the availabilities</span>
<span class="sd">        for each choice option during a simulation.</span>
<span class="sd">        The array must have as much entries as choice options are</span>
<span class="sd">        being observed: len(av_external) = self.count_c</span>
<span class="sd">        Define the availability to 1 (always available), 0 (never available)</span>
<span class="sd">        or np.nan (availability according to base data).</span>
<span class="sd">    external_points : numpy array, optional</span>
<span class="sd">        This array is two-dimensional and holds one or more alternative</span>
<span class="sd">        specifications of &quot;initial_point&quot; for the simulation of</span>
<span class="sd">        multinomial logit.</span>
<span class="sd">    k : int, optional</span>
<span class="sd">        Number is cluster centers to be considered, when method = &quot;LC&quot;</span>
<span class="sd">    cluster_method : str, optional</span>
<span class="sd">        The clustering method. Defaults to &quot;kmeans.&quot;</span>
<span class="sd">    save_fig_path : str, optional</span>
<span class="sd">        If given, the visualizations are stored in this directory.</span>
<span class="sd">    names_choice_options : dict, optional</span>
<span class="sd">        If given, this shall be a dictionary, which holds the</span>
<span class="sd">        names of the choice options as values and the numerical</span>
<span class="sd">        indication of the choice option (0,1,2,...) as keys.</span>
<span class="sd">    y_lim : tuple, optional</span>
<span class="sd">        If given, this tuple indicates the limits for the y-axis</span>
<span class="sd">        within the visualization.</span>
<span class="sd">    y_lim : tuple, optional</span>
<span class="sd">        If given, forecasted probabilities are returned. Defaults to False.</span>
<span class="sd">    return_data : Boolean, optional</span>
<span class="sd">        If True, the simulated data is returned. Defaults to False.</span>
<span class="sd">    return_figure : Boolean, optional</span>
<span class="sd">        If True, the visualized figure is returned. Defaults to False</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Is being raised, if an unknown method is indicated.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># PREPARE DATA</span>
    <span class="c1">#   Get row names (random variables)</span>
    <span class="n">names_constant_fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]</span>
    <span class="n">names_constant_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]</span>
    <span class="n">names_variable_fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]</span>
    <span class="n">names_variable_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]</span>
    <span class="n">number_random</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>
        <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
    <span class="p">)</span>

    <span class="n">save_fig_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_fig_path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATH_Visualize</span><span class="p">)</span>
    <span class="n">name_scenario</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name_scenario&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">external_points</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;external_points&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]))</span>
    <span class="n">sense_scenarios</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sense_scenarios&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">names_choice_options</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;names_choice_options&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">asc_offset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;asc_offset&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)])</span>
    <span class="p">)</span>
    <span class="n">av_external</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;av_external&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">y_lim</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_lim&quot;</span><span class="p">,</span> <span class="p">())</span>
    <span class="n">return_data</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return_data&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">return_figure</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return_figure&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Dictionary to store simulation results</span>
    <span class="n">res_simu</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;MNL&quot;</span><span class="p">:</span>
        <span class="n">res_simu</span><span class="p">[</span><span class="s2">&quot;MNL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_logit</span><span class="p">(</span>
            <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span> <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">sense_scenarios</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sense_name</span> <span class="ow">in</span> <span class="n">sense_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">res_simu</span><span class="p">[</span><span class="n">sense_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_logit</span><span class="p">(</span>
                    <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                    <span class="n">sense</span><span class="o">=</span><span class="n">sense_scenarios</span><span class="p">[</span><span class="n">sense_name</span><span class="p">],</span>
                    <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">external_points</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="c1"># iterate over external points.</span>
            <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">external_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">res_simu</span><span class="p">[</span><span class="s2">&quot;External &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ep</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_logit</span><span class="p">(</span>
                    <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                    <span class="n">external_point</span><span class="o">=</span><span class="n">external_points</span><span class="p">[</span><span class="n">ep</span><span class="p">],</span>
                    <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">sense_scenarios</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sense_name</span> <span class="ow">in</span> <span class="n">sense_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">res_simu</span><span class="p">[</span>
                            <span class="s2">&quot;External &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">sense_name</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_logit</span><span class="p">(</span>
                            <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                            <span class="n">external_point</span><span class="o">=</span><span class="n">external_points</span><span class="p">[</span><span class="n">ep</span><span class="p">],</span>
                            <span class="n">sense</span><span class="o">=</span><span class="n">sense_scenarios</span><span class="p">[</span><span class="n">sense_name</span><span class="p">],</span>
                            <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;LC&quot;</span><span class="p">:</span>
        <span class="c1">#   keyword arguments</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">method_temp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cluster_method&quot;</span><span class="p">,</span> <span class="s2">&quot;kmeans&quot;</span><span class="p">)</span>

        <span class="c1">#   step 1: Check parameters</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>

        <span class="c1">#   get only points, above share-treshold.</span>
        <span class="n">shares</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span>
        <span class="n">points_scaled</span> <span class="o">=</span> <span class="n">points</span>

        <span class="c1">#   Import points of socio-economic groups</span>
        <span class="k">if</span> <span class="n">external_points</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>

            <span class="c1"># get random points.</span>
            <span class="n">external_points_random</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">external_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">number_random</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">external_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names_constant_random</span><span class="p">)):</span>
                    <span class="n">index_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_constant_fixed</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span>
                    <span class="n">external_points_random</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">external_points</span><span class="p">[</span><span class="n">group</span><span class="p">][</span>
                        <span class="n">index_temp</span>
                    <span class="p">]</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names_variable_random</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                        <span class="n">index_temp</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
                            <span class="o">-</span> <span class="mi">1</span>
                            <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_constant_fixed</span><span class="p">)</span>
                            <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_constant_random</span><span class="p">)</span>
                            <span class="o">+</span> <span class="p">(</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">names_variable_fixed</span><span class="p">)</span>
                                <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_variable_random</span><span class="p">)</span>
                            <span class="p">)</span>
                            <span class="o">*</span> <span class="n">i</span>
                            <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_variable_fixed</span><span class="p">)</span>
                            <span class="o">+</span> <span class="n">v</span>
                        <span class="p">)</span>
                        <span class="n">external_points_random</span><span class="p">[</span><span class="n">group</span><span class="p">][</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">names_constant_random</span><span class="p">)</span>
                            <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span>
                            <span class="o">+</span> <span class="n">v</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">external_points</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">index_temp</span><span class="p">]</span>

            <span class="n">ext_points</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No external reference points given.&quot;</span><span class="p">)</span>
            <span class="n">ext_points</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Get cluster centers</span>
        <span class="k">if</span> <span class="n">ext_points</span><span class="p">:</span>
            <span class="n">res_clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_space</span><span class="p">(</span>
                <span class="n">method_temp</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">points_affinity</span><span class="o">=</span><span class="n">external_points_random</span>
            <span class="p">)</span>
            <span class="n">affinity_all</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">affinity_percent_all</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">affinity_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">affinity</span> <span class="o">=</span> <span class="n">affinity_all</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                <span class="n">a_solve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">affinity</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">affinity</span><span class="p">)))</span>
                <span class="n">a_solve</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">affinity</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">affinity</span><span class="p">)):</span>
                    <span class="n">ratio_temp</span> <span class="o">=</span> <span class="n">affinity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">affinity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">a_solve</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">a_solve</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">ratio_temp</span>
                <span class="n">b_solve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">affinity</span><span class="p">))</span>
                <span class="n">b_solve</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">affinity_solve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">a_solve</span><span class="p">,</span> <span class="n">b_solve</span><span class="p">)</span>
                <span class="n">affinity_percent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">affinity_solve</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a_solve</span><span class="p">,</span> <span class="n">affinity_solve</span><span class="p">),</span> <span class="n">b_solve</span><span class="p">):</span>
                    <span class="n">affinity_percent_all</span> <span class="o">=</span> <span class="n">affinity_percent_all</span> <span class="o">+</span> <span class="p">[</span><span class="n">affinity_percent</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Affinity-calculation failed.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res_clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_space</span><span class="p">(</span>
                <span class="n">method_temp</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="n">points_scaled</span><span class="p">,</span> <span class="n">shares</span><span class="o">=</span><span class="n">shares</span>
            <span class="p">)</span>
        <span class="n">cluster_center</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">cluster_labels_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="s2">&quot;weights&quot;</span><span class="p">])</span>
        <span class="n">cluster_labels_pd</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># assign weights</span>
        <span class="k">if</span> <span class="n">method_temp</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;agglo&quot;</span><span class="p">,</span> <span class="s2">&quot;meanshift&quot;</span><span class="p">):</span>
            <span class="n">index_clustered</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">cluster_labels_pd</span> <span class="o">=</span> <span class="n">cluster_labels_pd</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cluster_labels_pd</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span><span class="p">[</span><span class="n">index_clustered</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cluster_labels_pd</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span>

        <span class="k">if</span> <span class="n">method_temp</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;meanshift&quot;</span><span class="p">,</span> <span class="s2">&quot;dbscan&quot;</span><span class="p">):</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">cluster_sizes_rel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">cluster_labels_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">cluster_labels_pd</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;weights&quot;</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># sort cluster_center and cluster_sizes_rel</span>
        <span class="n">cluster_sizes_rel_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">cluster_sizes_rel</span><span class="p">)</span>
        <span class="n">cluster_sizes_rel_pd</span> <span class="o">=</span> <span class="n">cluster_sizes_rel_pd</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cluster_sizes_rel</span> <span class="o">=</span> <span class="n">cluster_sizes_rel_pd</span><span class="o">.</span><span class="n">values</span>
        <span class="n">cluster_sizes_rel_pd</span> <span class="o">=</span> <span class="n">cluster_sizes_rel_pd</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="c1"># reshuffle cluster_center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_cluster_reorder</span> <span class="o">=</span> <span class="n">cluster_sizes_rel_pd</span>
        <span class="n">cluster_center</span> <span class="o">=</span> <span class="n">cluster_center</span><span class="p">[</span>
            <span class="n">cluster_sizes_rel_pd</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">cluster_sizes_rel_percent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">cluster_sizes_rel</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>

        <span class="c1"># SIMULATION OF LATENT CLASSES AND EXTERNAL POINTS</span>

        <span class="c1"># MNL simulation for individual clusters.</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">res_simu</span><span class="p">[</span>
                <span class="s2">&quot;C&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster_sizes_rel_percent</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;%)&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_latent_class</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cluster_center</span><span class="p">[</span><span class="n">k</span><span class="p">]]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">sense_scenarios</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sense_name</span> <span class="ow">in</span> <span class="n">sense_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">res_simu</span><span class="p">[</span>
                        <span class="s2">&quot;C&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">sense_name</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_latent_class</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cluster_center</span><span class="p">[</span><span class="n">k</span><span class="p">]]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                        <span class="n">sense</span><span class="o">=</span><span class="n">sense_scenarios</span><span class="p">[</span><span class="n">sense_name</span><span class="p">],</span>
                        <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="c1"># Simulation of externally given points.</span>
        <span class="k">if</span> <span class="n">ext_points</span><span class="p">:</span>
            <span class="n">k_group</span> <span class="o">=</span> <span class="n">external_points_random</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_group</span><span class="p">):</span>
                <span class="n">res_simu</span><span class="p">[</span><span class="s2">&quot;External &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">g</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_latent_class</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">external_points_random</span><span class="p">[</span><span class="n">g</span><span class="p">]]),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                    <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">sense_scenarios</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sense_name</span> <span class="ow">in</span> <span class="n">sense_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">res_simu</span><span class="p">[</span>
                            <span class="s2">&quot;External &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">sense_name</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_latent_class</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">external_points_random</span><span class="p">[</span><span class="n">g</span><span class="p">]]),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span>
                            <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                            <span class="n">sense</span><span class="o">=</span><span class="n">sense_scenarios</span><span class="p">[</span><span class="n">sense_name</span><span class="p">],</span>
                            <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                        <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">k_group</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Simulation of latent class model, based on cluster analysis.</span>
        <span class="n">res_simu</span><span class="p">[</span><span class="s2">&quot;Latent Class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_latent_class</span><span class="p">(</span>
            <span class="n">cluster_center</span><span class="p">,</span>
            <span class="n">cluster_sizes_rel</span><span class="p">,</span>
            <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
            <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">sense_scenarios</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sense_name</span> <span class="ow">in</span> <span class="n">sense_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">res_simu</span><span class="p">[</span>
                    <span class="s2">&quot;Latent Class&quot;</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">sense_name</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_latent_class</span><span class="p">(</span>
                    <span class="n">cluster_center</span><span class="p">,</span>
                    <span class="n">cluster_sizes_rel</span><span class="p">,</span>
                    <span class="n">sense</span><span class="o">=</span><span class="n">sense_scenarios</span><span class="p">[</span><span class="n">sense_name</span><span class="p">],</span>
                    <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                    <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">cluster_sizes_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">cluster_sizes_str</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;C&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster_sizes_rel_percent</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;%</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;MXL&quot;</span><span class="p">:</span>
        <span class="n">res_simu</span><span class="p">[</span><span class="s2">&quot;MXL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_mixed_logit</span><span class="p">(</span>
            <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span> <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">sense_scenarios</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sense_name</span> <span class="ow">in</span> <span class="n">sense_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">res_simu</span><span class="p">[</span><span class="n">sense_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_mixed_logit</span><span class="p">(</span>
                    <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                    <span class="n">sense</span><span class="o">=</span><span class="n">sense_scenarios</span><span class="p">[</span><span class="n">sense_name</span><span class="p">],</span>
                    <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">external_points</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="c1"># iterate over external points.</span>
            <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">external_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">res_simu</span><span class="p">[</span><span class="s2">&quot;External &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ep</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_logit</span><span class="p">(</span>
                    <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                    <span class="n">external_point</span><span class="o">=</span><span class="n">external_points</span><span class="p">[</span><span class="n">ep</span><span class="p">],</span>
                    <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">sense_scenarios</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sense_name</span> <span class="ow">in</span> <span class="n">sense_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">res_simu</span><span class="p">[</span>
                            <span class="s2">&quot;External &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">sense_name</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_logit</span><span class="p">(</span>
                            <span class="n">asc_offset</span><span class="o">=</span><span class="n">asc_offset</span><span class="p">,</span>
                            <span class="n">external_point</span><span class="o">=</span><span class="n">external_points</span><span class="p">[</span><span class="n">ep</span><span class="p">],</span>
                            <span class="n">sense</span><span class="o">=</span><span class="n">sense_scenarios</span><span class="p">[</span><span class="n">sense_name</span><span class="p">],</span>
                            <span class="n">av_external</span><span class="o">=</span><span class="n">av_external</span><span class="p">,</span>
                        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Chosen method is not available.&quot;</span><span class="p">)</span>

    <span class="c1">### GENERAL CODE FOR VISUALIZATION STARTS BELOW ###</span>

    <span class="c1"># Observations in base data</span>
    <span class="n">res_simu</span><span class="p">[</span><span class="s2">&quot;Base Data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;choice_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_vector</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Barplot</span>
    <span class="n">res_simu_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_simu</span><span class="p">)</span>
    <span class="n">simu_names</span> <span class="o">=</span> <span class="n">res_simu_pd</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
    <span class="n">res_simu_pd</span><span class="p">[</span><span class="s2">&quot;Choice Option&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_simu_pd</span><span class="o">.</span><span class="n">index</span>

    <span class="n">res_simu_pd_long</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
        <span class="n">res_simu_pd</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="s2">&quot;Choice Option&quot;</span><span class="p">,</span> <span class="n">value_vars</span><span class="o">=</span><span class="n">simu_names</span>
    <span class="p">)</span>
    <span class="n">res_simu_pd_long</span> <span class="o">=</span> <span class="n">res_simu_pd_long</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;Choice probability&quot;</span><span class="p">,</span> <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="s2">&quot;Scenario&quot;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="n">n_colors_temp</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res_simu</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">custom_palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">cubehelix_palette</span><span class="p">(</span>
        <span class="n">n_colors</span><span class="o">=</span><span class="n">n_colors_temp</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">rot</span><span class="o">=-</span><span class="mf">0.5</span>
    <span class="p">)</span>
    <span class="n">custom_palette</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">res_simu</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>  <span class="c1"># add grey for the last bar</span>

    <span class="c1"># Specify name of choice options</span>
    <span class="k">for</span> <span class="n">choice_option</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">names_choice_options</span><span class="p">):</span>
        <span class="n">name_temp</span> <span class="o">=</span> <span class="n">names_choice_options</span><span class="p">[</span><span class="n">choice_option</span><span class="p">]</span>
        <span class="n">res_simu_pd_long</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">res_simu_pd_long</span><span class="p">[</span><span class="s2">&quot;Choice Option&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">choice_option</span><span class="p">,</span> <span class="s2">&quot;Choice Option&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">name_temp</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">1.7</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Choice Option&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Choice probability&quot;</span><span class="p">,</span>
        <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;Scenario&quot;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">res_simu_pd_long</span><span class="p">,</span>
        <span class="n">palette</span><span class="o">=</span><span class="n">custom_palette</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">y_lim</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="n">y_lim</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.45</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">name_scenario</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="n">save_fig_path</span> <span class="o">+</span> <span class="s2">&quot;forecast_&quot;</span> <span class="o">+</span> <span class="n">name_scenario</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_fig_path</span> <span class="o">+</span> <span class="s2">&quot;forecast.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_data</span> <span class="ow">and</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res_simu_pd_long</span><span class="p">,</span> <span class="n">fig</span>
    <span class="k">elif</span> <span class="n">return_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res_simu_pd_long</span>
    <span class="k">elif</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="mode_behave_public.post_analysis.PostAnalysis.get_AIC_MNL" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_AIC_MNL</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This method calculates the AIC of an estimated MNL-model.
The AIC is a measure to evaluate the quality of the estimated model.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
<b>AIC</b>(                <code>float</code>
)            –
            <div class="doc-md-description">
              <p>Akaike information criterion.</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
      <details class="quote">
        <summary>Source code in <code>mode_behave_public\post_analysis.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_AIC_MNL</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method calculates the AIC of an estimated MNL-model.</span>
<span class="sd">    The AIC is a measure to evaluate the quality of the estimated model.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    AIC : float</span>
<span class="sd">        Akaike information criterion.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">LL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglike_MNL</span><span class="p">()</span>

    <span class="n">AIC</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">LL</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">AIC</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="mode_behave_public.post_analysis.PostAnalysis.get_BIC_MNL" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_BIC_MNL</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This method calculates the BIC of an estimated MNL-model.
The BIC is a measure to evaluate the quality of the estimated model.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
<b>BIC</b>(                <code>float</code>
)            –
            <div class="doc-md-description">
              <p>Bayesian information criterion.</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
      <details class="quote">
        <summary>Source code in <code>mode_behave_public\post_analysis.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_BIC_MNL</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method calculates the BIC of an estimated MNL-model.</span>
<span class="sd">    The BIC is a measure to evaluate the quality of the estimated model.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    BIC : float</span>
<span class="sd">        Bayesian information criterion.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">LL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglike_MNL</span><span class="p">()</span>

    <span class="n">BIC</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">LL</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">BIC</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="mode_behave_public.post_analysis.PostAnalysis.get_index_of_attribute" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_index_of_attribute</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This method returns the index of a given attribute name for the
array "self.initial_point".
This method is a supportive method for visualize_attribute()</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b>attribute</b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>Name of the attribute to be visualized.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
<b>index_attribute</b>(                <code>int</code>
)            –
            <div class="doc-md-description">
              <p>index value of the specified attribute in the array
self.initial_point</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
      <details class="quote">
        <summary>Source code in <code>mode_behave_public\post_analysis.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_index_of_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method returns the index of a given attribute name for the</span>
<span class="sd">    array &quot;self.initial_point&quot;.</span>
<span class="sd">    This method is a supportive method for visualize_attribute()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    attribute : str</span>
<span class="sd">        Name of the attribute to be visualized.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    index_attribute : int</span>
<span class="sd">        index value of the specified attribute in the array</span>
<span class="sd">        self.initial_point</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">index_attribute</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cf</span><span class="p">,</span> <span class="n">contant_fixed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="n">contant_fixed</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                    <span class="n">index_c</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">cf</span>
                    <span class="n">index_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_c</span><span class="p">)</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
    <span class="k">for</span> <span class="n">cr</span><span class="p">,</span> <span class="n">contant_random</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="n">contant_random</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                    <span class="n">index_c</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span> <span class="o">+</span> <span class="n">cr</span>
                    <span class="n">index_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_c</span><span class="p">)</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
    <span class="k">for</span> <span class="n">vf</span><span class="p">,</span> <span class="n">variable_fixed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="n">variable_fixed</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                    <span class="n">index_c</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_random</span>
                        <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                        <span class="o">+</span> <span class="n">vf</span>
                    <span class="p">)</span>
                    <span class="n">index_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_c</span><span class="p">)</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
    <span class="k">for</span> <span class="n">vr</span><span class="p">,</span> <span class="n">variable_random</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="n">variable_random</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                    <span class="n">index_c</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_random</span>
                        <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span>
                        <span class="o">+</span> <span class="n">vr</span>
                    <span class="p">)</span>
                    <span class="n">index_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_c</span><span class="p">)</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_attribute</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No such attribute&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">index_attribute</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="mode_behave_public.post_analysis.PostAnalysis.get_utility" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_utility</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Calculation of the utility-function for all observations within
a given data-sample with respect to the persons choice c.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b>c</b>
                  (<code>int</code>)
              –
              <div class="doc-md-description">
                <p>c is the choice.</p>
              </div>
            </li>
            <li>
              <b>point</b>
                  (<code>list</code>)
              –
              <div class="doc-md-description">
                <p>point specifies the random parameters within the parameter space.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
                <code>list</code>
            –
            <div class="doc-md-description">
              <p>Returns the utility for each observation.</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
      <details class="quote">
        <summary>Source code in <code>mode_behave_public\post_analysis.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_utility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculation of the utility-function for all observations within</span>
<span class="sd">    a given data-sample with respect to the persons choice c.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    c : int</span>
<span class="sd">        c is the choice.</span>
<span class="sd">    point : list</span>
<span class="sd">        point specifies the random parameters within the parameter space.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Returns the utility for each observation.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ASC</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ASC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">[</span><span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">utility</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ASC</span>
        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>
                    <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_constant_random</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">[</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_random</span>
                    <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                    <span class="o">+</span> <span class="n">a</span>
                <span class="p">]</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">[</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_random</span>
                    <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span>
                    <span class="o">+</span> <span class="n">a</span>
                <span class="p">]</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>
                    <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_variable_random</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">utility</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="mode_behave_public.post_analysis.PostAnalysis.loglike_MNL" class="doc doc-heading">
<code class="highlight language-python"><span class="n">loglike_MNL</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This method calculates the multinomial logit probability for a given
set of coefficients and all choices in the sample of the dataset.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b>Returns</b>
              –
              <div class="doc-md-description">
                
              </div>
            </li>
            <li>
              <b>res</b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Log-likelihood: Log-Probability of MNL model at a specified point.</p>
              </div>
            </li>
            <li>
              <b>number_nan</b>
                  (<code>int</code>)
              –
              <div class="doc-md-description">
                <p>Number of occured nan-values: Should be zero, otherwise,
some numerical issue occures during calculation (e.g., log(0))</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
      <details class="quote">
        <summary>Source code in <code>mode_behave_public\post_analysis.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">loglike_MNL</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method calculates the multinomial logit probability for a given</span>
<span class="sd">    set of coefficients and all choices in the sample of the dataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    res : float</span>
<span class="sd">        Log-likelihood: Log-Probability of MNL model at a specified point.</span>
<span class="sd">    number_nan : int</span>
<span class="sd">        Number of occured nan-values: Should be zero, otherwise,</span>
<span class="sd">        some numerical issue occures during calculation (e.g., log(0))</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
    <span class="n">bottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">):</span>
            <span class="n">top</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">choice</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_utility</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">bottom</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_utility</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

    <span class="n">log_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_vector</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">top</span> <span class="o">/</span> <span class="n">bottom</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">log_res</span><span class="p">)</span>
    <span class="n">number_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">log_res</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">number_nan</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="mode_behave_public.post_analysis.PostAnalysis.loglike_MXL" class="doc doc-heading">
<code class="highlight language-python"><span class="n">loglike_MXL</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This method calculates the log-likelihood for MXL-models.</p>
<p>For reference on log-likelihood calculation see:
    Ch. 5.5 (pp. 118) in "Discrete Choice Analysis", by Ben-Akiva (1985)</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b>points_in</b>
                  (<code>array</code>)
              –
              <div class="doc-md-description">
                <p>An array of preference points, if divergent to previously estimated points.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
                <code>log-likelihood : float64</code>
            –
            <div class="doc-md-description">
              <p>Returns the log-likelihood (LL) of the estimated mixed logit model.</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
      <details class="quote">
        <summary>Source code in <code>mode_behave_public\post_analysis.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">loglike_MXL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method calculates the log-likelihood for MXL-models.</span>

<span class="sd">    For reference on log-likelihood calculation see:</span>
<span class="sd">        Ch. 5.5 (pp. 118) in &quot;Discrete Choice Analysis&quot;, by Ben-Akiva (1985)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    points_in : array, optional</span>
<span class="sd">        An array of preference points, if divergent to previously estimated points.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    log-likelihood : float64</span>
<span class="sd">        Returns the log-likelihood (LL) of the estimated mixed logit model.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">points_in</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;points_in&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>

    <span class="c1"># calculates the logit probabilities</span>
    <span class="c1"># for each data point and each choice option</span>
    <span class="n">logit_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_mixed_logit</span><span class="p">(</span>
        <span class="n">points_in</span><span class="o">=</span><span class="n">points_in</span><span class="p">,</span> <span class="n">vector_output_no_weights</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logit_vector_check</span> <span class="o">=</span> <span class="n">logit_vector</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">logit_vector_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">logit_vector</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># calculates the logit probability for the chosen choice option</span>
    <span class="n">logit_vector_choice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">logit_vector_s</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">choice</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>

    <span class="c1"># get the log of each logit probability</span>
    <span class="n">logit_vector_choice_weighted_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_vector</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="n">logit_vector_choice</span>
    <span class="p">)</span>

    <span class="c1"># return the sum of the log-probabilities. Ignore nan-values</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">logit_vector_choice_weighted_log</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="mode_behave_public.post_analysis.PostAnalysis.simulate_latent_class" class="doc doc-heading">
<code class="highlight language-python"><span class="n">simulate_latent_class</span><span class="p">(</span><span class="n">latent_points</span><span class="p">,</span> <span class="n">latent_shares</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This method simulates a latent class model, based on the naming-
conventions of the mixed logit model. The different latent classes
refer to the different random points, being stored in the input
parameter -latent_points-. The parameter -latent_shares- refers
to the share of each latent class. The number of latent classes
is usually a low integer value (3-10), while the number of classes
within the mixed logit model usually amounts to &gt;1000.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b>latent_points</b>
                  (<code>2D numpy array</code>)
              –
              <div class="doc-md-description">
                <p>The random points within each class.</p>
              </div>
            </li>
            <li>
              <b>latent_shares</b>
                  (<code>1D numpy array</code>)
              –
              <div class="doc-md-description">
                <p>The share of each class.</p>
              </div>
            </li>
            <li>
              <b>sense</b>
                  (<code>dict</code>)
              –
              <div class="doc-md-description">
                <p>The dictionary "sense" holds the attribute names for which sensitivities
shall be simulated as keys. The values are the arrays or lists
which indicate the relative change of the attribute value
for each choice option.</p>
              </div>
            </li>
            <li>
              <b>av_external</b>
                  (<code>numpy array</code>)
              –
              <div class="doc-md-description">
                <p>This array is used to exogenously define the availabilities
for each choice option during a simulation.
The array must have as much entries as choice options are
being observed: len(av_external) = self.count_c
Define the availability to 1 (always available), 0 (never available)
or np.nan (availability according to base data).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
                <code>float</code>
            –
            <div class="doc-md-description">
              <p>Return the mean value for the simulated latent class model.</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
      <details class="quote">
        <summary>Source code in <code>mode_behave_public\post_analysis.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">simulate_latent_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latent_points</span><span class="p">,</span> <span class="n">latent_shares</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method simulates a latent class model, based on the naming-</span>
<span class="sd">    conventions of the mixed logit model. The different latent classes</span>
<span class="sd">    refer to the different random points, being stored in the input</span>
<span class="sd">    parameter -latent_points-. The parameter -latent_shares- refers</span>
<span class="sd">    to the share of each latent class. The number of latent classes</span>
<span class="sd">    is usually a low integer value (3-10), while the number of classes</span>
<span class="sd">    within the mixed logit model usually amounts to &gt;1000.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    latent_points : 2D numpy array, optional</span>
<span class="sd">        The random points within each class.</span>
<span class="sd">    latent_shares : 1D numpy array, optional</span>
<span class="sd">        The share of each class.</span>
<span class="sd">    sense : dict, optional</span>
<span class="sd">        The dictionary &quot;sense&quot; holds the attribute names for which sensitivities</span>
<span class="sd">        shall be simulated as keys. The values are the arrays or lists</span>
<span class="sd">        which indicate the relative change of the attribute value</span>
<span class="sd">        for each choice option.</span>
<span class="sd">    av_external : numpy array, optional</span>
<span class="sd">        This array is used to exogenously define the availabilities</span>
<span class="sd">        for each choice option during a simulation.</span>
<span class="sd">        The array must have as much entries as choice options are</span>
<span class="sd">        being observed: len(av_external) = self.count_c</span>
<span class="sd">        Define the availability to 1 (always available), 0 (never available)</span>
<span class="sd">        or np.nan (availability according to base data).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Return the mean value for the simulated latent class model.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">count_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
    <span class="n">count_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_e</span>
    <span class="n">sense</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sense&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">asc_offset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;asc_offset&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">av_external</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;av_external&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># exogeneous definiton of choice availabilities</span>
    <span class="k">if</span> <span class="n">av_external</span><span class="p">:</span>
        <span class="c1"># check for the correct number of exogenously defined availabilities.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">av_external</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">:</span>
            <span class="c1"># interate over availabilities</span>
            <span class="k">for</span> <span class="n">av_ext_count</span><span class="p">,</span> <span class="n">av_ext</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">av_external</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">av_ext</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">av_ext</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">[</span><span class="n">av_ext_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">av_ext</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;External availability must be 0 or 1.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;Number of defined availabilities does not match number of choice options.&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_backup</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">no_constant_fixed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">])</span>
    <span class="n">no_constant_random</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>
    <span class="n">no_variable_fixed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">])</span>
    <span class="n">no_variable_random</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>

    <span class="c1"># check compatabiilty of latent_points and no_variable</span>
    <span class="n">no_random</span> <span class="o">=</span> <span class="n">no_constant_random</span> <span class="o">+</span> <span class="n">no_variable_random</span> <span class="o">*</span> <span class="n">count_c</span>
    <span class="k">if</span> <span class="n">no_random</span> <span class="o">!=</span> <span class="n">latent_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Defined parameter set -param- does not match number of random variables.&quot;</span>
        <span class="p">)</span>

    <span class="n">initial_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span>

    <span class="n">dim_aggr_alt_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]),</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]),</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
    <span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
        <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dim_aggr_alt_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                        <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                        <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                        <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                        <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="nd">@njit</span>
    <span class="k">def</span> <span class="nf">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">res_temp</span> <span class="o">=</span> <span class="n">asc_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res_temp</span> <span class="o">=</span> <span class="n">asc_offset</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">initial_point</span><span class="p">[</span><span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_constant_fixed</span><span class="p">):</span>
            <span class="n">res_temp</span> <span class="o">+=</span> <span class="n">initial_point</span><span class="p">[(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_constant_random</span><span class="p">):</span>
            <span class="n">res_temp</span> <span class="o">+=</span> <span class="n">point</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variable_fixed</span><span class="p">):</span>
            <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">initial_point</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">no_constant_fixed</span>
                    <span class="o">+</span> <span class="n">no_constant_random</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                    <span class="o">+</span> <span class="n">a</span>
                <span class="p">]</span>
                <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variable_random</span><span class="p">):</span>
            <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">point</span><span class="p">[</span><span class="n">no_constant_random</span> <span class="o">+</span> <span class="n">no_variable_random</span> <span class="o">*</span> <span class="n">c</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">res_temp</span>

    <span class="nd">@guvectorize</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s2">&quot;float64[:, :], float64[:, :, :], float64[:], float64[:, :, :, :, :], float64[:], float64[:, :, :, :]&quot;</span>
        <span class="p">],</span>
        <span class="s2">&quot;(m,p),(n,e,l),(l),(i,j,n,e,l),(n)-&gt;(m,l,n,e)&quot;</span><span class="p">,</span>
        <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="s2">&quot;parallel&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">calculate_logit_vector</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">av</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">,</span> <span class="n">logit_probs_</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

            <span class="c1"># iterate over length of data array (len(av))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">av</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="c1"># calculate bottom</span>
                <span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_c</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_e</span><span class="p">):</span>
                        <span class="n">bottom</span> <span class="o">+=</span> <span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span>
                            <span class="n">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_c</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_e</span><span class="p">):</span>
                        <span class="n">top</span> <span class="o">=</span> <span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span>
                            <span class="n">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">logit_probs_</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">top</span> <span class="o">/</span> <span class="n">bottom</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>

    <span class="n">logit_probs</span> <span class="o">=</span> <span class="n">calculate_logit_vector</span><span class="p">(</span>
        <span class="n">latent_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_vector</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_logit_probs</span> <span class="o">=</span> <span class="n">logit_probs</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">logit_probs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">latent_class</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">logit_probs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">logit_probs</span><span class="p">[</span><span class="n">latent_class</span><span class="p">]</span> <span class="o">*</span> <span class="n">latent_shares</span><span class="p">[</span><span class="n">latent_class</span><span class="p">]</span>

    <span class="c1"># sum over equal alternatives</span>
    <span class="n">res_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">res_sum</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="mode_behave_public.post_analysis.PostAnalysis.simulate_logit" class="doc doc-heading">
<code class="highlight language-python"><span class="n">simulate_logit</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This method simulates a multinomial logit model, based on the naming-
conventions of the mixed logit model.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b>kwargs</b>
              –
              <div class="doc-md-description">
                <p>The dictionary "sense" holds the attribute names for which sensitivities
shall be simulated as keys. The values are the arrays or lists
which indicate the relative change of the attribute value
for each choice option.</p>
              </div>
            </li>
            <li>
              <b>kwargs</b>
              –
              <div class="doc-md-description">
                <p>offset values for alternative specific constants</p>
              </div>
            </li>
            <li>
              <b>kwargs</b>
              –
              <div class="doc-md-description">
                <p>This array is used to exogenously define the availabilities
for each choice option during a simulation.
The array must have as much entries as choice options are
being observed: len(av_external) = self.count_c
Define the availability to 1 (always available), 0 (never available)
or np.nan (availability according to base data).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
                <code>float</code>
            –
            <div class="doc-md-description">
              <p>Return the mean value for the simulated latent class model.</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
      <details class="quote">
        <summary>Source code in <code>mode_behave_public\post_analysis.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">simulate_logit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method simulates a multinomial logit model, based on the naming-</span>
<span class="sd">    conventions of the mixed logit model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kwargs sense : dictionary, optional</span>
<span class="sd">        The dictionary &quot;sense&quot; holds the attribute names for which sensitivities</span>
<span class="sd">        shall be simulated as keys. The values are the arrays or lists</span>
<span class="sd">        which indicate the relative change of the attribute value</span>
<span class="sd">        for each choice option.</span>
<span class="sd">    kwargs asc_offset : list, optional</span>
<span class="sd">        offset values for alternative specific constants</span>
<span class="sd">    kwargs av_external : array, optional</span>
<span class="sd">        This array is used to exogenously define the availabilities</span>
<span class="sd">        for each choice option during a simulation.</span>
<span class="sd">        The array must have as much entries as choice options are</span>
<span class="sd">        being observed: len(av_external) = self.count_c</span>
<span class="sd">        Define the availability to 1 (always available), 0 (never available)</span>
<span class="sd">        or np.nan (availability according to base data).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Return the mean value for the simulated latent class model.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">count_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
    <span class="n">count_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_e</span>
    <span class="n">sense</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sense&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">external_point</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;external_point&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">asc_offset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;asc_offset&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">av_external</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;av_external&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># exogeneous definiton of choice availabilities</span>
    <span class="k">if</span> <span class="n">av_external</span><span class="p">:</span>
        <span class="c1"># check for the correct number of exogenously defined availabilities.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">av_external</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">:</span>
            <span class="c1"># interate over availabilities</span>
            <span class="k">for</span> <span class="n">av_ext_count</span><span class="p">,</span> <span class="n">av_ext</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">av_external</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">av_ext</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">av_ext</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">[</span><span class="n">av_ext_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">av_ext</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;External availability must be 0 or 1.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;Number of defined availabilities does not match number of choice options.&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_backup</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">no_constant_fixed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">])</span>
    <span class="n">no_constant_random</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>
    <span class="n">no_variable_fixed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">])</span>
    <span class="n">no_variable_random</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">external_point</span><span class="p">):</span>
        <span class="n">initial_point</span> <span class="o">=</span> <span class="n">external_point</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">initial_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span>

    <span class="n">dim_aggr_alt_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]),</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]),</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
    <span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
        <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dim_aggr_alt_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                        <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                        <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                        <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                        <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">def</span> <span class="nf">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">res_temp</span> <span class="o">=</span> <span class="n">asc_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res_temp</span> <span class="o">=</span> <span class="n">asc_offset</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">initial_point</span><span class="p">[</span><span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_constant_fixed</span><span class="p">):</span>
            <span class="n">res_temp</span> <span class="o">+=</span> <span class="n">initial_point</span><span class="p">[(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_constant_random</span><span class="p">):</span>
            <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">initial_point</span><span class="p">[(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">no_constant_fixed</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variable_fixed</span><span class="p">):</span>
            <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">initial_point</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">no_constant_fixed</span>
                    <span class="o">+</span> <span class="n">no_constant_random</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                    <span class="o">+</span> <span class="n">a</span>
                <span class="p">]</span>
                <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variable_random</span><span class="p">):</span>
            <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">initial_point</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">no_constant_fixed</span>
                    <span class="o">+</span> <span class="n">no_constant_random</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                    <span class="o">+</span> <span class="n">no_variable_fixed</span>
                    <span class="o">+</span> <span class="n">a</span>
                <span class="p">]</span>
                <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">res_temp</span>

    <span class="k">def</span> <span class="nf">calculate_logit_shares</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">):</span>

        <span class="n">logit_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">count_c</span><span class="p">,</span> <span class="n">count_e</span><span class="p">))</span>

        <span class="c1"># calculate bottom</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">av</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count_c</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count_e</span><span class="p">):</span>
                <span class="n">bottom</span> <span class="o">+=</span> <span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                    <span class="n">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count_c</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count_e</span><span class="p">):</span>
                <span class="n">top</span> <span class="o">=</span> <span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">))</span>
                <span class="n">logit_probs</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">top</span> <span class="o">/</span> <span class="n">bottom</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_vector</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">logit_probs</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">calculate_logit_shares</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="mode_behave_public.post_analysis.PostAnalysis.simulate_mixed_logit" class="doc doc-heading">
<code class="highlight language-python"><span class="n">simulate_mixed_logit</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Calculation of probabilities of mixed logit model for all
observations within a given base-sample.
Requires prior call of estimate_mixed_logit().</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b>latent_points</b>
                  (<code>2D numpy array</code>)
              –
              <div class="doc-md-description">
                <p>The random points within each class.</p>
              </div>
            </li>
            <li>
              <b>latent_shares</b>
                  (<code>1D numpy array.</code>)
              –
              <div class="doc-md-description">
                <p>The share of each class, optional</p>
              </div>
            </li>
            <li>
              <b>sense</b>
                  (<code>dictionary</code>)
              –
              <div class="doc-md-description">
                <p>The dictionary "sense" holds the attribute names for which sensitivities
shall be simulated as keys. The values are the arrays or lists
which indicate the relative change of the attribute value
for each choice option.</p>
              </div>
            </li>
            <li>
              <b>av_external</b>
                  (<code>numpy array</code>)
              –
              <div class="doc-md-description">
                <p>This array is used to exogenously define the availabilities
for each choice option during a simulation.
The array must have as much entries as choice options are
being observed: len(av_external) = self.count_c
Define the availability to 1 (always available), 0 (never available)
or np.nan (availability according to base data).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
                <code>PandasSeries</code>
            –
            <div class="doc-md-description">
              <p>Returns a pandas series with model probabilities for each
observation.</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
      <details class="quote">
        <summary>Source code in <code>mode_behave_public\post_analysis.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">simulate_mixed_logit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculation of probabilities of mixed logit model for all</span>
<span class="sd">    observations within a given base-sample.</span>
<span class="sd">    Requires prior call of estimate_mixed_logit().</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    latent_points : 2D numpy array, optional</span>
<span class="sd">        The random points within each class.</span>
<span class="sd">    latent_shares : 1D numpy array.</span>
<span class="sd">        The share of each class, optional</span>
<span class="sd">    sense : dictionary, optional</span>
<span class="sd">        The dictionary &quot;sense&quot; holds the attribute names for which sensitivities</span>
<span class="sd">        shall be simulated as keys. The values are the arrays or lists</span>
<span class="sd">        which indicate the relative change of the attribute value</span>
<span class="sd">        for each choice option.</span>
<span class="sd">    av_external : numpy array, optional</span>
<span class="sd">        This array is used to exogenously define the availabilities</span>
<span class="sd">        for each choice option during a simulation.</span>
<span class="sd">        The array must have as much entries as choice options are</span>
<span class="sd">        being observed: len(av_external) = self.count_c</span>
<span class="sd">        Define the availability to 1 (always available), 0 (never available)</span>
<span class="sd">        or np.nan (availability according to base data).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    PandasSeries</span>
<span class="sd">        Returns a pandas series with model probabilities for each</span>
<span class="sd">        observation.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mixing_distribution</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mixing_distribution&quot;</span><span class="p">,</span> <span class="s2">&quot;discrete&quot;</span><span class="p">)</span>
    <span class="n">sense</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sense&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">vector_output_no_weights</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vector_output_no_weights&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">asc_offset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;asc_offset&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">av_external</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;av_external&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># exogeneous definiton of choice availabilities</span>
    <span class="k">if</span> <span class="n">av_external</span><span class="p">:</span>
        <span class="c1"># check for the correct number of exogenously defined availabilities.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">av_external</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">:</span>
            <span class="c1"># interate over availabilities</span>
            <span class="k">for</span> <span class="n">av_ext_count</span><span class="p">,</span> <span class="n">av_ext</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">av_external</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">av_ext</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">av_ext</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">[</span><span class="n">av_ext_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">av_ext</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;External availability must be 0 or 1.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;Number of defined availabilities does not match number of choice options.&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_backup</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">mixing_distribution</span> <span class="o">==</span> <span class="s2">&quot;discrete&quot;</span><span class="p">:</span>
        <span class="n">initial_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span>
        <span class="n">no_constant_fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_fixed</span>
        <span class="n">no_constant_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_constant_random</span>
        <span class="n">no_variable_fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_fixed</span>
        <span class="n">no_variable_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_variable_random</span>
        <span class="n">count_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
        <span class="n">count_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_e</span>

        <span class="n">dim_aggr_alt_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
        <span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dim_aggr_alt_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_e</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                            <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                            <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                            <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                            <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                            <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                            <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sense</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                            <span class="o">*</span> <span class="n">sense</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                            <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="nd">@njit</span>
        <span class="k">def</span> <span class="nf">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculates the utility of a choice option.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            c : int</span>
<span class="sd">                Choice option.</span>
<span class="sd">            point : array</span>
<span class="sd">                Multi-dimensional point in the parameter space.</span>
<span class="sd">            l : array</span>
<span class="sd">                DESCRIPTION.</span>
<span class="sd">            data : array</span>
<span class="sd">                Base data.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            res_temp : float</span>
<span class="sd">                Utility of a choice option.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">res_temp</span> <span class="o">=</span> <span class="n">asc_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_temp</span> <span class="o">=</span> <span class="n">asc_offset</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">initial_point</span><span class="p">[</span><span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_constant_fixed</span><span class="p">):</span>
                <span class="n">res_temp</span> <span class="o">+=</span> <span class="n">initial_point</span><span class="p">[(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_constant_random</span><span class="p">):</span>
                <span class="n">res_temp</span> <span class="o">+=</span> <span class="n">point</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variable_fixed</span><span class="p">):</span>
                <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">initial_point</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">no_constant_fixed</span>
                        <span class="o">+</span> <span class="n">no_constant_random</span>
                        <span class="o">+</span> <span class="p">(</span><span class="n">no_variable_fixed</span> <span class="o">+</span> <span class="n">no_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
                        <span class="o">+</span> <span class="n">a</span>
                    <span class="p">]</span>
                    <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variable_random</span><span class="p">):</span>
                <span class="n">res_temp</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">point</span><span class="p">[</span><span class="n">no_constant_random</span> <span class="o">+</span> <span class="n">no_variable_random</span> <span class="o">*</span> <span class="n">c</span> <span class="o">+</span> <span class="n">a</span><span class="p">]</span>
                    <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">res_temp</span>

        <span class="nd">@guvectorize</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;float64[:, :], float64[:, :, :], float64[:, :, :, :, :], float64[:], float64[:, :, :, :]&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;(m,p),(n,e,l),(i,j,n,e,l),(n)-&gt;(m,l,n,e)&quot;</span><span class="p">,</span>
            <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="s2">&quot;parallel&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">def</span> <span class="nf">calculate_logit_vector</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">av</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">,</span> <span class="n">logit_probs_</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">point</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

                <span class="c1"># iterate over length of data array (len(av))</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">av</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="c1"># calculate bottom</span>
                    <span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_c</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_e</span><span class="p">):</span>
                            <span class="n">bottom</span> <span class="o">+=</span> <span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span>
                                <span class="n">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">)</span>
                            <span class="p">)</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_c</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">count_e</span><span class="p">):</span>
                            <span class="n">top</span> <span class="o">=</span> <span class="n">av</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span>
                                <span class="n">get_utility_vector</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span><span class="p">)</span>
                            <span class="p">)</span>
                            <span class="n">logit_probs_</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">top</span> <span class="o">/</span> <span class="n">bottom</span>

        <span class="n">logit_probs_matrix</span> <span class="o">=</span> <span class="n">calculate_logit_vector</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">asc_offset</span>
        <span class="p">)</span>
        <span class="c1"># multiply logit probs per point with share of the point</span>
        <span class="n">logit_probs_matrix_shares</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span> <span class="o">*</span> <span class="n">logit_probs_matrix</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># sum along all considered points of the parameter space</span>
        <span class="n">logit_probs_summed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">logit_probs_matrix_shares</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_logit_probs_summed</span> <span class="o">=</span> <span class="n">logit_probs_summed</span>

        <span class="k">if</span> <span class="n">vector_output_no_weights</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">logit_probs_summed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get mean of all probabilities</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logit_probs_summed</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_vector</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not yet implemented.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="mode_behave_public.post_analysis.PostAnalysis.visualize_all_attributes" class="doc doc-heading">
<code class="highlight language-python"><span class="n">visualize_all_attributes</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This method visualizes all attribute weights and additionally
indicates the t-statistics, based on the
estimation results of the standard logit model.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b>kwargs</b>
              –
              <div class="doc-md-description">
                <p>Path, which indicated the place where to store the visualization
as a .png-file.</p>
              </div>
            </li>
            <li>
              <b>kwargs</b>
              –
              <div class="doc-md-description">
                <p>If given, this shall be a dictionary, which holds the
names of the choice options as values and the numerical
indication of the choice option (0,1,2,...) as keys.</p>
              </div>
            </li>
            <li>
              <b>kwargs</b>
              –
              <div class="doc-md-description">
                <p>Shifts the text-fields which indicate the value of the t-statistic
in positive or negative direction..</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
      <details class="quote">
        <summary>Source code in <code>mode_behave_public\post_analysis.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">visualize_all_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method visualizes all attribute weights and additionally</span>
<span class="sd">    indicates the t-statistics, based on the</span>
<span class="sd">    estimation results of the standard logit model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    kwargs save_fig_path : string, optional</span>
<span class="sd">        Path, which indicated the place where to store the visualization</span>
<span class="sd">        as a .png-file.</span>
<span class="sd">    kwargs names_choice_options : dict, optional</span>
<span class="sd">        If given, this shall be a dictionary, which holds the</span>
<span class="sd">        names of the choice options as values and the numerical</span>
<span class="sd">        indication of the choice option (0,1,2,...) as keys.</span>
<span class="sd">    kwargs shift_t_stats : float, optional</span>
<span class="sd">        Shifts the text-fields which indicate the value of the t-statistic</span>
<span class="sd">        in positive or negative direction..</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get keyword arguments</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">save_fig_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_fig_path&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">names_choice_options</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;names_choice_options&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">control_left_annotation</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;control_left_annotation&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">control_right_annotation</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;control_right_annotation&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">control_legend</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;control_legend&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ext_x_limits</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ext_x_limits&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">control_colorbar_label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;control_colorbar_label&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="n">relative</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relative&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">stepwise</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stepwise&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">set_title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;set_title&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">set_xlabel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;set_xlabel&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">map_y_values</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;map_y_values&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">names_choice_options</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">names_choice_options</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Choice option &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="c1"># get data</span>
    <span class="n">y_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]:</span>
        <span class="n">y_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]:</span>
        <span class="n">y_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]:</span>
        <span class="n">y_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]:</span>
        <span class="n">y_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

    <span class="n">x_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)}</span>
    <span class="n">x_values_mean</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)}</span>
    <span class="n">t_stats</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)}</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">y_values</span><span class="p">:</span>
        <span class="n">index_attribute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_index_of_attribute</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">list_value_temp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
            <span class="n">list_value_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">[</span><span class="n">index_attribute</span><span class="p">[</span><span class="n">c</span><span class="p">]])</span>
        <span class="n">max_list_value_temp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">list_value_temp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">relative</span><span class="p">:</span>
                <span class="n">data_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">utility_temp</span> <span class="o">=</span> <span class="n">list_value_temp</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">data_mean</span>
                <span class="n">x_values</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utility_temp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">stepwise</span><span class="p">:</span>
                <span class="c1"># calculate mean value</span>
                <span class="n">data_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">utility_temp</span> <span class="o">=</span> <span class="n">list_value_temp</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">data_mean</span>
                <span class="n">x_values_mean</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utility_temp</span><span class="p">)</span>

                <span class="c1"># calculate list of utilities</span>
                <span class="n">unique_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_values</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">unique_values</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">val_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">unique_values</span><span class="p">)</span>
                    <span class="n">val_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">unique_values</span><span class="p">)</span>
                    <span class="n">step_temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">val_max</span> <span class="o">-</span> <span class="n">val_min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span>
                    <span class="n">unique_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                        <span class="n">val_min</span><span class="p">,</span> <span class="n">val_max</span> <span class="o">+</span> <span class="n">step_temp</span><span class="p">,</span> <span class="n">step_temp</span>
                    <span class="p">)</span>
                <span class="n">utilities_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">unique_values</span><span class="p">:</span>
                    <span class="n">utility_temp</span> <span class="o">=</span> <span class="n">list_value_temp</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span>
                    <span class="n">utility_delta</span> <span class="o">=</span> <span class="n">utility_temp</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">utilities_list</span><span class="p">)</span>
                    <span class="n">utilities_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utility_delta</span><span class="p">)</span>
                <span class="n">left_over</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_values</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">left_over</span><span class="p">):</span>
                    <span class="n">utilities_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x_values</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utilities_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value_temp_scaled</span> <span class="o">=</span> <span class="n">list_value_temp</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="n">max_list_value_temp</span>
                <span class="n">x_values</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value_temp_scaled</span><span class="p">)</span>
            <span class="n">t_stats_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_stats</span><span class="p">[</span><span class="n">index_attribute</span><span class="p">[</span><span class="n">c</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">t_stats</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_stats_temp</span><span class="p">)</span>

    <span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">cubehelix_palette</span><span class="p">(</span>
        <span class="n">n_colors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rot</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">light</span><span class="o">=</span><span class="mf">0.65</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">stepwise</span><span class="p">:</span>
        <span class="n">palette_stepwise</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span>
            <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;YlGnBu&quot;</span><span class="p">,</span>
            <span class="n">n_colors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># continue with plots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">set_title</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">set_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">set_xlabel</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">set_xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stepwise</span><span class="p">:</span>
        <span class="n">palette_stepwise_cmap</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span>
            <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;YlGnBu&quot;</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">as_cmap</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="c1"># norm_temp = Normalize(vmin=1, vmax=10)</span>
        <span class="n">norm_temp</span> <span class="o">=</span> <span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">palette_stepwise_cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="n">_cbar</span> <span class="o">=</span> <span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm_temp</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">palette_stepwise_cmap</span><span class="p">)</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="s2">&quot;vertical&quot;</span>
        <span class="c1"># ax_cbar = fig.colorbar(_cbar, ax=ax.ravel().tolist(), orientation=cbar, shrink=0.8)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">_cbar</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="n">cbar</span><span class="p">)</span>

        <span class="n">custom_patches</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Line2D</span><span class="p">(</span>
                <span class="p">[],</span>
                <span class="p">[],</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;Black&quot;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Average </span><span class="se">\n</span><span class="s2">household&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="n">handles</span><span class="o">=</span><span class="n">custom_patches</span><span class="p">,</span>
            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span>
            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">control_legend</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
            <span class="n">borderpad</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
            <span class="n">handlelength</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">control_colorbar_label</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">control_colorbar_label</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;Attribute level&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
            <span class="n">rotation</span><span class="o">=-</span><span class="mi">90</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">custom_patches</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">names_choice_options</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="n">handles</span><span class="o">=</span><span class="n">custom_patches</span><span class="p">,</span>
            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span>
            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">control_legend</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">width</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>

    <span class="c1"># change order of attributes according to keyword map_y_values_temp</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_y_values</span> <span class="o">=</span> <span class="n">y_values</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_x_values</span> <span class="o">=</span> <span class="n">x_values</span>

    <span class="c1"># create mapping of y-values</span>
    <span class="k">if</span> <span class="n">map_y_values</span><span class="p">:</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">[</span><span class="n">y_values</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">map_y_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
        <span class="n">mapping</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_values</span><span class="p">))]</span>

    <span class="c1"># iterate over choice alternatives</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">stepwise</span><span class="p">:</span>
            <span class="n">values_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_values</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                <span class="c1"># assign values from iteration v-1 to &quot;left_temp&quot;</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">left_temp</span> <span class="o">=</span> <span class="n">values_to_plot</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">left_temp</span> <span class="o">+=</span> <span class="n">values_to_plot</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_values</span><span class="p">)):</span>
                    <span class="n">a_mapped</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                    <span class="n">value_temp</span> <span class="o">=</span> <span class="n">x_values</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a_mapped</span><span class="p">][</span><span class="n">v</span><span class="p">]</span>
                    <span class="n">values_to_plot</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_temp</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_values</span><span class="p">))</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">c</span><span class="p">,</span>
                    <span class="n">values_to_plot</span><span class="p">,</span>
                    <span class="n">width</span><span class="p">,</span>
                    <span class="n">left</span><span class="o">=</span><span class="n">left_temp</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">palette_stepwise</span><span class="p">[</span><span class="n">v</span><span class="p">],</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_values</span><span class="p">))</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">c</span><span class="p">,</span>
                <span class="n">x_values</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
                <span class="n">width</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">map_y_values</span> <span class="ow">and</span> <span class="n">stepwise</span><span class="p">:</span>
        <span class="n">y_values_mapped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">map_y_values</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">y_values_mapped</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">yticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_values</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.4</span><span class="p">,</span>
            <span class="n">yticklabels</span><span class="o">=</span><span class="n">y_values_mapped</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">yticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_values</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.4</span><span class="p">,</span>
            <span class="n">yticklabels</span><span class="o">=</span><span class="n">y_values</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">y_values</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;xtick&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;ytick&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ext_x_limits</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">ext_x_limits</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">check_x_values</span> <span class="o">=</span> <span class="n">x_values</span>

    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y_values</span><span class="p">):</span>
        <span class="n">a_mapped</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>

        <span class="n">width_temp</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="o">-</span><span class="mf">0.4</span> <span class="o">+</span> <span class="n">width_temp</span> <span class="o">*</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mf">0.4</span> <span class="o">+</span> <span class="n">width_temp</span> <span class="o">*</span> <span class="mf">1.8</span><span class="p">,</span> <span class="n">width_temp</span>
        <span class="p">)</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="n">y_range</span> <span class="o">+</span> <span class="n">a</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">stepwise</span><span class="p">:</span>
                <span class="n">x_value_temp</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">x_values_mean</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a_mapped</span><span class="p">],</span>
                    <span class="n">ymin</span><span class="o">=</span><span class="n">y_range</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">width_temp</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">ymax</span><span class="o">=</span><span class="n">y_range</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">width_temp</span><span class="p">,</span>
                    <span class="n">linestyles</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">x_value_temp</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">x_values_mean</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a_mapped</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_value_temp</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">x_values</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a_mapped</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">t_stats_precise_temp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t_stats</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">a_mapped</span><span class="p">])</span>
            <span class="n">t_stats_temp</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">t_stats_precise_temp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t_stats_precise_temp</span> <span class="o">&gt;=</span> <span class="mf">2.325</span><span class="p">:</span>
                <span class="n">value_str</span> <span class="o">=</span> <span class="s2">&quot;***&quot;</span>
            <span class="k">elif</span> <span class="n">t_stats_precise_temp</span> <span class="o">&gt;=</span> <span class="mf">1.96</span><span class="p">:</span>
                <span class="n">value_str</span> <span class="o">=</span> <span class="s2">&quot;**&quot;</span>
            <span class="k">elif</span> <span class="n">t_stats_precise_temp</span> <span class="o">&gt;=</span> <span class="mf">1.645</span><span class="p">:</span>
                <span class="n">value_str</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">c_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c_str</span> <span class="o">=</span> <span class="s2">&quot;3+&quot;</span>
            <span class="n">text_temp</span> <span class="o">=</span> <span class="n">c_str</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t_stats_temp</span><span class="p">)</span> <span class="o">+</span> <span class="n">value_str</span>
            <span class="k">if</span> <span class="n">x_value_temp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">control_right_annotation</span><span class="p">,</span> <span class="n">y_range</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">text_temp</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">control_left_annotation</span><span class="p">,</span> <span class="n">y_range</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">text_temp</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># arrow and text for no routine model</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">4.8</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s2">&quot;-11.9&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="o">-</span><span class="mf">4.4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_fig_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">relative</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="n">save_fig_path</span>
                <span class="o">+</span> <span class="s2">&quot;overview_attributes_relative_&quot;</span>
                <span class="o">+</span> <span class="n">model_name</span>
                <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">,</span>
                <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">stepwise</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="n">save_fig_path</span>
                <span class="o">+</span> <span class="s2">&quot;overview_attributes_stepwise_&quot;</span>
                <span class="o">+</span> <span class="n">model_name</span>
                <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">,</span>
                <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="n">save_fig_path</span> <span class="o">+</span> <span class="s2">&quot;overview_attributes_&quot;</span> <span class="o">+</span> <span class="n">model_name</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">,</span>
                <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
                <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;eps&quot;</span><span class="p">,</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="mode_behave_public.post_analysis.PostAnalysis.visualize_attribute" class="doc doc-heading">
<code class="highlight language-python"><span class="n">visualize_attribute</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This method visualizes the attribute weights for an exogenously specified
attribute and additionally indicates the t-statistics, based on the
estimation results of the standard logit model.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b>attribute</b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>Name of the attribute to be visualized.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>save_fig_path : string, optional
    Path, which indicated the place where to store the visualization
    as a .png-file.</p>
<p>names_choice_options : dict, optional
    If given, this shall be a dictionary, which holds the
    names of the choice options as values and the numerical
    indication of the choice option (0,1,2,...) as keys.</p>
<p>shift_t_stats : float, optional
    Shifts the text-fields which indicate the value of the t-statistic
    in positive or negative direction..</p>

      <details class="quote">
        <summary>Source code in <code>mode_behave_public\post_analysis.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">visualize_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method visualizes the attribute weights for an exogenously specified</span>
<span class="sd">    attribute and additionally indicates the t-statistics, based on the</span>
<span class="sd">    estimation results of the standard logit model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    attribute : str</span>
<span class="sd">        Name of the attribute to be visualized.</span>

<span class="sd">    save_fig_path : string, optional</span>
<span class="sd">        Path, which indicated the place where to store the visualization</span>
<span class="sd">        as a .png-file.</span>

<span class="sd">    names_choice_options : dict, optional</span>
<span class="sd">        If given, this shall be a dictionary, which holds the</span>
<span class="sd">        names of the choice options as values and the numerical</span>
<span class="sd">        indication of the choice option (0,1,2,...) as keys.</span>

<span class="sd">    shift_t_stats : float, optional</span>
<span class="sd">        Shifts the text-fields which indicate the value of the t-statistic</span>
<span class="sd">        in positive or negative direction..</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get keyword arguments</span>
    <span class="n">save_fig_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_fig_path&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">shift_t_stats</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shift_t_stats&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># get index of attribute</span>
    <span class="n">index_attribute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_index_of_attribute</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
    <span class="n">names_choice_options</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;names_choice_options&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="n">list_param</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_t_stats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tick_label_temp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">index_attribute</span><span class="p">):</span>
        <span class="n">list_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_point</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">list_t_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_stats</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">names_choice_options</span><span class="p">):</span>
            <span class="n">tick_label_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">names_choice_options</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tick_label_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;choice_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">title_temp</span> <span class="o">=</span> <span class="s2">&quot;Attribute: &quot;</span> <span class="o">+</span> <span class="n">attribute</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_temp</span><span class="p">)</span>
    <span class="n">custom_lines</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">),</span>
        <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">custom_lines</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;t-statistic &gt;=1.96&quot;</span><span class="p">,</span> <span class="s2">&quot;t-statistic &lt;1.96&quot;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Attribute weight&quot;</span><span class="p">)</span>
    <span class="n">bar_temp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
        <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">),</span>
        <span class="n">list_param</span><span class="p">,</span>
        <span class="n">tick_label</span><span class="o">=</span><span class="n">tick_label_temp</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
        <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ylim_temp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">list_t_stats</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1.96</span><span class="p">:</span>
            <span class="n">bar_temp</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">set_linestyle</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
        <span class="n">t_stat_temp</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">list_t_stats</span><span class="p">[</span><span class="n">b</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">textstr</span> <span class="o">=</span> <span class="s2">&quot;t-statistic:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t_stat_temp</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">ylim_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="o">+</span> <span class="n">shift_t_stats</span><span class="p">,</span> <span class="n">textstr</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;t-stats:&quot;</span><span class="p">,</span> <span class="n">list_t_stats</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;param:&quot;</span><span class="p">,</span> <span class="n">list_param</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_fig_path</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="n">save_fig_path</span> <span class="o">+</span> <span class="s2">&quot;attribute_&quot;</span> <span class="o">+</span> <span class="n">attribute</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="mode_behave_public.post_analysis.PostAnalysis.visualize_space" class="doc doc-heading">
<code class="highlight language-python"><span class="n">visualize_space</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This method visualizes the distribution of preferences across the
base population for the randomized model attributes, which have been
analyzed within the estimation of the mixed logit model.
Furthermore, the estimated (mean) preferences from the multinomial
logit model are displayed as reference points.</p>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b>return_res</b>
                  (<code>Boolean</code>)
              –
              <div class="doc-md-description">
                <p>If True, the clustering results are returned. Defaults to False.</p>
              </div>
            </li>
            <li>
              <b>return_figure</b>
                  (<code>Boolean</code>)
              –
              <div class="doc-md-description">
                <p>If True, the rendered figure is returned. Defaults to False.</p>
              </div>
            </li>
            <li>
              <b>cluster_method</b>
                  (<code>string</code>)
              –
              <div class="doc-md-description">
                <p>Specification of the clustering method, which shall be used to cluster
the preferences estimated by the mixed logit model.
Defaults to "kmeans". Other options: "agglo", "meanshift", "dbscan".</p>
              </div>
            </li>
            <li>
              <b>scale_individual</b>
                  (<code>Boolean</code>)
              –
              <div class="doc-md-description">
                <p>If True, the x- and y-axis of the visualizations are scaled to one.
This eases the comparison of the different attributes. The scale
is indicates on the respective axes and is very important for
quantitative and qualitative interpretations. Defaults to False.</p>
              </div>
            </li>
            <li>
              <b>external_points</b>
                  (<code>array</code>)
              –
              <div class="doc-md-description">
                <p>This array holds further parameter points in the parameter space,
which should be visualized as reference points. E.g.: The initial
point, as being calculated by the multinomial logit model.</p>
              </div>
            </li>
            <li>
              <b>k</b>
                  (<code>int</code>)
              –
              <div class="doc-md-description">
                <p>Number of cluster centers to be calculated. Defaults to 3.</p>
              </div>
            </li>
            <li>
              <b>save_fig_path</b>
                  (<code>string</code>)
              –
              <div class="doc-md-description">
                <p>Path, which indicated the place where to store the visualization
as a .png-file.</p>
              </div>
            </li>
            <li>
              <b>name_scenario</b>
                  (<code>string</code>)
              –
              <div class="doc-md-description">
                <p>The scenario name can be added additionally, to distinguish
several scenarios.</p>
              </div>
            </li>
            <li>
              <b>bw_adjust</b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>This value adjusts the smoothing of the visualized preference
distribution. A higher value increases the smoothing of the
displayed curve, but may conceal certain findings in the distribution.
Defaults to 0.03.</p>
              </div>
            </li>
            <li>
              <b>names_choice_options</b>
                  (<code>dict</code>)
              –
              <div class="doc-md-description">
                <p>If given, this shall be a dictionary, which holds the
names of the choice options as values and the numerical
indication of the choice option (0,1,2,...) as keys.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
<b>res_clustering</b>(                <code>List</code>
)            –
            <div class="doc-md-description">
              <p>Clustering results are returned, if keyword return_res == True.</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
      <details class="quote">
        <summary>Source code in <code>mode_behave_public\post_analysis.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">visualize_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method visualizes the distribution of preferences across the</span>
<span class="sd">    base population for the randomized model attributes, which have been</span>
<span class="sd">    analyzed within the estimation of the mixed logit model.</span>
<span class="sd">    Furthermore, the estimated (mean) preferences from the multinomial</span>
<span class="sd">    logit model are displayed as reference points.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    return_res : Boolean, optional</span>
<span class="sd">        If True, the clustering results are returned. Defaults to False.</span>
<span class="sd">    return_figure : Boolean, optional</span>
<span class="sd">        If True, the rendered figure is returned. Defaults to False.</span>
<span class="sd">    cluster_method : string, optional</span>
<span class="sd">        Specification of the clustering method, which shall be used to cluster</span>
<span class="sd">        the preferences estimated by the mixed logit model.</span>
<span class="sd">        Defaults to &quot;kmeans&quot;. Other options: &quot;agglo&quot;, &quot;meanshift&quot;, &quot;dbscan&quot;.</span>
<span class="sd">    scale_individual : Boolean, optional</span>
<span class="sd">        If True, the x- and y-axis of the visualizations are scaled to one.</span>
<span class="sd">        This eases the comparison of the different attributes. The scale</span>
<span class="sd">        is indicates on the respective axes and is very important for</span>
<span class="sd">        quantitative and qualitative interpretations. Defaults to False.</span>
<span class="sd">    external_points : array, optional</span>
<span class="sd">        This array holds further parameter points in the parameter space,</span>
<span class="sd">        which should be visualized as reference points. E.g.: The initial</span>
<span class="sd">        point, as being calculated by the multinomial logit model.</span>
<span class="sd">    k : int, optional</span>
<span class="sd">        Number of cluster centers to be calculated. Defaults to 3.</span>
<span class="sd">    save_fig_path : string, optional</span>
<span class="sd">        Path, which indicated the place where to store the visualization</span>
<span class="sd">        as a .png-file.</span>
<span class="sd">    name_scenario : string, optional</span>
<span class="sd">        The scenario name can be added additionally, to distinguish</span>
<span class="sd">        several scenarios.</span>
<span class="sd">    bw_adjust : float, optional</span>
<span class="sd">        This value adjusts the smoothing of the visualized preference</span>
<span class="sd">        distribution. A higher value increases the smoothing of the</span>
<span class="sd">        displayed curve, but may conceal certain findings in the distribution.</span>
<span class="sd">        Defaults to 0.03.</span>
<span class="sd">    names_choice_options : dict, optional</span>
<span class="sd">        If given, this shall be a dictionary, which holds the</span>
<span class="sd">        names of the choice options as values and the numerical</span>
<span class="sd">        indication of the choice option (0,1,2,...) as keys.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    res_clustering : List</span>
<span class="sd">        Clustering results are returned, if keyword return_res == True.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;axes.facecolor&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)})</span>

    <span class="n">return_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return_res&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">return_figure</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return_figure&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">method_temp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cluster_method&quot;</span><span class="p">,</span> <span class="s2">&quot;kmeans&quot;</span><span class="p">)</span>
    <span class="n">names_choice_options</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;names_choice_options&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># PREPARE DATA</span>
    <span class="c1">#   step 0: Get row names (random variables)</span>
    <span class="n">names_constant_fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]</span>
    <span class="n">names_constant_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]</span>
    <span class="n">names_variable_fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;fixed&quot;</span><span class="p">]</span>
    <span class="n">names_variable_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]</span>
    <span class="n">number_random</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>
        <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
    <span class="p">)</span>
    <span class="n">number_variable_random</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>

    <span class="c1">#   step 1: Scale parameters</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_points</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shares</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="c1">#   get only points, above share-treshold.</span>
    <span class="n">shares</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">points_t</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">T</span>

    <span class="n">bw_adjust_temp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bw_adjust&quot;</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">)</span>

    <span class="n">scale_individual</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scale_individual&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scale_individual</span><span class="p">:</span>
        <span class="n">scale_log</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_random</span><span class="p">):</span>
            <span class="n">min_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points_t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">max_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points_t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">scale_temp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">min_temp</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_temp</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">scale_temp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">scale_log</span> <span class="o">+=</span> <span class="p">[</span><span class="n">scale_temp</span><span class="p">]</span>
                <span class="n">points_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">points_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale_temp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scale_log</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">points_scaled</span> <span class="o">=</span> <span class="n">points_t</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_random</span><span class="p">):</span>
            <span class="n">min_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points_t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">max_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points_t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">scale_temp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">min_temp</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_temp</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">scale_temp</span> <span class="o">&gt;</span> <span class="n">scale</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="n">scale_temp</span>
        <span class="n">points_t</span> <span class="o">=</span> <span class="n">points_t</span> <span class="o">/</span> <span class="n">scale</span>
        <span class="n">points_scaled</span> <span class="o">=</span> <span class="n">points_t</span><span class="o">.</span><span class="n">T</span>

    <span class="c1">#   Import points of socio-economic groups</span>
    <span class="n">external_points</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;external_points&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]))</span>
    <span class="n">k_cluster</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">external_points</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="c1"># get random points.</span>
        <span class="n">external_points_random</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">external_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">number_random</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">external_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names_constant_random</span><span class="p">)):</span>
                <span class="n">index_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_constant_fixed</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span>
                <span class="n">external_points_random</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">external_points</span><span class="p">[</span><span class="n">group</span><span class="p">][</span>
                    <span class="n">index_temp</span>
                <span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names_variable_random</span><span class="p">)):</span>
                    <span class="n">index_temp</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">count_c</span>
                        <span class="o">-</span> <span class="mi">1</span>
                        <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_constant_fixed</span><span class="p">)</span>
                        <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_constant_random</span><span class="p">)</span>
                        <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names_variable_fixed</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_variable_random</span><span class="p">))</span>
                        <span class="o">*</span> <span class="n">i</span>
                        <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_variable_fixed</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">v</span>
                    <span class="p">)</span>
                    <span class="n">external_points_random</span><span class="p">[</span><span class="n">group</span><span class="p">][</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">names_constant_random</span><span class="p">)</span>
                        <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_variable_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span>
                        <span class="o">+</span> <span class="n">v</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">external_points</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">index_temp</span><span class="p">]</span>

        <span class="c1"># Get cluster centers</span>
        <span class="n">k_group</span> <span class="o">=</span> <span class="n">external_points_random</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">res_clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_space</span><span class="p">(</span><span class="n">method_temp</span><span class="p">,</span> <span class="n">k_cluster</span><span class="p">)</span>

        <span class="c1"># scale these random points.</span>
        <span class="k">if</span> <span class="n">scale_individual</span><span class="p">:</span>
            <span class="n">external_points_random_t</span> <span class="o">=</span> <span class="n">external_points_random</span><span class="o">.</span><span class="n">T</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_random</span><span class="p">):</span>
                <span class="n">external_points_random_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">external_points_random_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale_log</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="n">external_points_random</span> <span class="o">=</span> <span class="n">external_points_random_t</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">external_points_random</span> <span class="o">=</span> <span class="n">external_points_random</span> <span class="o">/</span> <span class="n">scale</span>

        <span class="c1"># convert points to dict-format</span>
        <span class="n">count_random_variable</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vlines_loc_group</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">external_points_random_t</span> <span class="o">=</span> <span class="n">external_points_random</span><span class="o">.</span><span class="n">T</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])):</span>
            <span class="n">vlines_loc_group</span><span class="p">[</span><span class="n">names_constant_random</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">external_points_random_t</span><span class="p">[</span>
                <span class="n">count_random_variable</span>
            <span class="p">]</span>
            <span class="n">count_random_variable</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">names_choice_options</span><span class="p">):</span>
                    <span class="n">name_co</span> <span class="o">=</span> <span class="n">names_choice_options</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name_co</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

                <span class="n">vlines_loc_group</span><span class="p">[</span>
                    <span class="n">names_variable_random</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_co</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">external_points_random_t</span><span class="p">[</span><span class="n">count_random_variable</span><span class="p">]</span>
                <span class="n">count_random_variable</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No external reference points given.&quot;</span><span class="p">)</span>
        <span class="n">vlines_loc_group</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">k_group</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">res_clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_space</span><span class="p">(</span><span class="n">method_temp</span><span class="p">,</span> <span class="n">k_cluster</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method_temp</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;meanshift&quot;</span><span class="p">,</span> <span class="s2">&quot;dbscan&quot;</span><span class="p">):</span>
        <span class="n">k_cluster</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># step 2: Built dataframe</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">points_scaled</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
    <span class="n">attributes_temp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vlines_loc</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">vlines_len</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">scale_individual</span><span class="p">:</span>
        <span class="n">text_scale</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">cluster_center</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># scaling of cluster centers</span>
    <span class="k">if</span> <span class="n">scale_individual</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_random</span><span class="p">):</span>
            <span class="n">cluster_center</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_center</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale_log</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cluster_center</span> <span class="o">=</span> <span class="n">cluster_center</span> <span class="o">/</span> <span class="n">scale</span>
    <span class="c1"># weighted calculation of cluster sizes</span>
    <span class="n">cluster_labels_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="s2">&quot;weights&quot;</span><span class="p">])</span>
    <span class="n">cluster_labels_pd</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># assign weights</span>
    <span class="k">if</span> <span class="n">method_temp</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;agglo&quot;</span><span class="p">,</span> <span class="s2">&quot;meanshift&quot;</span><span class="p">):</span>
        <span class="n">index_clustered</span> <span class="o">=</span> <span class="n">res_clustering</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">cluster_labels_pd</span> <span class="o">=</span> <span class="n">cluster_labels_pd</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cluster_labels_pd</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">index_clustered</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cluster_labels_pd</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span>
    <span class="n">cluster_sizes_rel</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">cluster_labels_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cluster_labels_pd</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;weights&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_cluster</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># sort cluster_center and cluster_sizes_rel</span>
    <span class="n">cluster_sizes_rel_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">cluster_sizes_rel</span><span class="p">)</span>
    <span class="n">cluster_sizes_rel_pd</span> <span class="o">=</span> <span class="n">cluster_sizes_rel_pd</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">cluster_sizes_rel</span> <span class="o">=</span> <span class="n">cluster_sizes_rel_pd</span><span class="o">.</span><span class="n">values</span>
    <span class="n">cluster_sizes_rel_pd</span> <span class="o">=</span> <span class="n">cluster_sizes_rel_pd</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="c1"># reshuffle cluster_center</span>
    <span class="n">cluster_center</span> <span class="o">=</span> <span class="n">cluster_center</span><span class="o">.</span><span class="n">T</span><span class="p">[</span>
        <span class="n">cluster_sizes_rel_pd</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="p">]</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># create inputs for map of vlines and text_scale</span>
    <span class="n">count_random_variable</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])):</span>
        <span class="k">if</span> <span class="n">scale_individual</span><span class="p">:</span>
            <span class="n">text_scale</span><span class="p">[</span><span class="n">names_constant_random</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">scale_log</span><span class="p">[</span><span class="n">count_random_variable</span><span class="p">]</span>
        <span class="n">vlines_loc</span><span class="p">[</span><span class="n">names_constant_random</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cluster_center</span><span class="p">[</span><span class="n">count_random_variable</span><span class="p">]</span>
        <span class="n">vlines_len</span><span class="p">[</span><span class="n">names_constant_random</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cluster_sizes_rel</span>
        <span class="n">count_random_variable</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">attributes_temp</span> <span class="o">+=</span> <span class="p">[</span><span class="n">names_constant_random</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">shares</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])):</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">names_choice_options</span><span class="p">):</span>
                <span class="n">name_co</span> <span class="o">=</span> <span class="n">names_choice_options</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name_co</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">scale_individual</span><span class="p">:</span>
                <span class="n">text_scale</span><span class="p">[</span><span class="n">names_variable_random</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_co</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_log</span><span class="p">[</span>
                    <span class="n">count_random_variable</span>
                <span class="p">]</span>

            <span class="n">vlines_loc</span><span class="p">[</span><span class="n">names_variable_random</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_co</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_center</span><span class="p">[</span>
                <span class="n">count_random_variable</span>
            <span class="p">]</span>
            <span class="n">vlines_len</span><span class="p">[</span><span class="n">names_variable_random</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_co</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_sizes_rel</span>
            <span class="n">count_random_variable</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">attributes_temp</span> <span class="o">+=</span> <span class="p">[</span><span class="n">names_variable_random</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_co</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">shares</span>
            <span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attributes_temp</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
    <span class="n">weights_</span> <span class="o">=</span> <span class="n">shares</span>
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_random</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># for w in range(self.count_c-1):</span>
        <span class="n">weights_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights_</span><span class="p">,</span> <span class="n">shares</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights_</span>

    <span class="c1"># Initialize color palettes</span>
    <span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">cubehelix_palette</span><span class="p">(</span>
        <span class="n">n_colors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">2.35</span><span class="p">,</span> <span class="n">rot</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">light</span><span class="o">=</span><span class="mf">0.75</span>
    <span class="p">)</span>
    <span class="n">pal_group</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">cubehelix_palette</span><span class="p">(</span>
        <span class="n">n_colors</span><span class="o">=</span><span class="n">k_group</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rot</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">light</span><span class="o">=</span><span class="mf">0.65</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">pal_cluster_long</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;YlOrBr&quot;</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="n">k_cluster</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">pal_cluster</span> <span class="o">=</span> <span class="n">pal_cluster_long</span><span class="p">[(</span><span class="n">k_cluster</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># create kde-plots.</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="n">number_random</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">number_random</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_c</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">a_count</span><span class="p">,</span> <span class="n">attr_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">names_choice_options</span><span class="p">):</span>
                <span class="n">name_co</span> <span class="o">=</span> <span class="n">names_choice_options</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name_co</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">x_temp</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">attr_</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_co</span><span class="p">]</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
            <span class="p">)</span>
            <span class="n">weights_temp</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">attr_</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_co</span><span class="p">]</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">()[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">vis_col</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">number_variable_random</span> <span class="o">+</span> <span class="n">a_count</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">vis_col</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x_temp</span><span class="p">,</span>
                <span class="n">bw_adjust</span><span class="o">=</span><span class="n">bw_adjust_temp</span><span class="p">,</span>
                <span class="n">cut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">weights</span><span class="o">=</span><span class="n">weights_temp</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">pal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">vis_col</span><span class="p">],</span>
            <span class="p">)</span>

    <span class="c1"># Set the subplots to overlap</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="c1"># Remove axes details that don&#39;t play well with overlap</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Distribution of Preferences&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span>
        <span class="n">ax</span><span class="p">,</span>
        <span class="n">xticks</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span>
        <span class="n">xticklabels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Max. Negative Impact&quot;</span><span class="p">,</span> <span class="s2">&quot;No Impact&quot;</span><span class="p">,</span> <span class="s2">&quot;Max. Positive Impact&quot;</span><span class="p">],</span>
        <span class="n">yticks</span><span class="o">=</span><span class="p">[],</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">axis_no</span><span class="p">,</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
        <span class="c1"># set y-labels</span>
        <span class="n">label_modulus</span> <span class="o">=</span> <span class="n">axis_no</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>
        <span class="n">label_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">][</span><span class="n">label_modulus</span><span class="p">]</span>
        <span class="n">count_temp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">axis_no</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">count_temp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">names_choice_options</span><span class="p">):</span>
            <span class="n">col_name</span> <span class="o">=</span> <span class="n">label_temp</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">names_choice_options</span><span class="p">[</span><span class="n">count_temp</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">col_name</span> <span class="o">=</span> <span class="n">label_temp</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">count_temp</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">bbox_temp</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">dataLim</span><span class="o">.</span><span class="n">get_points</span><span class="p">()</span>
        <span class="n">y_max_temp</span> <span class="o">=</span> <span class="n">bbox_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_y_max</span> <span class="o">=</span> <span class="n">y_max_temp</span>

        <span class="n">scale_y</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">y_max_temp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=-</span><span class="mf">0.95</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span> <span class="o">*</span> <span class="n">y_max_temp</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="n">col_name</span><span class="p">,</span>
            <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
            <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># set vertical lines</span>
        <span class="n">vlines_loc_cluster</span> <span class="o">=</span> <span class="n">vlines_loc</span>
        <span class="n">vlines_loc_group</span> <span class="o">=</span> <span class="n">vlines_loc_group</span>
        <span class="n">k_cluster</span> <span class="o">=</span> <span class="n">k_cluster</span>
        <span class="n">k_group</span> <span class="o">=</span> <span class="n">k_group</span>
        <span class="k">if</span> <span class="n">scale_individual</span><span class="p">:</span>
            <span class="n">scale_temp</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">text_scale</span><span class="p">[</span><span class="n">col_name</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">label_text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;scale x: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">scale_temp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;scale y: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">scale_y</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
                <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="n">label_text</span><span class="p">,</span>
                <span class="n">fontstyle</span><span class="o">=</span><span class="s2">&quot;italic&quot;</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_cluster</span><span class="p">):</span>
            <span class="n">x_cluster</span> <span class="o">=</span> <span class="n">vlines_loc_cluster</span><span class="p">[</span><span class="n">col_name</span><span class="p">][</span><span class="n">cluster</span><span class="p">]</span>
            <span class="c1"># len_cluster = vlines_len_cluster[col_name][cluster]</span>
            <span class="n">len_cluster</span> <span class="o">=</span> <span class="mf">0.9</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x_cluster</span><span class="p">,</span>
                <span class="n">ymax</span><span class="o">=</span><span class="n">len_cluster</span><span class="p">,</span>
                <span class="n">c</span><span class="o">=</span><span class="n">pal_cluster</span><span class="p">[</span><span class="n">cluster</span><span class="p">],</span>
                <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_group</span><span class="p">):</span>
            <span class="n">x_group</span> <span class="o">=</span> <span class="n">vlines_loc_group</span><span class="p">[</span><span class="n">col_name</span><span class="p">][</span><span class="n">group</span><span class="p">]</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x_group</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">pal_group</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

        <span class="n">axis</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=-</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=-</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=-</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Create the legend patches for cluster</span>
    <span class="n">patch_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">names_choice_options</span><span class="p">):</span>
        <span class="n">name_co_0</span> <span class="o">=</span> <span class="n">names_choice_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name_co_0</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">col_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">][</span><span class="s2">&quot;random&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_co_0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_cluster</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vlines_len_temp</span> <span class="o">=</span> <span class="n">vlines_len</span>
        <span class="n">cluster_size_temp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">vlines_len</span><span class="p">[</span><span class="n">col_name</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">patch_dict</span><span class="p">[</span>
            <span class="s2">&quot;C&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster_size_temp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;%&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">pal_cluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">patches_c</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">patch_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

    <span class="c1"># create legends</span>
    <span class="n">legend1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
        <span class="n">handles</span><span class="o">=</span><span class="n">patches_c</span><span class="p">,</span>
        <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower center&quot;</span><span class="p">,</span>
        <span class="n">ncol</span><span class="o">=</span><span class="n">k_cluster</span><span class="p">,</span>
        <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">),</span>
        <span class="n">columnspacing</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Cluster: Size(%)&quot;</span><span class="p">,</span>
        <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># add legends</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">legend1</span><span class="p">)</span>

    <span class="n">save_fig_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_fig_path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATH_Visualize</span><span class="p">)</span>
    <span class="n">name_scenario</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name_scenario&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">name_scenario</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="n">save_fig_path</span> <span class="o">+</span> <span class="s2">&quot;preference_distribution_&quot;</span> <span class="o">+</span> <span class="n">name_scenario</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="n">save_fig_path</span> <span class="o">+</span> <span class="s2">&quot;preference_distribution.png&quot;</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">return_res</span> <span class="ow">and</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res_clustering</span><span class="p">,</span> <span class="n">fig</span>
    <span class="k">elif</span> <span class="n">return_res</span><span class="p">:</span>
        <span class="n">return_res</span>
    <span class="k">elif</span> <span class="n">return_figure</span><span class="p">:</span>
        <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../estimation_reference/" class="btn btn-neutral float-left" title="Estimation Module"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../simulation_reference/" class="btn btn-neutral float-right" title="Simulation Module">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../estimation_reference/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../simulation_reference/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
